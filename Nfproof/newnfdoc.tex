\documentclass[12pt]{article}

\title{A self contained account of a class of models of tangled type theory}

\author{Randall Holmes}

\date{starting, 7/13/2023\\
typos and mental failures fixed, 7/18/2023\\
revised during 7/24/2023 Zoom meeting\\definition of substitutions and their action rewritten, 7/25/2023\\
freedom of action {\em is} needed for type counting\\
8/2/2023:  some editing and debugging, progress in setting up last case of the freedom of action proof.\\
first pass 8/4/2023, a lot of proofreading.
8/9/23 more proofreading, more work on Freedom of Action\\
8/10/2023 first draft of entire proof of Freedom of Action\\
8/27/2023:  another editing pass, simplified indexing (and possibly removed errors) in FoA proof, other fixes in earlier parts\\
8/29/2023 changed the definition of support element and made induced corrections (I hope).  Some remarks added after the Zoom meeting.\\
9/7/2023 starting to tackle counting of types}

\usepackage{amssymb}

\begin{document}

\maketitle

\newpage

In this document, we give a self contained account of a structure which will turn out to be a model of tangled type theory, and therefore a witness to the consistency of Quine's New Foundations.
We will not discuss these theories until later in the narrative.  All of our business will be conducted in the usual set theory ZFC, and in fact in not very much of it, because New Foundations is not a very strong theory.

We are trying out the numbered paragraph format which Zermelo uses in his 1908 papers, just for fun.

\begin{enumerate}

\item The construction has parameters which we introduce.

$\lambda$ is a limit ordinal.  Elements of $\lambda$ and a special object $-1$ will be our type indices (it simply doesn't matter what $-1$ is:  any set that isn't an ordinal will do).  The order on type indices is suggested by the choice of symbol for the additional type index:  $-1$ is the minimum in the order on type indices and the order on type indices extends the usual order on $\lambda$ (the natural order on ordinals $<\lambda$).

$\kappa$ is an uncountable regular cardinal greater than $\lambda$.  Sets of cardinality $<\kappa$ will be termed {\em small\/} and sets which are not small are called {\em large\/}.

$\mu$ is a strong limit cardinal $>\kappa$ of cofinality $\geq \kappa$.

These notations are fixed for the rest of the paper.

\item  Motivational notes:  we are letting parameters vary in size to support extensions of NF which are strong in various ways.  If one were aiming to put a cap on the consistency strength of NF (doing this precisely is not among the aims of this paper) note that $\lambda = \omega; \kappa = \omega_1; \mu = \beth_{\omega_1}$ works here.  We believe that NF is even weaker than these values of the parameters suggest, but we are not at pains here to show this.

\item We first build a system of {\em supertypes\/} indexed by the type indices, which will seen to be a model of nonextensional tangled type theory (we will explain what this means presently).

We write the supertype indexed by a type index $\iota$ as $\tau^*_\iota$.

Supertype $-1$ ($\tau^*_{-1}$) is unspecified at this point, except that it is a set of cardinality $\mu$.  We will describe it with complete precision later, but its exact nature is unimportant at this stage.  Any choice of $\mu$ and a set of cardinality $\mu$ to serve as $\tau^*_{-1}$ can be taken to determine a system of supertypes at this point.

For $\alpha\in \lambda$ (a type index other than $-1$), we define $\tau^*_\alpha$ as $$({\cal P} (\bigcup_{-1 \leq \iota<\alpha} \tau^*_\iota \cup \{\{\tau^*_\eta:-1\leq \eta <\alpha\}\})) \setminus {\cal P} (\bigcup_{-1 \leq \iota<\alpha}\tau^*_\iota):$$

an element of $\tau^*_\alpha$ is a union of subsets of the $\tau^*_\iota$'s for $-1\leq \iota <\alpha$ with the additional element $\{\tau_\eta:-1\leq \eta <\lambda\}$ added.

We denote $\{\tau^*_\eta:-1\leq \eta <\alpha\}$ by $\tau^+_{\alpha}$.

\item The axiom of foundation in the underlying set theory ZFC ensures that the supertypes are disjoint.  Notice that $\tau^+_{\alpha}$ has higher rank than any $\tau^*_\iota$ for
$-1\leq \iota <\alpha$ and so $\tau^+_{\alpha}$ cannot be an element of any element of $\tau^*_\iota$ for $-1\leq \iota<\alpha$, and so $\tau^*_\alpha$ (all of whose elements contain $\tau^+_{\alpha}$)  is disjoint from every
such $\tau^*_\iota$ (every type of smaller index).

None of the sets $\tau^+_{\alpha}$ are elements of any $\tau^*_\iota$:  no  $\tau^+_{\alpha}$ can be an element of $\tau^*_{-1}$ because $\tau^*_{-1} \in \tau^+_{\alpha}$ for every
$\alpha$.  For $\tau^+_{\alpha}$ to belong to $\tau_\beta$ ($\beta \neq -1)$ we would need $\tau^+_{\beta}$ to belong to each element of $\tau^+_\alpha$, including
$\tau^*_{-1}$, to which we have just seen that no $\tau^+_{\alpha}$ can belong.

\item For each $\alpha,\beta$ with $-1\leq\alpha<\beta<\lambda$, we define $x \in_{\alpha,\beta} y$ as holding iff $x \in \tau^*_\alpha \wedge y \in \tau^*_\beta \wedge x \in y$.  It is a nice feature of this scheme of representation that membership
between any two types is represented by a subset of the membership relation of the metatheory, while at the same time the ``empty set" in each supertype, $\emptyset^\alpha = \{\tau^+_\alpha\}$, is distinct from the empty set in each other supertype (and more generally, the supertypes are disjoint, but the empty sets are the obvious obstruction to this).

This structure is a model for nonextensional tangled type theory (TTT$^-$) which we now describe briefly for motivation.

TTT$^-$ is a theory with membership and equality as primitive relations and types indexed by the elements of $\lambda$ (type indices other than $-1$).

A formula $x^\alpha = y^\beta$ is meaningful iff $\alpha=\beta$.  A formula $x^\alpha \in y^\beta$ is meaningful iff $\alpha<\beta$.

The sole axiom scheme asserts that for any formula $\phi(x^\alpha)$ in the language and $\beta>\alpha$ there is $\{x^\alpha:\phi(x^\alpha)\}^\beta$ such that
$$(\forall z^\alpha:z^\alpha \in \{x^\alpha:\phi(x^\alpha)\}^\beta \leftrightarrow \phi(z^\alpha)).$$

This theory is satisfied by the system of supertypes if we interpret $x^\alpha \in y^\beta$ as $x^\alpha \in_{\alpha,\beta} y^\beta$.

The theory is nonextensional:  there isn't a unique witness to serve as $\{x^\alpha:\phi(x^\alpha)\}^\beta$, though we can choose a canonical one, namely, the one whose intersection
with any $\tau_\iota$ with $\iota \neq \alpha$ is empty (this canonical object which a given $\alpha$-extension is easily described in terms of the metatheory, and can be described in terms of the language of tangled type theory, but the axioms of nonextensional tangled type theory establish neither existence nor uniqueness of such an object).

\item We further describe the theory TTT (tangled type theory), in order to motivate the exertions we will go through in the rest of this paper.

TTT extends TTT$^-$ with the additional axiom scheme of extensionality, the collection of all well formed sentences of the form $$(\forall x^\beta y^\beta:(\forall z^\alpha:z^\alpha \in x^\beta \leftrightarrow z^\alpha \in y^\beta)\rightarrow x^\beta=y^\beta).$$

It is known that the consistency of TTT implies (in fact is equivalent to) the consistency of New Foundations.  We will discuss this (and the definition of the theory New Foundations)  later.

\item In the system of supertypes, each element with positive type $\alpha$ has an extension over each type $\beta\in \alpha$, namely, its intersection with type $\beta$.  These extensions can be mixed and matched freely:  there are many type $\alpha$ objects with any given extension over type $\beta$ (even in the case $\beta=0, \alpha=1$, as we can vary the intersection of
the type $\alpha$ object with type $-1$).

 In a model of TTT, each object of positive type is uniquely determined by each of its extensions individually.  This means that one extension of any particular object determines the others.
Our construction continues by exhibiting how this is done in our construction, starting with a presentation of more detail about type $-1$.

\item We will refer to the elements of type $-1$ as {\em atoms\/}.  They are not atoms in the sense of the metatheory (in fact, we will say something about their extensions as sets in a moment) but it is convenient to have a generic term for them (and in earlier constructions carried out in ZFA, analogous objects were atoms).

\item We now specify exactly what $\tau^*_{-1}$ is (in terms of the parameters $\kappa$ and $\mu$).

$\tau^*_{-1}= \{(\nu,\beta,\gamma,\alpha):\nu<\mu \wedge  \beta \in \lambda\cup \{-1\} \wedge \gamma \in \lambda \setminus \{\beta\}\wedge \alpha<\kappa\}$

\item For any suitable $\nu, \beta, \gamma$ we define $\Lambda_{\nu,\beta,\gamma}$ as $\{(\nu,\beta,\gamma,\alpha)\in \tau^*_{-1}:\alpha<\kappa\}$.  We regard this notation as defined
only if the resulting set is nonempty.  Such sets are called {\em litters} and the set of litters is a partition of $\tau^*_{-1}$ into sets of cardinality $\kappa$.  I am not sure that I ever use the explicit notation $\Lambda_{\nu,\beta,\gamma}$ for a litter in the sequel.

We define $X_{\beta,\gamma}$ as \{$\Lambda_{\nu,\beta,\gamma}:\nu<\mu\}$.  The use of the partition of the litters $\{X_{\beta,\gamma}:\beta \in \lambda\cup \{-1\} \wedge \gamma \in \lambda \setminus \{\beta\}\}$ will be seen below.  The notation $X_{\beta,\gamma}$ is used in the sequel:  what is important to know about
the collection of such sets is that it is a partition of the set of all litters into sets of size $\mu$.

\item A subset of $\tau^*_{-1}$ with small symmetric difference from a litter we call a {\em near-litter\/}.  For any near-litter $N$ we define $N^\circ$ as the uniquely determined litter $L$
such that $|N \Delta L|<\kappa$.  If $M$ and $N$ are litters, we write $M \sim N$ [read ``$M$ is near $N$"] for $|M \Delta N| < \kappa$.  This is an equivalence relation on near-litters.

\item Our intention is to construct $\tau_\iota$ for each type index $\iota$ in such a way that $\tau_{-1} = \tau^*_{-1}$ (and we will henceforth abandon the latter notation, always writing $\tau_{-1}$)
and for each $\alpha \in \lambda$, $\tau_\alpha \subseteq \tau^*_\alpha$ and $|\tau_\alpha| = \mu$, and for each $-1 \leq \alpha < \beta <\lambda$ and $x \in \tau_\beta$,
$x \cap \tau^*_\alpha\subseteq \tau_\alpha$.   Further, for each $-1<\gamma<\beta<\lambda$ we
have for $x,y \in \tau_\beta$ that $x \cap \tau_\gamma = y \cap \tau_\gamma \rightarrow x=y$:  we have extensionality (in the strong form required to interpret TTT)  for the types indexed by ordinals.  There are of course further conditions to be unfolded as we proceed.

The intention is that for each $\beta \in \lambda$, $\tau_\beta$ will interpret type $\beta$ of TTT and that the intersection of the membership relation of the metatheory with $\tau_\gamma \times \tau_\beta$ will interpret the membership of type $\gamma$ objects in type $\beta$ objects when $0 \leq \gamma<\beta$.

\item Our strategy will be to fix an $\alpha\in \lambda$ and hypothesize that the sets $\tau_\beta$ have already been constructed for each $\beta<\alpha$ (satisfying these conditions [and others yet to be stated]), and then describe how $\tau_\alpha$ is to be constructed [supposing at all points that earlier $\tau_\beta$'s were constructed in the same way].   We suppose that we have already specified
a well-ordering $\leq_\beta$ with order type $\mu$ of each type $\tau_\beta$ with $-1\leq \beta <\alpha$ (special conditions on the choice of these well-orderings will be given later).   

\item For any near-litter $N$ and $\gamma\neq -1$, we define $N_\gamma$ as the unique element $x$  of $\tau_\gamma$ with $x \cap \tau_{-1} = N$.  We stipulate that there is one (for any $N$ and for $\gamma<\alpha$).  More generally, if
$X \subseteq \tau_{-1}$, $X_\gamma$ is the unique element $x$ of $\tau_\gamma$ with $x \cap \tau_{-1} = X$, if there is one.  We provide that $\emptyset_\gamma$ and $\{x\}_\gamma$ will exist
for $x \in \tau_{-1}$, $\gamma<\alpha$.

\item We define for each element $x$ of any $\tau_\beta$ the index $\iota_*(x)$
as the order type of the restriction of $\leq_\beta$ to $\{y \in \tau_\beta:y <_\beta x\}$.  Note that the domain of $\iota_*$ is the union of all the types!

\item We first indicate how extensionality is to be enforced.  

\item We construct, for each pair of ordinals $\beta,\gamma<\alpha$ with $\beta \neq \gamma\neq -1$ (note that $\beta$ can be $-1$),  an injection $f_{\beta,\gamma}$ from $\tau_\beta$ into $X_{\beta,\gamma} = \{\Lambda_{\nu,\beta,\gamma}:\nu<\mu\}$  (whose definition does not actually depend on $\alpha$:  it will be the same at every stage whose index dominates $\beta$ and $\gamma$).

 $f_{\beta,\gamma}$ is an injection from $\tau_\beta$ into $X_{\beta,\gamma}$:  note that the ranges of distinct $f_{\beta,\gamma}$'s are disjoint.
When we define $f_{\beta,\gamma}(x)$, we presume that we have already defined it for $y <_\beta x$.
We define $f_{\beta,\gamma}(x)$ as $L\cap \tau_{-1}$, where $L$ is $\leq _\gamma$-first such that $L\cap \tau_{-1} \in X_{\beta,\gamma}$ and for every $N \sim L \cap \tau_{-1}$, $\iota_*(N_\gamma)>\iota_*(x)$, and for any $y<_\beta x$, $f_{\beta,\gamma}(y) \neq L\cap \tau_{-1}$.  That this can be done relies on the fact that the order type of each $\leq_\beta$ is $\mu$.  It is important to note that the definition of $f_{\beta,\gamma}$ does not depend on $\alpha$; speaking informally, as $\alpha$ increases, more such functions become definable, but they remain the same functions.

\item Let $-1<\beta\leq \alpha$.


Let $\tau_\beta^1$ be the set of elements of $\tau_\beta^*$ satisfying $x \cap \tau^*_\gamma \subseteq \tau_\gamma$ for each $\gamma<\beta$.

Let $\tau_\beta^2$ be the set of elements of $\tau_\beta^1$ which are ``weakly extensional" in a sense we now define.

 An extension of an element $x$ of $\tau_\beta^1$ is a set $x \cap \tau_\gamma$ for $-1 \leq \gamma <\beta$ [we call this extension for a particular value of $\gamma$ the $\gamma$-extension].  We say that an element $x$ of  $\tau_\beta^1$ is {\em weakly extensional\/}
iff it has an extension $x \cap \tau_\gamma$, called a distinguished extension, which has the property that if any extension of $x$ is empty, all extensions (and so of course the distinguished extension), are empty,  and if $x \cap \tau_{-1}$ is nonempty, $\gamma = -1$, and that for any $\delta \in \beta \setminus \{-1,\gamma\}$ we have $$x \cap \tau_\delta = \{N_\delta:N^\circ \in f_{\gamma,\delta}``(x \cap \tau_\gamma)\}.$$

We pause to define a function implementing this.  For any nonempty subset $X$ of $\tau_\gamma$, we define $$A_\delta(X) =  \{N_\delta:N^\circ \in f_{\gamma,\delta}``(X)\}.$$

Note that this function $A_\delta$ can be taken to have the quite large domain $$\bigcup_{\gamma \in \beta \setminus \{\delta,-1\}} {\cal P}(\tau_\gamma) \setminus \{\emptyset\},$$ since we can determine given a set in the domain what the appropriate value of $\gamma$ is.
Strictly speaking, this should be written $A^{\beta}_{\delta}$.

We can then state that a distinguished extension $x \cap \tau_\gamma$ of $x$ is characterized by the condition that for each $\delta$ not equal to $\gamma$ or $-1$,
$x \cap \tau_\delta = A_\delta(x \cap \tau_\gamma)$, and if $\gamma \neq -1$, $x \cap \tau_{-1}$ is empty.

Note that this allows us immediately to determine all extensions of objects $N_\gamma$ for $N$ a near-litter or $\{x\}_\gamma$ for $x$ an atom, because their nonempty $-1$-extension is seen to be their distinguished extension.

It is part of the hypotheses of the construction that $\tau_\beta \subseteq \tau^2_\beta$ for each ordinal $\beta$ less than $\alpha$:  elements of types already constructed are weakly extensional.

\item We show that no $x$ has more than one distinguished extension.  If the distinguished extension of $x$ is empty, all extensions of $x$ are empty, so $x$ in fact has only one extension.  Note further that if the distinguished extension of $x$ is nonempty,
and $c$ is the element of this extension with minimal image under $\iota_*$, then every element of every other extension will have image under $\iota_*$ exceeding $\iota_*(c)$, because of the way the $f$ maps are constructed,  establishing that there is only one distinguished extension.

\item  That every element of a type in our system of types is weakly extensional will not enforce the extensionality condition we want.  Let $-1 \leq \gamma < \beta \leq \alpha$, and let
$x,y \in \tau^2_\beta$ with $x \cap \tau_\gamma = y \cap \tau_\gamma$.   

If $x \cap \tau_\gamma = y \cap \tau_\gamma$ is the empty set, then $x=y$ is immediate, because all the extensions of both sets are empty.  Note that if any extension
of $x$ or $y$ is empty, all are, so we can suppose hereinafter that all extensions of $x$ and $y$ are nonempty.

If the distinguished extensions of $x$ and $y$ are both the $\delta$-extension for some $\delta$ (which might or might not be $\gamma$), then again $x=y$ because we have a method of computation of all other extensions of $x$ and $y$ which will give $x \cap \tau_\epsilon = y \cap \tau_\epsilon$ for each appropriate $\epsilon$. 

If the distinguished extensions of $x$ and $y$ (supposed nonempty) are the $\delta$-extension of $x$ and the $\epsilon$-extension of $y$, with $\delta \neq \epsilon$, then any $z$ in the $\gamma$-extension of $x$ must be of the form $N_\gamma$ where $N^\circ$ is in the range of $f_{\delta,\gamma}$ and in the range of $f_{\epsilon,\gamma}$, and this is impossible, as the ranges of these maps are disjoint.

The possibility which cannot be excluded is that $x \cap \tau_\gamma = y \cap \tau_\gamma$ is the distinguished extension of one of $x,y$ and not of the other.

\item  Let $-1 < \beta \leq \alpha$.  We are working on defining the collection $\tau_\beta^3$ of {\em extensional\/} elements of $\tau^2_\beta$ (so to begin with,
an extensional element of $\tau^1_\beta$ is weakly extensional).

The maps $A_\delta$ defined above are injective.  The ranges of distinct maps $A_\delta$ are disjoint.  

Thus, we can define $A^{-1}(x)$ for $x \in \bigcup_{\gamma \in \beta\setminus \{-1\}} {\cal P} (\tau_\gamma) \setminus \{\emptyset\}$ as the unique $y$ such that $A_{\delta}(y)=x$ for some $\delta$ ($\delta$ of course being determined by $x$), if such a $y$ exists.  The map $A^{-1}$ is of course partial:  but for any $x$, if there is any such $y$ there is only one.

Strictly, we should define $A_{[\beta]}^{-1}(x)$ for $x \in \bigcup_{\gamma \in \beta\setminus \{-1\}} {\cal P} (\tau_\gamma) \setminus \{\emptyset\}$ as the unique $y$ such that $A^\beta_{\delta}(y)=x$ for some $\delta$ ($\delta$ of course being determined by $x$), if such a $y$ exists:  the explicit dependence on $\beta$ is not needed for the discussion here but might be relevant elsewhere.   The brackets are to avoid parsing it as $(A_\beta)^{-1}$.

If $c$ is the element of $x$ with minimal image under $\iota_*$, the element $d$ with minimal image under $\iota_*$ in any $A_\delta(x)$ will have $\iota_*(d) > \iota_*(c)$ because
of the way the $f$ maps are defined.  This implies that for any $x$, if $c$ is the element of $x$ with minimal image under $\iota_*$, and $A^{-1}(x)$ exists, then if
$d$ is the element of $A^{-1}(x)$ with minimal image under $\iota_*$, we have $\iota_*(d) < \iota_*(c)$.  This in turn implies that no set has infinitely many iterated images
under $A^{-1}$.

We then define $\tau^3_\beta$ as the collection of all elements $x$ of $\tau^2_\beta$ with the property that either the distinguished extension of $x$ is empty or the collection of iterated images of the distinguished extension of
$x$ under $A^{-1}$ (not including $x$) is of even cardinality.  Note that since every other extension of $x$ is an image of the distinguished extension under an $A_\delta$, they all have odd numbers of iterated images under $A^{-1}$.  

Now observe that in the case where two distinct elements $x,y$ of $\tau^2_\beta$ have the same $\gamma$-extension for a suitable $\gamma$, described above,
the common extension of $x$ and $y$ is the distinguished extension of one of them (wlog $x$) and not the distinguished extension of the other, and so the image under $A_\gamma$ of the distinguished extension of $y$.  This means that one of $x$ and $y$ is extensional, and the other is not, by considering the parities of the cardinalities of the sets of iterated images of the respective distinguished extensions under $A^{-1}$.  Thus,if  two distinct elements $x,y$ of $\tau^3_\beta$ have the same $\gamma$-extension for a suitable $\gamma$, it follows that $x=y$.

We further state that $\tau_\beta \subseteq \tau^3_\beta$ for $-1 < \beta < \alpha$ as a hypothesis of the construction:  all sets in types already constructed are extensional.

\item  We commence the description of the symmetry condition which tells us when an element of $\tau^3_\beta$ is to be taken to be an element of $\tau_\beta$.

\item  A typed near-litter is an element $N_\gamma$ of $\tau_\gamma$ where $N$ is a near-litter.  A typed atom is an element $\{x\}_\gamma$ of $\tau_\gamma$ where
$x \in \tau_{-1}$.

A {\em support element\/} is a pair $(x,A)$ where $A$ is a nonempty finite set of type indices other than $-1$ and $x$ is either a near-litter or
the singleton of an atom.

For any support element $(x,A)$ we define $c((x,A))$ as $x_{{\tt min}(A)}$:  $c$ converts support elements to typed near-litters or typed singletons of atoms.

We refer to support elements $(\{x\},A)$ as atomic support elements and to support elements $(N,A)$ where $N$ is a (near-)litter as (near-)litter support elements.

A {\em $\beta$-support\/} (for $\beta \in \lambda$) is a small set of support elements $(x,A)$ each of which has ${\tt max}(A)=\beta$, with the technical property that if it contains distinct $(x,A)$ and $(y,A)$ [with the same second component;  not all elements of a support need have the same second component], and $x$ and $y$ are both near-litters, they are disjoint.

{\bf NOTE:  I changed the definition of support element 8/29/2023 so that first components of support elements are in every case sets of atoms.
Under the previous definition, the atomic support element $(\{x\},A)$ would have been $(x,A\cup \{-1\})$ and the near-litter support element $(N,A)$ would have been $(N_\gamma,A)$, so
that first components were atoms or typed near-litters.  The new definition seems to lead to less annoying subscripting.  We describe the change here in case some text has not been revised correctly.}

For any $\beta$-support $S$ and $\gamma<\beta$, we define $S_\gamma$ as $$\{(x,A):{\tt max}(A)=\gamma \wedge (x,A\cup \{\beta\}) \in S\}.$$

\item  We now set out to define the symmetry condition which allows us to determine which elements of $\tau^3_\beta$ belong to $\tau_\beta$ for $\beta\leq \alpha$.

\item We define a $-1$-substitution as a permutation $\sigma$ of $\tau_{-1}$ such that for any near-litter $N$, $\sigma``N$ is a near-litter.

We define a $\beta$-presubstitution ($\beta\in \lambda$) as a permutation $\sigma$ of the atomic support elements $(x,A)$ with ${\tt max}(A)=\beta$, with the following properties:

\begin {enumerate}

\item $\pi_1(\sigma((x,A))) = A$ for all $(x,A)$ in the domain of $\sigma$.  This shows that $\sigma$ independently permutes, for each appropriate $A$, the set $\{(\{x\},A):x \in \tau_{-1}\}$.

\item For each appropriate $A$, the permutation $\sigma_{A\cup \{-1\}}$ implicitly defined by $\sigma((\{x\},A)) = (\{\sigma_{A\cup \{-1\}}(x)\},A)$ is a $-1$-substitution.

\end{enumerate}

For each $\beta$-presubstitution $\sigma$ and ordinal $\gamma<\beta$ we define $\sigma_\gamma$ as the $\gamma$-presubstitution such that $\sigma_\gamma((x,A)) = (y,A)$ (for $(x,A)$ in the known domain of a $\gamma$-presubstitution) iff $\sigma((x,A \cup \{\beta\})) = (y,A \cup \{\beta\})$.
We define $\sigma_{-1}(x)$ so that $\sigma((\{x\},\{\beta\})) = (\{\sigma_{-1}(x)\},\{\beta\})$.

We extend the notation of the previous paragraph.   For $B$ a finite set of type indices with maximum $\beta$, $\sigma_B$ is a ${\tt min}(B)$-presubstitution, with $\sigma_{\{\beta\}} = \sigma$ and $\sigma_B$ for $B$ with more than one element
equal to $(\sigma_{B \setminus \{{\tt min}(B)\}})_{{\tt min}(B)}$.  Notice that this has different definitions (though closely related) depending on whether ${\tt min}(B)=-1$.

\item  We define the action of a presubstitution on elements of our structure and on supports.  For any $x$ in $\tau_\beta$ and $\beta$-presubstitution $\sigma$ ($\beta>-1$), $\sigma[x]$ is the element of $\tau^*_\beta$ whose $\gamma$-extension is $\{\sigma_\gamma[y]:y \in x \cap \tau_\gamma\}$ for each type index $\gamma<\beta$.  In
the case $\gamma=-1$, $\sigma_{-1}[y] = \sigma_{-1}(y)$.

We define the action of a $\beta$-presubstitution $\sigma$ on support elements:  $\sigma[(x,A)] = (\sigma_{A \cup \{-1\}}``x,A)$.  Note that this agrees with simple application
of $\sigma$ as a function at elements of  its domain.

We define $\sigma[S]$, where $\sigma$ is a $\beta$-presubstitution and $S$ is a $\beta$-support, as $\{\sigma[s]:s \in S\}$.

\item  We now motivate and define the notion of $\beta$-substitution.

We would like to restrict to $\beta$-presubstitutions under which $\tau_\beta$ is closed.  Consider the action of a $\beta$-presubstitution on an element $X$ of $\tau_\beta$ whose $\gamma$-extension ($\gamma \neq -1$) is a singleton $\{x\}$.  We certainly want there to be such an element of $\tau_\beta$
for each $x \in \tau_\gamma$, since this would be true if our structure satisfied TTT, though we have not assumed this to be true [and we are not formally assuming this here, merely discussing this case for motivation].  The $\delta$-extension of $X$ for $\delta \in \beta \setminus \{\gamma,-1\}$ would be $\{N_\delta:N^\circ = f_{\gamma,\delta}(x)\}$.
The $\gamma$-extension of $\sigma[X]$ is $\{\sigma_\gamma[x]\}$ and the $\delta$-extension of $\sigma[X]$ is $\{\sigma_\delta[N_\delta]:N^\circ = f_{\gamma,\delta}(x)\}$.  

For $\sigma[X]$ to be extensional, we need the $\delta$-extension of $\sigma[X]$ to be $\{N_\delta:N^\circ = f_{\gamma,\delta}(\sigma_\gamma[x])\}$.

This motivates our definition of a $\beta$-substitution $(\beta>-1)$ as a $\beta$-presubstitution such that $$\{\sigma_\delta[N_\delta]:N^\circ = f_{\gamma,\delta}(x)\} = \{N_\delta:N^\circ = f_{\gamma,\delta}(\sigma_\gamma[x])\},$$ for each appropriate $\gamma, \delta,x$, which can readily be seen to be equivalent to the assertion that
$\sigma_\delta[f_{\gamma,\delta}(x)_\delta] \cap \tau_{-1} \sim  f_{\gamma,\delta}(\sigma_\gamma[x])$, for any appropriate $\gamma, \delta$ and $x \in \tau_\gamma$, or equivalently
$(\sigma_\delta)_{-1}``f_{\gamma,\delta}(x) \sim f_{\gamma,\delta}(\sigma_\gamma[x])$ for such $\gamma,\delta,x$.

We provide as a hypothesis of the construction that $\tau_\beta$ is closed under $\beta$-substitutions for each $\beta<\alpha$:  we claim that the additional condition which we have shown to be necessary for our purposes will also turn out to be sufficient when all details of the construction are seen.

\item We define the notion of a code for an element of our structure.  We use the notation $\chi$ for the function sending a code to what it codes.

A $-1$-code is simply an atom, and an atom is a code for itself and only for itself:  for any $x$, $\chi(x)=x$ if either $x$ or $\chi(x)$ is an atom.

A  $\beta$-code for $\beta$ an ordinal is a pair $(S,\Sigma)$ where $S$ is a $\beta$-support and, for some $\gamma<\beta$, $\Sigma$ is a set of $\gamma$-codes such that $\chi``\Sigma$ has an even number of iterated images (other than itself) under $A_{[\beta]}^{-1}$, and any $\beta$-substitution $\sigma$ such that $(\forall s \in S:\pi[s]=s)$ also
satisfies $\{\sigma_\gamma[y]:y \in \chi``\Sigma\} = \chi``\Sigma$, and for each code $c$ in $\Sigma$, $\pi_1(c)$ is a superset of $S_\gamma$.  In this case $\chi((S,\Sigma))$ is defined as the unique $x\in \tau_\beta$, if there is one, such that $x \cap \tau_\gamma = \chi``\Sigma$.

It is a hypothesis of the construction that for $\beta<\alpha$, the function $\chi$ is defined at every $\beta$-code, and that the range of $\chi$ is all of $\tau_\beta$:  i.e., the elements of $\tau_\beta$ are exactly the codable elements of $\tau^3_\beta$.

We define $\tau_\alpha$ as the collection of elements $x$ of $\tau^3_\alpha$ for which there is an $\alpha$-code $(S,\Sigma)$ and $\gamma<\alpha$ such that $x \cap \tau_\gamma = \chi``\Sigma$.

For any $\beta$-code $(S,\Sigma)$ and $\beta$-substitution $\sigma$, we define $\sigma[(S,\Sigma)]$ as $(\sigma[S],\{\sigma_\gamma[c]:c \in \Sigma\})$.  It  is straightforward to show that $\sigma[(S,\Sigma)]$ is a code for $\sigma[\chi((S,\Sigma))]$, so the action of a $\beta$-substitution on $\tau_\beta$ is a permutation.

We define $\sigma^+(x)$ as $\sigma[x]$ for each $\beta$-substitution $\sigma$ and $x \in \tau_\beta$.  Note that $\sigma^+$ determines and is determined by $\sigma$.  The collection of permutations $\sigma^+$  is the collection of {\em $\beta$-allowable permutations\/} discussed in other treatments;
we may have some use for this below.


\item We describe the selection of designated supports for each element of our structure (a support $S$ of an element $x$ of the structure is an $S$ for which there is a $\Sigma$ such that $(S,\Sigma)$ codes $x$).  This supports a recursive construction of designated codes.
The designated code for an atom is itself.  Otherwise the designated code for $x$ is the pair $(S,\Sigma)$ where $S$ is the designated support of $S$ and $\Sigma$ is the set of designated codes for elements of the distinguished extension of $x$.

We choose a preliminary designated support for each element of the structure (this is necessary because objects other than atoms which have codes clearly have more than one):  we are actually
choosing designated codes for elements of $\tau_\alpha$ and continuing to use codes already chosen for the earlier constructed types.

A refinement of this construction is to choose a preliminary designated support $S$ initially for just one element $x$ of each orbit in the action of substitutions, and then for each $y$ in the orbit of $x$ to choose a substitution $\sigma_{x,y}$ such that $\sigma_{x,y}[x]=y$ and let the designated support
for $y$ be $\sigma_{x,y}[S]$.  Something like this is done in the current Lean proof and I am thinking about whether there is a use for it here.  It would ensure a similarity in structure between designated supports of related objects.

We impose the technical condition that for each $\beta \leq \alpha$ and $x \in \tau_\beta$, if $x$ has the same $-1$-extension as an element $x'$  of $\tau_0$, and the designated support of $x'$ is $S$, the designated support of $x$ has as its members exactly the $(u,\{\beta\})$ such that $(u,\{0\}) \in S$.  It is straightforward to see that elements of $\tau_0$ are exactly the $X_0$ such that $X \subseteq \tau_{-1}$ has small symmetric difference from a small or co-small union of litters, that any element of $\tau_0$ has support elements of exactly the kinds described, and that an $x \in \tau_\beta$ with the same $-1$-extension as
an element of $\tau_0$ does have the described set as a support.

A support $S$ is said to be {\em strong\/} iff

\begin{enumerate}

\item for every $(N,A) \in S$, $N$ is a litter if it is a near-litter, and
\item  for every atomic support element $(\{x\},A)$ in $S$ there is $(N,A) \in S$ with $x \in N$ and $N$ a near-litter, and 

\item for every support element of the form $(f_{\delta,\epsilon}(x),A) \in S$ for which $\delta$ is dominated by every element of $A$ except $\epsilon$ we also have for each $(y,C)$ in the preliminary designated support
of $x$ that $$(y,(B \setminus \{\epsilon\})\cup C)\in S.$$

\end{enumerate}  It should be evident that any support can be modified to one satisfying the first condition by replacing each near-litter support element
$(N,A)$ with the nearby litter support element $(N^\circ,A)$ and the atomic support elements  $(\{x\},A)$ such that $x \in N \Delta N^\circ$:  modifying the first component of a code
in this way will preserve acceptability of the code, because any substitution whose action preserves the modified code also preserves the original code.

A code thus modified can be extended to a strong support satisfying the other two conditions simply by enforcing these closure conditions through $\omega$ steps.  The designated support  of each object is obtained as the  smallest strong support including the version of the designated support whose typed near-litter elements are typed litters  as a subset.

We refer to support elements of the form $(f_{\delta,\epsilon}(x),A)$ for which $\delta$ is dominated by every element of $A$ except $\epsilon$ as {\em inflexible\/} support elements [because the coherence conditions restrict how substitutions can act on them], and refer to all other near-litter support elements as {\em flexible\/} support elements.

\item Specific elements of $\tau_\alpha$'s whose existence was postulated above need to be shown to be codable.  $\emptyset_\gamma$ is coded by $(\emptyset,\emptyset)$.  If $x$ is an atom, $\{x\}_\gamma$ is coded by $(\{(x,\{\gamma\})\},\{x\})$.  If $N$ is a near-litter,
$N_\gamma$ is coded by $(\{(N,\{\gamma\}),N\}$.

\item  We describe the construction of the well-orderings $\leq_\iota$ in detail.

We first construct an order $\leq_0$  on $\tau_0$.  We choose an arbitrary order on elements of $\tau_0$ and proceed in alternating stages indexed by $\mu$:  at an even stage, we place the first so far unplaced litter, then place all atoms in it in an arbitrarily chosen order, then place all near-litters with small symmetric difference from a litter placed earlier and with all elements of the symmetric difference already placed.  At an odd stage, we place the first element of $\tau_0$ which is not a typed atom or near-litter and whose designated support contains no support item whose image under the conversion function has not already been placed, if there is one.  It should be evident that all elements of $\tau_0$ are eventually placed.  Of course this is constructed
at stage 0, and the same order is used again in each subsequent stage.

The order $\leq_{-1}$
is induced by the order on typed atoms in $\tau_0$ which is a suborder of $\leq_0$.



We describe how to construct all $\leq_\beta$ for $0<\beta \leq \alpha$.  We collect the extensional type $\beta$ sets which are codable and designate a code for each one (axiom of choice) and convert the included support to a strong support as described above. We place the typed atoms and near-litters  in $\leq_\beta$ in the same positions at which the typed atoms and near-litters with the same $-1$-extensions are placed in
$\leq_0$ (we described this above).  We provide ourselves with an arbitrary well-ordering of the other sets in type $\beta$ of order type $\mu$ [the same arbitrary order being used at every stage for a given $\beta$, so we get the same $\leq_\beta$ at each stage with index $\geq\beta$].  At each step, we go to the first unfilled position $\eta$ and place in it the first item in the arbitrary order on $\tau_\beta$ which has no element $s$ of its designated support such that $\iota_*(c(s))\geq \eta$ and which also has the property that
if it has the same $-1$-extension as an element $u$ of $\tau_0$ we have $\iota_*(u) \leq \eta$.  This last condition ensures that every position can actually be filled, because the item at the same position in $<_0$ will always be a candidate [this is also supported by the special condition on designated supports of items with $-1$-extensions agreeing with the $-1$-extension of an element of $\tau_0$].  Every item will eventually be placed because the cofinality of $\mu$ is at least $\kappa$ and supports are small.

\item All that is needed to ensure that this works is the assurance that there are no more than $\mu$ codes, which ensures that there are exactly $\mu$ elements of each type.

\item  There are exactly $\mu$ near-litters (this depends on the fact that $\mu$ is of cardinality at least $\kappa$) and there are exactly $\mu$ supports.

Note that it is evident that there are at least $\mu$ elements in any $\tau_\beta$ (consider typed atoms).

We will need to prove a theorem about the freedom of action of substitutions first.

\item Our criterion for acceptability of codes enforces a high degree of symmetry, assuming that substitutions act fairly freely on our structure.  We state a theorem about this.

A {\em $\beta$-partial substitution\/} is an injective map $\sigma$ from $\beta$-support items to $\beta$-support items with domain and range the same, satisfying $\pi_2(\sigma(x,A)) = A$, mapping atomic support elements to atomic support elements, satisfying for each litter $L$ and each appropriate $A$ that the set $$\{x: x \in L \wedge (\{x\},A) \in {\tt dom}(\sigma)\}$$ is small, and satisfying that each near-litter support element $(N,A)$
in the domain of $\sigma$ has $N$ a litter and is flexible.  Recall that this means that $N=N^\circ$ is not in the range of $f_{\gamma,\delta}$ for any $\gamma$ dominated by all elements of $A \setminus \{\delta\}$.

We define $(N_\delta)^\circ$ as $(N^\circ)_\delta$ for any near-litter $N$ to facilitate the following definition.

 We say that an atomic support element $(\{x\},A)$ is an {\em exception\/} of a substitution $\sigma$ iff it satisfies the following condition:
let $L$ be the litter containing $x$; either $\sigma_{A \cup \{-1\}}[x] \not\in \sigma_A[L_{{\tt min}(A)}]^\circ$ or $\sigma^{-1}_{A \cup \{-1\}}[x] \not\in \sigma^{-1}_A[L_{{\tt min}(A)}]^\circ$

The Freedom of Action theorem asserts that for each partial substitution $\sigma_0$  there is a substitution $\sigma$ which extends it in the qualified sense that $\sigma((x,A)) =\sigma_0((x,A))$ where the latter is defined and $x$ is a singleton, and $\pi_1(\sigma[(N,A)])^\circ = \pi_1(\sigma_0((N,A))$ where $N$ is a near-litter and the latter is defined, and further $\sigma$ has no exceptions other than elements of its domain.

\item  Let $\sigma_0$ be a $\beta$-partial substitution.  We describe a method of computing a $\beta$-substitution $\sigma$ whose action extends $\sigma_0$.

We first extend $\sigma_0$ so that its domain includes all $(L,A)$ which are flexible with $L$ a litter.  This can be done by extending $\sigma_0$ to act as the identity on all such items originally not in its domain, but all that is really necessary is that the extended map be one-to-one and onto on such items, fixing second components.  We use $\sigma_0$ hereinafter to refer to this extended partial substitution.

For any co-small subsets of litters $L,M$ we define $\sigma_{L,M}$ as the unique bijection from $L$ to $M$ which is strictly increasing in the order determined by fourth projections of the elements of each set.  The details of definition of $\sigma_{L,M}$ play no role in the proof: all that matters is that it is a bijection from $L$ to $M$.

We define $D_A$ as $\{x:x \in \tau_{-1} \wedge (\{x\},A) \in {\tt dom}(\sigma_0)\}$.

We extend the definition of $\iota_*$ to support elements by defining $\iota_*((x,A))$ as $\iota_*(c((x,A)))$.

We show how to compute the action of $\sigma$ at each support item, assuming that we have computed its action for all support items with smaller image under $\iota_*$ as just extended.

For any $(\{x\},A)$ atomic with $\gamma={\tt min}(A)$, we know that where $L$ is the litter containing $x$, $\iota_*(L_\gamma)<\iota_*(\{x\}_\gamma)$, so $$\iota_*((x,A))<\iota_*((L,A )),$$ so $\sigma[(L,A)]$ has already been computed.  We compute $\sigma(\{(x\},A))$ as either $\sigma_0((\{x\},A))$ or $(\sigma_{L\setminus D_A,\pi_1(\sigma[(L,A)])^\circ\setminus D_A}(x),A)$.

For any $(N,A)$ where $N$ is a near-litter which is not a litter, we have $\iota_*(N^\circ,A) = \iota_*(N^\circ_\gamma)<\iota_*(N_\gamma))$ and $\iota_*((\{x\},A)) = \iota_*(\{x\}_\gamma)<\iota_*(N_\gamma)$ for each $x \in N \Delta N^\circ$, which obviously gives us enough information to compute the action of $\sigma$ on $(N,A)$,
since we know the actions on $(N^\circ,A)$ and each $(\{x\},A)$ with $x \in N \Delta N^\circ$.

It remains to indicate how to compute the action of $\sigma$ on $(L,A)$ where $L$ is a litter.

We indicate how to compute $\pi_1(\sigma((\{x\},A))$ for each $x \in L$ if we know how to compute $\pi_1(\sigma[(L,A)])^\circ$.  If $x \in D_{A} \cap L$, we compute  $$\pi_1(\sigma((\{x\},A ))= \pi_1(\sigma_0((\{x\},A)).$$  


We define $S_{A,L}$ as $$\{x \in \pi_1(\sigma[(L,A)]))^\circ: (\exists y \in D_A \setminus L: \pi_1(\sigma_0((\{y\},A)) =\{x\})\}.$$

$S_{A,L}$ is (speaking a bit informally) the set of things in the target litter which are images (according to the partial substitution) of things not in the source litter, relative to the index $A$.


For each $x \in L \setminus D_{A}$, we compute $\sigma((\{x\},A)$ as $$(\{\sigma_{L \setminus D_{A},\pi_1(\sigma[(L,A)])^\circ \setminus S_{A,L}}(x)\},A).$$

We have thus indicated how to compute $$\sigma[(L,A)] = (\bigcup \{\pi_1(\sigma((\{x\},A)):x \in L\},A).$$

This handles the case where $(L,A)$ is flexible immediately, because we can compute $\pi_1(\sigma[(L,A)])^\circ$ as $\pi_1(\sigma_0(L,A))$.

\item The remaining case (which is sufficiently elaborate to get its own paragraph)  is to compute $\sigma[(L,A)]$ in the case where $L = f_{\delta,\gamma}(x)$ for some $\delta$ dominated by all members of $A \setminus \{\gamma\}$.

We do some calculations.  

$\sigma[( f_{\delta,\gamma}(x),A)] = (\sigma_{A\cup \{-1\}}`` f_{\delta,\gamma}(x),A)$ follows from the definition of set-subscripted substitutions.

That $\sigma_{A\cup \{-1\}}`` f_{\delta,\gamma}(x) \sim f_{\delta,\gamma}(\sigma_{A\setminus \{\gamma\}\cup \{\delta\}}[x])$ follows from the coherence condition on substitutions.

From this it follows that we can compute the value of $\pi_1(\sigma[L_\gamma,A)])^\circ = \pi_1( \sigma((f_{\delta,\gamma}(x),A)))^\circ = (\sigma_{A\cup \{-1\}}``(f_{\delta,\gamma}(x)))^\circ$ if we can compute $f_{\delta,\gamma}(\sigma_{A \setminus \{\gamma\}\cup \{\delta\}}[x])$,
for which it is sufficient to compute $\sigma_{A \setminus \{\gamma\}\cup \{\delta\}}[x]$.

Let $T$ be the designated $\delta$-support of $x$.

For any $\eta$-support $S$ and finite subset $D$ of $\lambda$ whose smallest element is $\eta$, define $S^D$ as $\{(u,B \cup D):(u,B) \in S\}$.  Notice that this will be a ${\tt max}(D)$-support.

Our strategy is to use the Freedom of Action theorem (on the inductive hypothesis that it works for lower type indices than $\beta$) to construct a $\delta$-substitution $\sigma'$ which must send $x$ to $\sigma(x)$ if $\sigma$ exists (completing the proof that $\sigma$ actually does exist).

We do this by specifying the action of $\sigma'$ on $T$, then justifying the existence of $\sigma'$ using the Freedom of Action theorem for $\delta$-partial substitutions.  By inductive hypothesis, we have already computed the action of $\sigma$ on every support item in $T^{A\setminus \{\gamma\}\cup \{\delta\}}$.
We define a $\delta$-partial substitution $\sigma'_0$ which is to map $(u,B) \in T$ to $(\pi_1(\sigma[(u,B \cup (A \setminus \{\gamma\})]),B)$ when $(u,B)$ is either atomic or flexible.  This does not give a complete definition because we must fill in orbits as the domain
of $\sigma'_0$ should be the same as its range.  Each atom has its orbit filled in in such a way that the intended action of $\sigma'$ or of the inverse of $\sigma'$ on any atom will not create any exceptions of $\sigma'$:  if $(\{v\},C)$ is added to the domain, and $L$ is the litter to which $v$ belongs,
if $(L,C\cup (A \setminus \{\gamma\})))$ is sent to $(M,C \cup (A \setminus \{\gamma\}))$ by the action of $\sigma$ (resp. $\sigma^{-1}$) defined so far then $(\{v\},C)$ will be sent by $\sigma'_0$ (resp.$ (\sigma'_0)^{-1}$) to some $(\{w\},C)$ with $w \in M^\circ$.  The fact that we have only countably many choices to make
for each of a small collection of atomic support elements in $T$ ensures that we can do this.  Each flexible item has its orbit filled in a way which is compatible with the known action of $\sigma$ on items with smaller image under $\iota_*$ (which clearly presents no difficulties).

By the Freedom of Action theorem for the lower index $\delta$, there is a $\delta$-substitution $\sigma'$ which extends $\sigma'_0$ in the proper sense and has no exceptions not in the domain of $\sigma'_0$.  We claim that $\sigma'[x]$ is the value we should compute for $\sigma_{A \setminus \{\gamma\}\cup \{\delta\}}[x]$.
The basis for this claim is the further claim that the action of $\sigma'$ on $T$ is the same as the action of $\sigma_{A\setminus \{\gamma\}\cup \{\delta\}}$ on $T$.  We have constructed $\sigma'$ to make the actions agree on all atomic and flexible elements of $T$:  we need to argue that the action of $\sigma'$ on $T$ must agree with the action of $\sigma_{A \setminus \{\gamma\}\cup \{\delta\}}$ at any inflexible near-litter support element in $T$.  If the two actions disagree on any such support element, there must be a first one on which they disagree in our well ordering of support elements.  It must be a near-litter support element, and inflexible, and so a litter support element of the form $(f_{\eta,\chi}(u)),C)$.

Let $U$ be the designated $\eta$-support of $u$.  The action of $\sigma'$ on $U^{C \setminus \{\chi\} \cup \{\eta\}}$ is the same as the action of $\sigma_{A \setminus \{\gamma\}\cup \{\delta\}}$ on $U^{C \setminus \{\chi\} \cup \{\eta\}}$ because all elements of this support appear in $T$ before $(f_{\eta,\chi}(u)),C)$.  It follows
that $\pi_1(\sigma'[(f_{\eta,\chi}(u)),C)])$ has small symmetric difference from $$\pi_1(\sigma_{A \setminus \{\gamma\}\cup \{\delta\}}[(f_{\eta,\chi}(u)),C)]).$$  If $v$ belonged to this symmetric difference, $(\{v\},C)$ must be an exception of one of the two maps.   But any exception of either map is an element of the domain
of the partial substitution from which that map is computed, and the two partial substitutions must agree at such elements at least to the extent that they are mapped to and from elements whose first projections are included in the same litter.  So the symmetric difference must in fact be empty, and we are able to exactly determine the value which must be assigned.

This completes the proof of the Freedom of Action Theorem:  all computations can be carried out, and if they can be carried out, they must terminate with a $\sigma$ with the desired properties.

The history of the Lean proof suggests that I should be very careful in pointing out why the function $\sigma$ obtained actually is a $\beta$-substitution.  It is important to notice that as soon as a litter support element $(L,A)$ has its image computed up to nearness, any $(\{x\},A)$ with $x \in L$ can be handled, and moreover every such item then has a unique image and preimage computable.  The method by which the calculation of the action at inflexible litters is performed ensures that the coherence condition is satisfied.
If there were a failure of injectivity (two atomic support conditions mapped to the same atomic support condition) one would have to have two distinct litters mapped to near-litters close to each other (there will clearly not be a failure of injectivity involving atoms in the same litter).  This clearly cannot happen for two flexible litters, or for a flexible litter and an inflexible litter.
If it happened for two inflexible litters, this would imply a failure of injectivity at a lower type, contrary to induction hypotheses.  If there is a failure of surjectivity for an atom, the entire litter in which it resided would have to be missed.  This cannot happen for a flexible litter, and it can only happen for an inflexible litter if there is a failure of surjectivity at a lower type, contrary to induction hypotheses.

\item  We now argue that the size of each type is $\mu$, which completes the demonstration that the construction is possible (the construction of the $f$ maps requires this).

\item  There are $\mu$ near-litters (this depends on the fact that the cofinality of $\mu$ is at least $\kappa$).  It follows from this that there are $\mu$ supports.

\item  Each type contains at least $\mu$ elements:  type $-1$ is explicitly described with $\mu$ elements, and each type with ordinal index $<\alpha$, if successfully constructed, contains $\mu$ typed singletons (as many as there are elements of type $-1$).
So what we need to show is that the cardinality of each type is $\leq \mu$.

We can show this if we can show that there are $<\mu$ codes.

\item  For each object $x$ we can define a designated code $(S,\Sigma)$ where $S$ is the designated strong support for $x$ and $\Sigma$ contains {\em all\/} codes for elements of the distinguished extension of $x$ which satisfy the requirement on support components for elements of $\Sigma$ in the definition of codes.

We can then say that a designated code for $x$ in $\tau_\beta$ with distinguished extension a subset of $\tau_\gamma$ is determined by the choice of a support $S$ (there are $\mu$ of these) and a collection of orbits in $\tau_\gamma$ under the group of $\gamma$-substitutions $\sigma_\gamma$  for 
$\sigma$ a $\beta$-substitution fixing  $S$, because the set $\chi``\Sigma$ must be a union of such orbits.

From this it follows that to prove our result, it is sufficient to show that for any $\beta$-support $S$, the collection of orbits in the action of substitutions $\sigma_\gamma$ on $\tau_\gamma$ for $\sigma$ whose action fixes $S$ is of cardinality $<\mu$.  It would folllow that there are $<\mu$ collections of such orbits, because $\mu$ is strong limit, and it would then follow that the cardinality of $\tau_\beta$ is $\leq \mu$.

\item  The definition of the class of substitutions to be counted seems too baroque.  Substitutions which fix $S_\gamma$ would be easier to work with.  Is it in fact the case that any $\gamma$-substitution which fixes $S_\gamma$ is $\sigma_\gamma$ for some
$\beta$-substitution $\sigma$ whose action fixes $S$?  Or, are the associated orbits the same?  If $\rho$ is a $\gamma$-substitution fixing $S_\gamma$, and $\rho[x]=y$, can we find a $\beta$-substitution $\sigma$ whose action fixes $S$ such that
$\sigma_\gamma[x]=y$?  I believe this does follow by Freedom of Action, and would imply that the orbits under the elaborately defined class of permutations described above are simply the orbits under substitutions whose action fixes $S_\gamma$,

The proof goes as follows.  Let $T$ be a $\gamma$-support of $x$ extending $S_\gamma$.  Define a partial substitution using the values of $\rho$ at atomc and flexible elements of $T$, then lift types to $\beta$ and extend the partial substitution to fix the atomic and flexible elements of $S$ which are not already handled.  A substitution $\sigma$ extending this partial substitution will act correctly at inflexible elements of the type lifted suppport for the usual reasons involving exceptions.  That $\sigma[S]=S$ is evident and that $\sigma_\gamma[x]=\rho[x]$, from the construction.

This needs to be written out in full.

\item Thus the lemma to be proved is simplified:  it suffices to prove that the collection of orbits in $\tau_\gamma$ under substitutions whose actions fix a given $\gamma$-support is of cardinality $<\mu$.  This is clearly true for $\gamma=0$.  In general, it is true
that there are $<\mu$ objects whose distinguished extension is their $-1$-extension in any type.

Let $S$ be a $\gamma$-support.

To choose an orbit in $\tau_\gamma$ under substitutions whose action fixes $S$ can be effected by 

\begin{enumerate}

\item first choosing $\delta<\gamma$, \

\item then choosing an orbit in the $\delta$-supports under the action of permutations $\sigma_\delta$ where $\sigma$ fixes $S$, 

\item then choosing any element $T$ of this orbit
an $\epsilon<\delta$ (it doesnt matter which one) and a collection of orbits in $\tau_\delta$ under the action of $\sigma_\epsilon$'s for which the action of $\sigma$ fixes $T$.

\end{enumerate}

There are obviously $<\mu$ choices at stage 1.

There are less than $\mu$ choices at stage 3 by the inductive hypothesis that the result to be proved holds at stages $<\gamma$.

It remains to examine stage 2.  We are going to choose not merely an orbit in supports, but an orbit in well-ordered supports which respect dependency in a suitable sense (to be elaborated, familiar from earlier treatments).  If there are few orbits in these more elaborate structures,
there are few orbits in the supports themselves.  We go through $<\kappa$ stages:  as we commence stage $\eta$ we have chosen all elements of an element of the desired orbit with index $<\eta$.  We then need to choose an orbit in possible next items in the support under
permutations whose actions fix all previous items.  The item will be of the form $(x,A)$ where $A$ is a suitable subset of $\lambda$ and $x$ is either an atom or a near-litter.  Choose $A$ and choose whether the item is an atom or near-litter (this represents far less than $\mu$ choices).
We then need to select an orbit in atoms or near-litters under permutations $\sigma_A$ where the action of $\sigma$ fixes all support elements chosen so far.






\end{enumerate}


\end{document}

