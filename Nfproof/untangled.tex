\documentclass[112pt]{article}

\usepackage{amssymb}

\usepackage{comment}

\title{New Foundations is consistent}

\author{M. Randall Holmes}

\begin{document}

\maketitle

\tableofcontents

\newpage

% \begin{comment}

\newpage

\section{Remarks on this version}

This document is probably my best overall version so far.  The immediate occasion for its preparation is to serve students attempting to verify the proof in Lean.  As we have discussed, the formal verification should at least initially avoid metamathematics, so it is the fact that the structure defined in section 3 is a model of TTT which should be verified, and further, a finite axiomatization (mod type indexing) of TST and thus TTT should be verified in the model in lieu of the usual statement of the axiom of comprehension of TTT.

\subsection{Version updates}

\begin{description}

\item[6/7/2022:]  Major improvements in the treatment of strong supports.  Removed the third components from items in supports and imposed a technical condition on the designated well-orderings of each type.  {\bf Significant changes which will require some adjustments of the blueprint} (I do not think extensive ones).  Later on 6/7, corrected some howlers about litters vs near-litters in the new material.  5 pm 6/7, more editing.

\item[6/6/2022:]  Added a section on tangled webs of cardinals for reference.  Removed an unnecessary clause from the definition of support (which will require a modification of the blueprint).

\item[6/5/2022:  3:30 pm Cambridge:]  An editing pass through the whole document.  I think that if we get to the induction proofs in section 4 which work along strong supports, there will need to be special notes written for each proof.

\item[6/5/2022, 11:11 am Cambridge:]  Minor fixes here and there in the adjusted text from last time;  some clarification of text in the proof of freedom of action.

\item[6/4/2022, afternoon Cambridge time:]  Explicitly described the procedures for extending supports to strong supports.  Second posting repairing some glitches in the evening.

\item[6/3/2022, 3 pm Cambridge time:]  Major revisions to the presentation of the model and its verification inspired by approaches taken in the blueprint.  No essential mathematical changes;  one modification is that supports are now well-orderings of triples from the outset, as in the blueprint.

\item[5/29/2022, morning:]  Considering backward action of the blueprint on the paper.  Introduced the concrete definition of type $-1$ and rephrased things much as in the blueprint.

\item[5/25/2022, afternoon:]  Accidentally left out the fact $\mu>\kappa$.

\item[5/23/2022, early afternoon:]  Further copy editing;  no mathematical changes.

\item[5/23/2022, morning:]  Fixes error in construction of $f$ maps.

\item[5/22/2022, evening:]  Fixes a typo, adds remarks motivated by our conversations on Saturday.

\item[5/21/2022, morning:]  This version has some upgrades to organization and appearance which are part of preparation for its submission as a Paper.  These should generally help students in the Lean project, too.

\item[5/18/2022, 9 am Boise time:]  corrected a typo pairs to triples in definition of structured supports;  changed cofinality requirement for
$\mu$ to cofinality $>\kappa$ instead of $\geq \kappa$.

\item[5/18/2022, 9:30 am Boise time:]  corrected definition of $A_\gamma$;  left out a necessary application of set union.  I suspect Lean would have noticed a mistake there.

\item[5/18/2022, 9:31 am Boise time:]  changed cofinality back to $\leq \kappa$:  inserting some discussion.

\end{description}

% \end{comment}

\section{Development of relevant theories}

\subsection{The simple theory of types TST and TSTU}

We introduce a theory which we call the simple typed theory of sets or TST, a name favored by the school of Belgian logicians who studied NF ({\em th\'eorie simple des types}).  This is not the same as the simple type theory of Ramsey and it is most certainly not Russell's type theory  (see historical remarks below).

TST is a first order multi-sorted theory with sorts (types) indexed by the nonnegative integers.  The primitive predicates of TST are equality and membership.

The type of a variable $x$ is written ${\tt type}($`$x$'$)$:  this will be a nonnegative integer.   A countably infinite supply of variables of each type is supposed.  An atomic equality sentence `$x=y$' is well-formed iff ${\tt type}($`$x$'$)={\tt type}($`$y$'$)$.
An atomic membership sentence `$x \in y$' is well-formed iff ${\tt type}$`$(x$'$)+1 = {\tt type}($`$y$'$)$.

The axioms of TST are extensionality axioms and comprehension axioms.

The extensionality axioms are all the well-formed assertions of the shape $(\forall xy:x=y \leftrightarrow (\forall z:z \in x \leftrightarrow z\in y))$.  For this to be well typed, the variables
$x$ and $y$ must be of the same type, one type higher than the type of $z$.

The comprehension axioms are all the well-formed assertions of the shape $(\exists A:(\forall x:x \in A \leftrightarrow \phi))$, where $\phi$ is any formula in which $A$ does not occur free.

The witness to $(\exists A:(\forall x:x \in A \leftrightarrow \phi))$ is unique by extensionality, and we introduce the notation $\{x:\phi\}$ for this object.  Of course, $\{x:\phi\}$  is to be assigned type one higher than that of $x$;  in general, term constructions will have types as variables do.

The modification which gives TSTU (the simple type theory of sets with urelements) replaces the extensionality axioms with the formulas of the shape $$(\forall xyw:w \in x \rightarrow (x=y \leftrightarrow (\forall z:z \in x \leftrightarrow z\in y))),$$  allowing many objects with no elements (called atoms or urelements)  in each positive type.  A technically useful refinement adds a constant $\emptyset^i$ of each positive type $i$ with no elements:  we can then address the problem that $\{x^i:\phi\}$ is not uniquely defined when $\phi$ is uniformly false by defining $\{x^i:\phi\}$ as $\emptyset^{i+1}$ in this case.

\subsubsection{Typical ambiguity}

TST exhibits a symmetry which is important in the sequel.

Provide a bijection $(x \mapsto x^+)$ from variables to variables of positive type satisfying   ${\tt type}(x^+)$ = ${\tt type}(x)+1$.

If $\phi$ is a formula, define $\phi^+$ as the result of replacing every variable $x$ (free and bound) in $\phi$ with $x^+$ (and occurrences of $\emptyset^i$ with $\emptyset^{i+1}$ if this is in use).   It should be evident that if $\phi$ is well-formed, so is $\phi^+$,
and that if $\phi$ is a theorem, so is $\phi^+$ (the converse is not the case).  Further, if we define a mathematical object as a set abstract $\{x:\phi\}$ we have an analogous
object $\{x^+:\phi^+\}$ of the next higher type (this process can be iterated).

The axiom scheme asserting $\phi \leftrightarrow \phi^+$ for each closed formula $\phi$ is called the Ambiguity Scheme.   Notice that this is a stronger assertion than is warranted by the symmetry of proofs described above.

\subsubsection{Historical remarks}

TST is not the type theory of the {\em Principia Mathematica\/} of Russell and Whitehead (\cite{pm}), though a description of TST is a common careless description of Russell's theory of types.

Russell described something like TST informally in his 1904 {\em Principles of Mathematics\/} (\cite{pm1}).  The obstruction to giving such an account in {\em Principia Mathematica\/} was that
Russell and Whitehead did not know how to describe ordered pairs as sets.  As a result, the system of {\em Principia Mathematica\/} has an elaborate system of  complex
types inhabited by $n$-ary relations with arguments of specified previously defined types, further complicated by predicativity restrictions (which are cancelled by an axiom of reducibility).
The simple theory of types of Ramsey eliminates the predicativity restrictions and the axiom of reducibility, but is still a theory with complex types inhabited by $n$-ary relations.

Russell noticed a phenomenon like the typical ambiguity of TST in the more complex system of {\em Principia Mathematica\/}, which he refers to as ``systematic ambiguity".

In 1914 (\cite{wiener}), Norbert Wiener gave a definition of the ordered pair as a set (not the one now in use) and seems to have recognized that the type theory of {\em Principia Mathematica\/} could be simplified to something like TST, but he did not give a formal description.  The theory we call TST was apparently first described by Tarski in 1930 (\cite{tarskiontst}).

It is worth observing that the axioms of TST look exactly like those of ``naive set theory", the restriction preventing paradox being embodied in the restriction of the language by the type system.
For example, the Russell paradox is averted because one cannot have $\{x:x \not\in x\}$ because $x \in x$ (and so its negation $\neg x \in x$) cannot be a well-formed formula.

It was shown around 1950 (in \cite{kemeny}) that Zermelo set theory proves the consistency of TST with the axiom of infinity;  TST + Infinity has the same consistency strength as
Zermelo set theory with separation restricted to bounded formulas.


\newpage

\subsection{Some mathematics in TST;  the theories TST$_n$ and their natural models}

We briefly discuss some mathematics in TST.

We indicate how to define the natural numbers.  We use the definition of Frege ($n$ is the set of all sets with $n$ elements).  0 is $\{\emptyset\}$ (notice that we get a natural number 0 in each type $i+2$;  we will be deliberately ambiguous in this discussion, but we are aware that anything we define is actually not unique, but reduplicated in each type above the lowest one in which it can be defined).  For any set $A$ at all we define $\sigma(A)$ as $\{a \cup \{x\}:a \in A \wedge x \not\in a\}$.  This is definable for any $A$ of type $i+2$ ($a$ being of type $i+1$ and $x$ of type $i$).  Define 1 as $\sigma(0)$, 2 as $\sigma(1)$,  3 as $\sigma(2)$, and so forth.  Clearly we have successfully defined 3 as the set of all sets with three elements, without circularity.
But further, we can define $\mathbb N$ as $\{n:(\forall I:0 \in I \wedge (\forall x \in I:\sigma(x) \in I) \rightarrow n \in I\}$, that is, as the intersection of all inductive sets.
$\mathbb N$ is again a typically ambiguous notation:  there is an object defined in this way in each type $i+3$.

The collection of all finite sets can be defined as $\bigcup \mathbb N$.  The axiom of infinity can be stated as $V \not\in \bigcup \mathbb N$ (where $V= \{x:x=x\}$ is the typically ambiguous symbol for the type $i+1$ set of all type $i$ objects).  It is straightforward to show that the natural numbers in each type of a model of TST with Infinity are isomorphic in a way representable in the theory.

Ordered pairs can be defined following Kuratowski and a quite standard theory of functions and relations can be developed.  Cardinal and ordinal numbers can be defined as Frege or Russell would have defined them, as isomorphism classes of sets under equinumerousness and isomorphism classes of well-orderings under similarity.  

The Kuratowski pair $(x,y) = \{\{x\},\{x,y\}\}$ is of course two types higher than its projections, which must be of the same type.  There is an alternative definition (due to Quine in \cite{quinepair}) of an ordered pair
$\left< x,y\right>$ in TST + Infinity which is of the same type as its projections $x,y$.  This is a considerable technical convenience but we will not need to define it here.  Note for example that if we use the Kuratowski pair the cartesian product $A \times B$ is two types higher than $A,B$, so we cannot define $|A| \cdot |B|$ as $|A \times B|$ if we want multiplication of cardinals to be a sensible operation.  Let $\iota$ be the singleton operation and define $T(|A|)$ as $|\iota``A|$ (this is a very useful operation sending cardinals of a given type to cardinals in the next higher type which seem intuitively to be the same).  The definition of cardinal multiplication if we use the Kuratowski pair is then $|A| \cdot |B| =T^{-2}(|A\times B|)$.  If we use the Quine pair this becomes the usual definition $|A| \cdot |B| =|A\times B|$.  Use of the Quine pair simplifies matters in this case, but it should be noted that the T operation remains quite important (for example it provides the internally representable isomorphism between the systems of natural numbers in each sufficiently high type).

Note that the form of Cantor's Theorem in TST is not $|A| < |{\cal P}(A)|$, which would be ill-typed, but $|\iota``A|<|{\cal P}(A)|$:  a set has fewer unit subsets than subsets.  The exponential map $\exp(|A|) = 2^{|A|}$ is not defined as $|{\cal P}(A)||$, which would be one type too high, but as $T^{-1}(|{\cal P}(A))$, the cardinality of a set $X$ such that $|\iota``X| = |{\cal P}(A)|$;   notice that this is partial.  For example
$2^{|V|}$ is not defined (where $V=\{x:x=x\}$, an entire type), because there is no $X$ with $|\iota``X|=|{\cal P}(V)|$, because $|\iota``V|<|{\cal P}(V)| \leq |V|$, and of course there is no set larger than $V$ in its type.

For each natural number $n$, the theory TST$_n$ is defined as the subtheory of TST with vocabulary restricted to use variables only of types less than $n$ (TST with $n$ types).
In ordinary set theory TST and each theory TST$_n$ have natural models, in which type 0 is implemented as a set $X$ and each type $i$ in use is implemented as ${\cal P}^i(X)$.  It should be clear that each TST$_n$ has natural models in bounded Zermelo set theory, and TST has natural models in a modestly stronger fragment of ZFC.

Further, each TST$_n$ has natural models in TST itself, though some care must be exercised in defining them.  Let $X$ be a set.  Implement type $i$ for each $i<n$ as
$\iota^{(n-1)-i}``{\cal P}^i(X)$.  If $X$ is in type $j$, each of the types of this interpretation of TST$_n$ is a set in the same type $j+n-1$.  For any relation $R$, define
$R^{\iota}$ as $\{(\{x\},\{y\}):x R y\}$.  The membership relation of type $i-1$ in type $i$ in the interpretation described is the restriction of $\subseteq^{\iota^{(n-1)-i}}$ to
the product of the sets implementing type $i-1$ and type $i$.

Notice then that we can define truth for formulas in these natural models of TST$_n$ for each $n$ in TST, though not in a uniform way which would allow us to define truth for formulas
in TST in TST.

Further, both in ordinary set theory and in TST, observe that truth of sentences in natural models of TST$_n$ is completely determined by the cardinality of the set used as type 0.
since two natural models of TST or TST$_n$ with base types implemented by sets of the same cardinality are clearly isomorphic. 

\newpage

\subsection{New Foundations and NFU}

In \cite{nf}, 1937, Willard van Orman Quine proposed a set theory motivated by the typical ambiguity of TST described above.  The paper in which he did this was titled ``New foundations for mathematical logic", and the set theory it introduces is called ``New Foundations" or NF, after the title of the paper.

Quine's observation is that since any theorem $\phi$ of TST is accompanied by theorems $\phi^+, \phi^{++}, \phi^{+++}, \ldots$ and every defined object $\{x:\phi\}$ is accompanied by
$\{x^+:\phi^+\},\{x^{++}:\phi^{++}\},\{x^{+++}:\phi^{+++}\}$, so the picture of what we can prove and construct in TST looks rather like a hall of mirrors, we might reasonably suppose that the types are all the same.

The concrete implementation follows.  NF is the first order unsorted theory with equality and membership as primitive with an axiom of extensionality $(\forall xy:x=y \leftrightarrow (\forall z:z \in x \leftrightarrow z\in y))$ and an axiom of comprehension $(\exists A:(\forall x:x \in A \leftrightarrow \phi))$ for each formula $\phi$ in which $A$ is not free which can be obtained from a formula of TST by dropping all distinctions of type.  We give a precise formalization of this idea:  provide a bijective map $(x \mapsto x^*)$ from the countable supply of variables (of all types) of TST onto the countable supply of variables of the language of NF.  Where $\phi$ is a formula of the language of TST, let $\phi^*$ be the formula obtained by replacing every veriable $x$, free and bound,
in $\phi$ with $x^*$. For each formula $\phi$ of the language of TST in which $A$ is not free in $\phi^*$ and each variable $x^*$, an axiom of comprehension of NF asserts $(\exists A:(\forall x^*:x^* \in A \leftrightarrow \phi^*))$.

In the original paper, this is expressed in a way which avoids explicit dependence on the language of another theory.  Let $\phi$ be a formula of the language of
NF.  A function $\sigma$ is a stratification of $\phi$ if it is a (possibly partial) map from variables to non-negative integers such that for each atomic subformula
`$x=y$'  of $\phi$ we have $\sigma($`$x$'$)=\sigma($`$y$'$)$ and for each atomic subformula `$x \in y$' of $\phi$ we have $\sigma($`$x$'$)+1 = \sigma($`$y$'$)$.
A formula $\phi$ is said to be stratified iff there is a stratification of $\phi$.  Then for each stratified formula $\phi$ of the language of NF and variable $x$ we have an axiom $(\exists A:(\forall x:x \in A \leftrightarrow \phi))$.  The stratified formulas are exactly the formulas $\phi^*$ up to renaming of variables.

NF has been dismissed as a ``syntactical trick" because of the way it is defined.  It might go some way toward dispelling this impression to note that the stratified comprehension scheme is equivalent to a finite collection of its instances, so the theory can be presented in a way which makes no reference to types at all.  This is a result of Hailperin (\cite{hailperin}), refined by others.  One obtains a finite axiomatization of NF by analogy with the method of finitely axiomatizing von Neumann-G\"odel-Bernays predicate class theory.  It should further be noted that the first thing one does with the finite axiomatization is prove stratified comprehension as a meta-theorem, in practice, but it remains significant that the theory can be axiomatized with no reference to types at all.

For each stratified formula $\phi$, there is a unique witness to $$(\exists A:(\forall x:x \in A \leftrightarrow \phi))$$ (uniqueness follows by extensionality) whch we denote by $\{x:\phi\}$.

Jensen in \cite{nfu}, 1969 proposed the theory NFU which replaces the extensionality axiom of NF with $$(\forall xyw:w \in x \rightarrow (x=y \leftrightarrow (\forall z:z \in x \leftrightarrow z\in y))),$$  allowing many atoms or urelements.  One can reasonably add an elementless constant $\emptyset$, and define $\{x:\phi\}$ as $\emptyset$ when $\phi$ is false for all $x$.

Jensen showed that NFU is consistent and moreoever NFU + Infinity + Choice is consistent.  We will give an argument similar in spirit though not the same in detail for the consistency of NFU in the next section.

An important theorem of Specker (\cite{ambiguity}, 1962) is that NF is consistent if and only if TST + the Ambiguity Scheme is consistent.  His method of proof adapts to show that  NFU is consistent if and only if TSTU + the Ambiguity Scheme is consistent.  Jensen used this fact in his proof of the consistency of NFU.  We indicate a proof of Specker's result using concepts from this paper below.

In \cite{notac}, 1954, Specker had shown that NF disproves Choice, and so proves Infinity.  At this point if not before it was clear that there is a serious issue of showing that NF is consistent relative to some set theory in which we have confidence.  There is no evidence that NF is any stronger than TST + Infinity, the lower bound established by Specker's result.

Note that NF or NFU supports the implementation of mathematics in the same style as TST, but with the representations of mathematical concepts losing their ambiguous character.  The number 3 really is realized as the unique set of all sets with three elements, for example.  The universe is a set and sets make up a Boolean algebra.   Cardinal and ordinal numbers can be defined
in the manner of Russell and Whitehead.

The apparent vulnerability to the paradox of Cantor is an illusion.  Applying Cantor's theorem to the cardinality of the universe in NFU gives $|\iota``V| < |{\cal }(V)| \leq |V|$ (the last inequality would be an equation in NF), from which we conclude that there are fewer singletons of objects than objects in the universe.  The operation $(x \mapsto \{x\})$ is not a set function, and there is every reason to expect it not to be, as its definition is unstratified.  The resolution of the Burali-Forti paradox is also weird and wonderful in NF(U), but would take us too far afield.

\newpage

\subsection{Tangled type theory TTT and TTTU}

In \cite{tangled}, 1995, this author described a reduction of the NF consistency problem to consistency of a typed theory,  motivated by reverse engineering from Jensen's method of proving the consistency of NFU.

Let $\lambda$ be a limit ordinal.  It can be $\omega$ but it does not have to be.  

In the theory TTT (tangled type theory) which we develop, each variable $x$ is supplied with a type ${\tt type}($`$x$'$) <\lambda$;  we are provided with countably many distinct variables of each type.

For any formula $\phi$ of the language of TST and any strictly increasing sequence $s$ in $\lambda$, let $\phi^s$ be the formula obtained by replacing each variable
of type $i$ with a variable of type $s(i)$.  To make this work rigorously, we suppose that we have a bijection from type $i$ variables of the language of TST to type $\alpha$ variables
of the language of TTT for each natural number $i$ and ordinal $\alpha<\lambda$.

TTT is then the first order theory with types indexed by the ordinals below $\lambda$ whose well formed atomic sentences `$x=y$' have ${\tt type}($`$x$'$) = {\tt type}($`$y$'$)$ and whose atomic sentences `$x \in y$' satisfy ${\tt type}($`$x$'$) < {\tt type}($`$y$'$)$, and whose axioms are the sentences $\phi^s$ for each axiom $\phi$ of TST and each strictly increasing sequence $s$ in $\lambda$.  TTTU has the same relation to TSTU (with the addition of constants $\emptyset^{\alpha,\beta}$ for each $\alpha<\beta<\lambda$  such that $(\forall {\bf x}_0^{\alpha} :{\bf x}_0^{\alpha}\not\in \emptyset^{\alpha,\beta})$ is an axiom).

It is important to notice how weird a theory TTT is.  This is not cumulative type theory.  Each type $\beta$ is being interpreted as a power set of {\em each\/} lower type $\alpha$.  Cantor's theorem in the metatheory makes it clear that most of these power set interpretations cannot be honest.

There is now a striking

\begin{description}

\item[Theorem (Holmes):]  TTT(U) is consistent iff NF(U) is consistent.

\item[Proof:]  Suppose NF(U) is consistent.  Let $(M,E)$ be a model of NF(U) (a set $M$ with a membership relation $E$).  Implement type $\alpha$ as $M \times \{\alpha\}$ for
each $\alpha<\lambda$.  Define $E_{\alpha,\beta}$ for $\alpha<\beta$ as $\{((x,\alpha),(y,\beta)):xEy\}$.  This gives a model of TTT(U).   Empty sets in TTTU present no essential additional difficulties.

Suppose TTT(U) is consistent, and so we can assume we are working with a fixed model of TTT(U).  Let $\Sigma$ be a finite set of sentences in the language of TST(U).  Let $n$ be the smallest type such that no type $n$ variable occurs in any sentence in $\Sigma$.  We define a partition of the $n$-element subsets of $\lambda$.  Each $A \in [\lambda]^n$ is put in a compartment
determined by the truth values of the sentences $\phi^s$ in our model of TTT(U), where $\phi \in \Sigma$ and ${\tt rng}(s \lceil \{0,\ldots,n-1\}) = A$.  By Ramsey's theorem, there is a homogeneous set $H \subseteq \lambda$ for this partition, which includes the range of a strictly increasing sequence $h$.  There is a complete extension of TST(U) which includes
$\phi$ iff the theory of our model of TTT(U) includes $\phi^h$.  This extension satisfies $\phi \leftrightarrow \phi^+$ for each $\phi \in \Sigma$.  But this implies by compactness that the full Ambiguity Scheme $\phi \leftrightarrow \phi^+$ is consistent with TST(U), and so that NF(U) is consistent by the 1962 result of Specker.

We note that we can give a treatment of the result of Specker (rather different from Specker's own) using TTT(U).  Note that it is easy to see that if we have a model of TST(U) augmented with a Hilbert symbol (a primitive term construction $(\epsilon x:\phi)$ (same type as $x$) with axiom scheme $\phi[(\epsilon x:\phi)/x] \leftrightarrow (\exists x:\phi)$) which cannot appear in instances of comprehension (the quantifiers are not defined in terms of the Hilbert symbol, because they do need to appear in instances of comprehension) and Ambiguity (for all formulas, including those which mention the Hilbert symbol) then we can readily get a model of NF, by constructing a term model using the Hilbert symbol in the natural way, then identifying all terms with their type-raised versions.  All statements in the resulting type-free theory can be decided by raising types far enough (the truth value of an atomic sentence $(\epsilon x:\phi) \,R\, (\epsilon y:\psi)$ in the model of NF is determined by raising the type of both sides (possibly by different amounts) until the formula is well-typed in TST and reading the truth value of the type raised version;  $R$ is either = or $\in$).  Now observe that a model of TTT(U) can readily be equipped with a Hilbert symbol if this creates no obligation to add instances of comprehension
containing the Hilbert symbol (use a well-ordering of the set implementing each type to interpret a Hilbert symbol  $(\epsilon x:\phi)$ in that type as the first $x$ such that $\phi$), and the argument above for consistency of TST(U) plus Ambiguity with the Hilbert symbol goes through.

\item[Theorem (essentially due to Jensen):]  NFU is consistent.

\item[Proof:]  It is enough to exhibit a model of TTTU.  Suppose $\lambda>\omega$.  Represent type $\alpha$ as $V_{\omega+\alpha} \times \{\alpha\}$ for each $\alpha<\lambda$ ($V_{\omega+\alpha}$ being a rank of the usual cumulative hierarchy).  Define $\in_{\alpha,\beta}$ for
$\alpha<\beta<\lambda$ as $$\{((x,\alpha),(y,\beta)):x \in V_{\omega+\alpha} \wedge y \in V_{\omega+\alpha+1} \wedge x \in y\}.$$  This gives a model of TTTU in which the membership of
type $\alpha$ in type $\beta$ interprets each $(y,\beta)$ with $y \in V_{\omega+\beta} \setminus V_{\omega+\alpha+1}$ as an urelement.

Our use of $V_{\omega+\alpha}$ enforces Infinity in the resulting models of NFU (note that we did not have to do this:  if we set $\lambda=\omega$ and interpret type $\alpha$ using $V_\alpha$ we prove the consistency of NFU with the negation of Infinity).  It should be clear that Choice holds in the models of NFU eventually obtained if it holds in the ambient set theory.

This shows in fact that mathematics in NFU is quite ordinary (with respect to stratified sentences), because mathematics in the models of TSTU embedded in the indicated model of TTTU is quite ordinary.  The notorious ways in which NF evades the paradoxes of Russell, Cantor and Burali-Forti can be examined in actual models and we can see that they work and how they work (since they work in NFU in the same way they work in NF).

\end{description}

Of course Jensen did not phrase his argument in terms of tangled type theory.  Our contribution here was to reverse engineer from Jensen's original argument for the consistency of NFU an argument for the consistency of NF itself, which requires additional input which we did not know how to supply (a proof of the consistency of TTT itself).  An intuitive way to say what is happening here is that Jensen noticed that it is possible to skip types in a certain sense in TSTU in a way which is not obviously possible in TST itself;  to suppose that TTT might be consistent is to suppose that such type skipping is also possible in TST.

\newpage



\subsubsection{How internal type representations unfold in TTT}

We have seen above that TST can internally represent TST$_n$.   An attempt to represent types of TTT internally to TTT has stranger results.  The development of the model does not depend on reading this section.

In TST the strategy for representing type $i$ in type $n\geq i$  is to use the $n-i$-iterated singleton of any type $i$ object $x$ to represent $x$;  then membership of representations of type $i-1$ objects in type
$i$ objects is represented by the relation on $n-i$-iterated singletons induced by the subset relation and with domain restricted to $n-(i+1)$-fold singletons.  This is described more formally above.

In TTT the complication is that there are numerous ways to embed type $\alpha$ into type $\beta$ for $\alpha<\beta$ along the lines just suggested.    We define a generalized
iterated singleton operation:  where $A$ is a finite subset of $\lambda$, $\iota_A$ is an operation defined on objects of type ${\tt min}(A)$.  $\iota_{\{\alpha\}}(x)=x$.
If $A$ has $\alpha<\beta$ as its two smallest elements, $\iota_A(x)$ is  $\iota_{A_1}(\iota_{\alpha,\beta}(x))$, where $A_1$ is defined as $A \setminus \{{\tt min}(A)\}$ (a notation we will continue to use) and $\iota_{\alpha,\beta}(x)$ is the unique type $\beta$ object whose only type $\alpha$ element is $x$.

Now for any nonempty finite $A \subseteq \lambda$ with minimum $\alpha$ and maximum $\beta$. the range of $\iota_A$ is a set, and a representation of type $\alpha$ in
type $\beta$.  For simplicity we carry out further analysis in types $\beta, \beta+1,\beta+2\ldots$ though it could be done in more general increasing sequences.  Use the notation
$\tau_A$ for the range of $\iota_A$, for each set $A$ with $\beta$ as its maximum.  Each such set has a cardinal $|\tau_A|$ in type $\beta+2$.  It is a straightforward
argument in the version of TST with types taken from $A$ and a small finite number of types $\beta+i$ that $2^{|\tau_A|} = |\tau_{A_1}|$ for each $A$ with at least two elements.
The relevant theorem in TST is that $2^{|\iota^{n+1}``X|} = \iota^n``X$, relabelled with suitable types from $\lambda$.   We use the notation $\exp(\kappa)$ for $2^\kappa$ to support iteration.  Notice that for any $\tau_A$ we have $\exp^{|A|-1}(|\tau_A|) = |\tau_{\{\beta\}}|$, the cardinality of type $\beta$.  Now if $A$ and $A'$ have the same minimum $\alpha$ and maximum $\beta$ 
but are of different sizes, we see that $|\tau_A| \neq |\tau_{A'}|$, since one has its $|A|-1$-iterated exponential equal to $|\tau_{\{\beta\}}|$ and the other has its $|A'|-1$-iterated exponential equal to $|\tau_{\{\beta\}}|$.  This is odd because there is an obvious external bijection between the sets $\tau_A$ and $\tau_{A'}$:  we see that this external bijection cannot be realized as a set.  $\tau_A$ and $\tau_{A'}$ are representations of the same type, but this is not obvious from inside TTT.  We recall that we denote $A \setminus \{{\tt min}(A)\}$ by $A_1$;  we further denote $(A_i)_1$ as $A_{i+1}$.  Now suppose that $A$ and $B$ both have maximum $\beta$ and $A \setminus A_i = B \setminus B_i$, where $i<|A| \leq |B|$.
We observe that for any concrete sentence $\phi$  in the language of TST$_i$, the truth value of $\phi$ in natural models with base type of sizes $|\tau_A|$ and $|\tau_B|$ will be the same, because the truth values we read off are the truth values in the model of TTT of versions of $\phi$ in exactly the same types of the model (truth values of $\phi^s$ for
any $s$ having $A \setminus A_i = B\setminus B_i$ as the range of an initial segment).  This much information telling us that $\tau_{A_j}$ and $\tau_{B_j}$ for $j<i$ are representations of the same type  is visible to us internally, though the external isomorphism is not.  We can conclude that the full first-order theories of natural models of TST$_i$ with base types $|\tau_A|$ and $|\tau_B|$ are
the same as seen inside the model of TTT, if we assume that the natural numbers of our model of TTT are standard.

\newpage

\subsubsection{Tangled webs of cardinals:  a suggestion of another approach not followed here}

Nothing in the construction of a model of tangled type theory and verification that it is a model which appears below depends on anything in this section.

It is straightforward to transform a model of TST into a model of bounded Zermelo set theory (Mac Lane set theory) with atoms or without foundation
(this depends on how type 0 is handled).  Specify an interpretation of type 0 either as a set of atoms or a set of self-singletons.  Then interpret
type $i+1$ as inhabited by sets of type $i$ objects in the obvious way, identifying type $i+1$ objects with objects of lower type which happen to have been assigned the same extension.

In a model of TTT, do this along some increasing sequence of types of order type $\omega$ whose range includes an infinite ordinal $\alpha$.  In the resulting model of bounded Zermelo set theory,
let $\tau_A$ represent the cardinality of the range of $\iota_A$ as in the previous discussion (for nonempty subsets of type $A$ all with maximum the same infinite $\alpha$).  Suppose further for the sake of argument that our model of TTT is $\lambda$-complete, in the sense that any subset of a type of cardinality that of $\lambda$ or less is implemented as a set in each higher type.
It will follow that $A \mapsto \tau_A$ is actually a function. [It is an incidentally interesting fact that the models we construct (with no dependence on this section) actually have this completeness property].

We describe the situation which holds for these cardinals.  

We work in Mac Lane set theory.  Choice is not assumed, and we use the Scott definition of cardinals.

\begin{description}

\item[Definition:]  If $A$ is a nonempty finite set of ordinals which is sufficiently large, we define $A_1$ as $A \setminus {\tt min}(A)$ and $A_0$ as $A$, $A_{i+1}$ as $(A_i)_1$.

\item[Definition:]  A tangled web of cardinals of order $\alpha$ (an infinite ordinal) is a function $\tau$ from the set of nonempty sets of ordinals with $\alpha$ as maximum
to cardinals such that

\begin{enumerate}

\item  If $|A|>1$, $\tau(A_1) = 2^{\tau(A)}$.

\item  If $|A|\geq n$, the first order theory of a natural model of TST$_n$ with base type $\tau(A)$ is completely determined by $A \setminus A_n$, the
$n$ smallest elements of $A$.

\end{enumerate}

The bookkeeping in different versions of this definition in different attempts at a tangled web version of the proof of the consistency of NF have been different (an obvious point about the version given here is that the top ordinal $\alpha$ could be omitted).  Another remark is that it is clear that asserting the existence of a tangled web is stronger than simple TTT:  it requires $\lambda>\omega$, and the $|\lambda|$-completeness of course is a strong assumption in the background.  All variants that I have used support versions of the following

\item[Theorem:]  If there is a model of Mac Lane set theory in which there is a tangled web of cardinals $\tau$, then NF is consistent.

\item[Proof:]  Let $\Sigma$ be a finite set of sentences of the language of TST.  Let $n$ be larger than any type mentioned in any formula in $\Sigma$.
Partition $[\alpha]^n$ into compartments in such a way that the compartment that a set $A$ is put into depends on the truth values of the sentences in $\Sigma$ in natural models of TST$_n$  with base type of size $\tau(B)$ where $B \setminus B_n=A$.  This partition of $[\alpha]^n$ into no more than
$2^{|\Sigma|}$ compartments has a homogeneous set $H$ of size $n+1$.  The natural models of TST$_n$ with base types of size $\tau(H)$ and base
types of size $\tau(H_1)$ have the same truth values for sentences in $\Sigma$, so the model of TST with base type $\tau(H)$ satisfies the restriction of the Ambiguity Scheme to $\Sigma$, so the full Ambiguity Scheme is consistent by compactness, so TST + Ambiguity is consistent so NF is consistent.


\end{description}

Our initial approach to proving our theorem was to attempt a Frankel-Mostowski construction of a model of Mac Lane set theory with a tangled web of cardinals.  We do know how to do this, but we believe from experience that constructing a model of tangled type theory directly is easier, though tangled type theory is a nastier theory to describe.

We think there is merit in giving a brief description of a situation in a more familiar set theory equivalent to (a strengthening of) the very strange situation in a model of tangled type theory.

\newpage




\section{The model description}

In this section, we give a complete description of what we claim is a model of tangled type theory.  The construction may be supposed carried out in ZFC (or some weak subsystem thereof:  we will see how much ZFC is needed).

\subsection{Cardinal parameters}

Let $\lambda$ be a limit ordinal.  Elements of $\lambda$ will be indices of types in the model of tangled type theory.  $-1$ is an index of an additional type in the structure we are using to build the model.  Elements of $\lambda \cup \{-1\}$ are called type indices;  type indices other than $-1$ are called proper type indices.  The order on the type indices is the obvious one in which $-1$ is less than the elements of $\lambda$, which inherit their usual order.

Nonempty finite subsets of $\lambda \cup \{-1\}$ are called {\em extended type indices\/};  ones that do not contain $-1$ are called {\em proper\/} extended type indices.   An extended type index $A$ may be understood as referring to the type ${\tt min}(A)$ in the role of type 0 in a model of TST$_{|A|}$ whose higher types are indexed by the larger elements of $A$.

Let $\kappa>\lambda$ be an uncountable regular cardinal.  We refer to sets of size smaller than $\kappa$ as small and all other sets as large.

Let $\mu$ be a strong limit cardinal $>\kappa$ of cofinality $\geq \kappa$.  



\subsection{Type $-1$:  ``Atoms", litters, and local cardinals}

We define $\tau_{-1}$ as $\{(-1,\nu,\alpha):\nu <\mu \wedge \alpha<\kappa)\}$.

We may refer to objects of type $-1$ as ``atoms".  They are not understood here to be atoms in a conventional sense, but the analogous objects in earlier versions of the construction were atoms and we have this mental habit.

For each $\nu<\mu$ we define $L_\nu$ as $\{(-1,\nu,\alpha):\alpha<\kappa\}$.  We call the sets $L_\nu$ {\em litters\/}.
Note that the set $\Lambda = \{L_\nu:\nu < \mu\}$ is a partition of the set $\tau_{-1}$ of size $\mu$ into subsets of size $\kappa$.

We say that a set $N$ is a {\em near-litter\/} iff $N \subseteq \tau_{-1} \wedge (\exists \nu:|N \Delta L_\nu|<\kappa)$:  a near-litter is a subset of $\tau_{-1}$ with small symmetric difference from some litter.  Of course litters are near-litters.

The relation of having small symmetric difference is an equivalence relation on near-litters.

For any near-litter $N$ we define $[N]$ as the set $\{M\subseteq \tau_{-1}:|N \Delta M| <\kappa\}$  of all near-litters $M$ with small symmetric difference from $N$.  We call the sets $[N]$ {\em local cardinals\/} and say that $[N]$ is the local cardinal of $N$.  This convention is motivated by the Frege-Russell-Whitehead notion of cardinal (which is the natural one to use in TST and related theories).

We introduce the (overloaded) notation $N^\circ = [N]^\circ$ for the litter with small symmetric difference from the near-litter $N$.

Because the cofinality of $\mu$ is $\geq \kappa$, there are $\mu$ near-litters.   One might be concerned with the fact that if $\mu$ has cofinality $\kappa$, it might have more than $\mu$ subsets of size $\kappa$:  but it still has only $\mu$ subsets of size $<\kappa$, and that is what matters for counting the near-litters:  a near-litter is determined as the symmetric difference of a litter ($\mu$ of these) and a small subset (cardinality $<\kappa$) of $\tau_{-1}$ (which is of size $\mu$) and there are only $\mu$ small subsets of $\tau_{-1}$.  If the cofinality of $\mu$ were less than $\kappa$, the cardinal arithmetic pathology mentioned as of concern could come into play.



We designate a pairwise disjoint family of subsets ${\bf X}_{(\beta,\gamma)}$ of the set of local cardinals, each of cardinality $\mu$, indexed by ordered pairs $(\beta,\gamma)$ with $-1 \leq \beta <\lambda$ and $\gamma \in \lambda \setminus \{\beta\}$.  These play an essential role in defining alternative extensions of the same object.

\subsection{Set codes and alternative extensions:  membership defined and extensionality enforced}


For each $\alpha<\lambda$ we will define $\tau_{\alpha}$, the implementation of type $\alpha$ of the model.  This definition is recursive:  when we are defining type $\alpha$ and associated concepts, we are supposing that related concepts have already been defined for all $\beta<\alpha$.

So, we fix $\alpha<\lambda$, a proper type index, and we assume that for all type indices $<\alpha$ the construction we are describing has already been carried out:  we define $\tau_\alpha$ and related notions.

\begin{description}
\item[Definition (codes):]  We suppose for $\beta<\alpha$ a proper type index that a $\beta$-code has already been defined as a triple $(\beta,\gamma,G)$ where $-1 \leq \gamma<\beta$ and $G \subseteq \tau_{\gamma}$. 

A $\alpha$-code is defined now as a triple $(\alpha,\beta,B)$ where $-1 \leq \beta<\alpha$ and $B \subseteq \tau_{\beta}$.   

\item[A hypothesis of the recursion:  proper types are inhabited by codes:]

We remark that $\tau_\beta$ for $-1<\beta<\alpha$  is a (proper) subset of the collection of $\beta$-codes (a hypothesis of the recursion).

\item[Definition ($f$ maps):]  All codes $(\beta,-1,N)$ are stipulated to be elements of $\tau_\beta$ (this will be verified as following from inductive hypotheses given in more detail later).   We refer to such objects as typed near-litters. 

 On each type $\delta$, $-1 \leq \delta <\alpha$, we have chosen a well-ordering $\leq_\delta$ of order type $\mu$ (with corresponding strict well-ordering $<_\delta$).  Technical conditions on these well-orderings are stated at the end of this section.

   We define $\iota(x)$ for $x \in \tau_\beta$ as the order type of $\leq_\beta$ restricted to $\{y \in \tau_\beta:y <_\beta x\}$ (note that $\iota$ is defined for elements of any type).

   Where $\gamma$ is a type index less than $\alpha$ and $\delta$ is a proper type index distinct from $\gamma$ and also less than $\alpha$, and $x \in \tau_\gamma$, we define $f_{\gamma,\delta}(x)$ as the local cardinal $[N]$ of the third component of the first $(\delta,-1,N)$ in $<_\delta$ such that $N$ is a near-litter and $[N] \in {\bf X}_{(\beta,\gamma,\delta)}$ and $\iota(\delta,-1,M)>\iota(x)$  for each $M \in [N]$ and $[N] \neq f_{\beta,\gamma,\delta}(y)$ for any $y <_\gamma x$.  

Note that this definition does not really depend on $\alpha$:  it will give the same result at any stage of the construction beyond $\gamma$ and $\delta$.

\item[Definition (alternative extension map):]  For any $\beta$-code $(\beta,\gamma,G)$ with $\beta \leq \alpha$ a proper type index and $\delta$ a proper type index distinct from $\gamma$ and less than $\beta$, and $G$ nonempty, we define
$A_\delta(\beta,\gamma,G)$ as $$(\beta,\delta,\{(\delta,-1,N):N \in \bigcup (f_{\gamma,\delta}``G)\}).$$

Notice that the value computed here does not depend on $\alpha$:  this computation at earlier stages in the recursion gives the same result at every stage whose index is at least $\beta$.

\item[Observations and definition of $A^{-1}$:]  Notice that since the ranges of $f_{\gamma,\delta}$ and $f_{\gamma',\delta'}$ are disjoint unless $\gamma=\gamma'$ and $\delta=\delta'$, it follows that the ranges of
maps $A_\gamma$ with distinct indices are disjoint.  Clearly each $A_\gamma$ is injective, and so the union of the $A_\gamma$'s is a (partial) function with an inverse which we will call $A^{-1}$.

\item[Lemma:]  Further, it should be clear from the definition of the $f$ maps that
no code can have infinitely many iterated images under $A^{-1}$:  when $A^{-1}$ is applied, local cardinals which are subsets of the extension are replaced with (singletons of) objects earlier in the well-ordering on their type than all elements of the local cardinal are in their own type.  Look at what happens to the position of the first element in an extension under the appropriate order as $A^{-1}$ is applied repeatedly.

\item[Definition of equivalence of codes:]   We now define an equivalence relation $\equiv_{\beta}$ for each type index $\beta \leq \alpha$.

It is important to notice that the definition of $\equiv_{\beta}$ will be the same from stage $\beta$ of the recursion onward.

The relation $\equiv_{-1}$ is simply the restriction of equality to $\tau_{-1}$.

For each proper type index $\beta$, $(\beta,\gamma,\emptyset) \equiv_\beta (\beta,\delta,D)$ iff $D=\emptyset$, and the representative member of this equivalence class is $(\beta,-1,\emptyset)$.

We then provide that if $G$ is nonempty and $(\beta,\gamma,G)$ has an even number of iterated preimages under $A^{-1}$ (including none, as an important possibility) and $\delta \neq \gamma$ then $(\beta,\delta,D) \equiv_{\beta} (\beta,\gamma,G)$ iff  $(\beta,\delta,D)=A_\delta(\beta,\gamma,G)$, and in this case $(\beta,\gamma,G)$ is the representative of its equivalence class.
This implies that each $(\beta,\gamma,G)$ ($G$ nonempty) which has an odd number of iterated preimages under $A^{-1}$ is equivalent under $\equiv_\beta$ to
its inverse image $A^{-1}(\beta,\gamma,G)$ (which we write $(\beta,\delta,D))$, and which is the representative of its equivalence class) and to all $A_{\epsilon}(\beta,\delta,D)$ for
$\epsilon \neq \delta$.  This completes the definition of $\equiv_\beta$.

\item[A hypothesis of the recursion:  elements of proper types are representative codes:]

We note further that elements of $\tau_\beta$ for each $\beta<\alpha$ are representative elements of their equivalence classes under $\equiv_\beta$.  This will be verifiable from a more complete description of our assumptions about $\tau_\beta$ for $\beta<\alpha$ which is given below.

\item[Definition (membership of the intended model of TTT):]  The membership relations of the intended model of tangled type theory are then defined as follows: $(\delta,\epsilon,E) \in_{TTT} (\beta,\gamma,G)$ (the triples are codes and $-1<\delta<\beta \leq \alpha$, and both codes given are representatives of their equivalence classes) iff $\gamma=\delta$ and
$(\delta,\epsilon,E)  \in B$ or $\gamma\neq \delta$ and $(\delta,\epsilon,E) \in \pi_3(A_{\delta}(\beta,\gamma,G))$.  Note that in this latter case we will certainly have $\epsilon=-1$.  This does define membership of codes of lower types in
type $\beta$ codes which will eventually be seen not to belong to $\tau_\beta$;  this is harmless.

\item[Theorem:]  If $X$ and $Y$ are $\beta$-codes ($\beta \leq \alpha$) which are representatives of their equivalence classes, and $\gamma$ is a proper type index less than $\beta$,
$$(\forall Z \in \tau_\gamma: Z \in_{TTT} X \leftrightarrow Z \in_{TTT} Y) \rightarrow X = Y).$$  This should be evident from the method of construction.   Each representative code has an extension in each lower type, and no two representative codes can have the same extension in any lower type.

\end{description}

This all serves to enforce extensionality, but something much more radical needs to be done to make all this work, as we are assuming the existence of the maps $f_{\beta,\gamma}$ which witness that all the types are of cardinality no greater than $\mu$.  There must be a very strong restriction on what sets can appear as third components of codes in the model.

\subsection{Permutations, symmetry and the model definition}

We try to improve intelligibility of the notion of ``allowable permutation" that we now define by providing a preliminary notion.

\begin{description}

\item[Stipulation:]  We postulate as part of the hypotheses of the recursion that $(\beta,\gamma,\{x\}) \in \tau_\beta$ for any $x \in \tau_\gamma$, for any $\gamma<\beta<\alpha$.  This will be verifiable from a more complete description of our assumptions about $\tau_\beta$ for $\beta<\alpha$ which is given below.  We refer to such objects as typed singletons;  when $\gamma=-1$, we may refer to them as typed atoms.

\item[Definition (structural permutation):]  We define the notion of $\beta$-structural permutation for each type index $\beta \leq \alpha$.  It should be evident that the definition given for $\beta$-structural permutation will give the same result at each stage of the recursive construction with index $\geq \beta$.

A $-1$-structural permutation is simply a permutation of type $-1$.

If $\beta$ is a proper type index, a permutation $\pi$ of $\beta$-codes is $\beta$-structural iff there is for each type index $\gamma<\beta$ a
$\gamma$-structural permutation $\pi_\gamma$ such that for any $\beta$-code $(\beta,\gamma,G)$ we have $\pi(\beta,\gamma,G) = (\beta,\gamma,\pi_\gamma``G)$.

Notice that if $\pi$ is a $\beta$-structural permutation, each $\pi_\gamma$ is definable from $\pi$ by $\pi_\gamma(x) = \bigcup(\pi_3(\pi(\beta,\gamma,\{x\})))$.  Note further (a fact we do not use directly, though it must be noticed) that we are implicitly assuming that all $\pi_\gamma$ for $\gamma<\beta$
map elements of $\tau_\gamma$ to elements of $\tau_\gamma$.

\item[Definition (notation for derivatives of a permutation):] We provide extended notation for the lower indexed structural  permutations which  $\beta$-structural permutation depends, for any proper type index $\beta \leq \alpha$.
For any nonempty set $A$ of type indices with $\beta$ as its largest element, define $\pi_A$ as $\pi$ if $A = \{\beta\}$
and otherwise as $(\pi_{A \setminus \{{\tt min}(A)\}})_{{\tt min}(A)}$.  We refer to permutations $\pi_A$ as derivatives of $\pi$.

\item[Definition (allowable permutation):]  For each $\beta\leq \alpha$, we define a $\beta$-allowable permutation as a $\beta$-structural permutation with certain additional properties.

A $-1$-allowable permutation is a permutation $\pi$ of $\tau_{-1}$ with the property that for any near-litter $N$, $\pi``N$ is a near-litter.  Notice that a $-1$-allowable permutation determines a permutation of the local cardinals in a natural way.

For $\beta>-1$, a $\beta$-allowable permutation is a $\beta$-structural permutation $\pi$ such that each $\pi_\gamma$ for $\gamma<\beta$ is 
$\gamma$-allowable, and further for any codes $X,Y$,  $X \equiv_\beta Y \leftrightarrow \pi(X) \equiv_\beta \pi(y)$ (this is referred to as the coherence condition).



\item[Discussion (unpacking the coherence condition):]  This coherence condition can be unpacked.  $$(\beta,\gamma,\{g\}) \equiv_{\beta} (\beta,\delta,\{(\delta,-1,N):N \in f_{\gamma,\delta}(g)\})$$ (where $\delta\neq \gamma$).  Thus we expect $$\pi(\beta,\gamma,\{g\}) \equiv_{\beta} \pi(\beta,\delta,\{(\delta,-1,N):N \in f_{\gamma,\delta}(g)\}),$$ that is, $$(\beta,\gamma,\{\pi_{\gamma}(g)\}) \equiv_{\beta} (\beta,\delta,\{(\delta,-1,(\pi_{\delta})_{-1}``N):N \in f_{\gamma,\delta}(g)\}),$$ so $f_{\gamma,\delta}(\pi_\gamma(g)) = [(\pi_\delta)_{-1}``L]$, where $f_{\gamma,\delta}(g)=[L]$.  

Recalling the notations $N^\circ=[N]^\circ$ for the litter with small symmetric difference from the near-litter $N$, we can write this $$f_{\gamma,\delta}(\pi_\gamma(g)) = [(\pi_\delta)_{-1}``f_{\gamma,\delta}(g)^\circ].$$

It is straightforward to show that this condition is equivalent to the coherence condition.  Notice that $\pi_\beta$ imposes some restrictions on $\pi_\gamma$, but only on the way it acts on certain typed near-litters (and of course there are reciprocal relations between $\pi_{\gamma}$ and $\pi_\beta$).

It is straightforward to show that allowable permutations commute with maps $A_\gamma$ and $A^{-1}$, and the image under an allowable permutation of a representative code is a representative code.



\item[Definition (support and symmetry):]  An $\beta$-support is a well-ordering of a small set of triples of the form $((\gamma,-1,x),A)$
where in each triple, $\gamma\leq \beta$, $x$ is a singleton or near-litter, $A$ is an extended type index with maximum $\beta$ and minimum $\gamma$,
and $\delta \in A$.

We may write $x \leq_S y$ for $(x,y) \in S$, and $x <_S y$ when we also want to indicate that $x,y$ are distinct.

If $\pi$ is an $\alpha$-allowable permutation and $S$ is an $\alpha$-support, we define $\pi[S]$ as $\{((\pi_A(x),A),(\pi_B(y),B)):((x,A),(y,B))\in S\}$.

We say that $S$ is a $\beta$-support of $X$ if $X$ is a $\beta$-code, $S$ is an $\beta$-support, and for any $\beta$-allowable permutation $\pi$, if $\pi[S]=S$ then $\pi(x)=x$.

\item[Observation (cardinality of the set of supports):]  It is a useful observation that because $\mu$ has cofinality $\geq \kappa$, there are no more than $\mu$ (and so exactly $\mu$) near-litters,
and similarly there are exactly $\mu$ supports.

\item[Definition (the types of our structure):]  We then stipulate that the elements of $\tau_\beta$  for $\beta <\alpha$ have been constructed precisely as the representatives of equivalence classes of type $\beta$ codes that have supports:  such codes are said to be symmetric.  It should be evident that typed near-litters are symmetric [they have supports which are decorated versions of their own singletons], and typed singletons of symmetric objects are symmetric [take the support of the singleton element and add the type of the singleton to all the extended type indices in the support], as we assumed above.   It should also be clear that $\tau_\beta$ is defined in the same way at every stage with index at least $\beta$.

We then define $\tau_\alpha$ in the same way as the set of all representatives of equivalence classes of type $\alpha$-codes that have supports, and will refer to such $\alpha$-codes (and codes equivalent to them) as symmetric $\alpha$-codes.

It should also be evident that $(\beta,\gamma,G)$ (for $\beta\leq \alpha$) will always be symmetric if $|G|<\kappa$ [take the union of the $\gamma$-supports of elements of $G$ and add $\alpha$ to all the second components of elements of this union]:  all small subsets of a type are realized in each higher type.

\item[Applying permutations to objects with support:]  Quite standard techniques show that if $\pi$ is an $\beta$-allowable permutation and $X \in \tau_\beta$ has $\beta$-support $S$, then $\pi(X)$ has $\beta$-support $\pi[S]$.   It follows from this that an allowable permutation on $\beta$-codes restricts to a permutation on $\tau_\beta$, as we presumed in the definition of allowable permutation.



\item[Construction of designated orders on the types with technical conditions:]  Once $\tau_\alpha$ is constructed (and we verify that it is actually of cardinality $\mu$) we choose a well-ordering $\leq_\alpha$ of $\tau_\alpha$ with order type $\mu$ for use in the definition of more $f$ maps.  This order needs to satisfy technical conditions, which are satisfied by all $\leq_\beta$ with $\beta\leq\alpha$:  we provide for reasons to be discussed later that
\begin{enumerate}
\item any $(\beta,-1,L)$, $L$ a near-litter, precedes each $(\beta,-1,\{a\})$ for $a \in L$ in $<_\beta$;  \item any near-litter $N$ which is not a litter is preceded in the order $<_\beta$ by $N^\circ$  and all elements of $N\Delta N^\circ$; \item designate a $\beta$-support for each $x \in \tau_\beta$ which is not a typed atom or typed near litter:  we require that $\iota(x)$ strictly exceed $\iota(y)$ for each $(y,A)$ in the domain of the designated support of $x$.\end{enumerate}  We assume that such designated supports and conditions on the order $\leq_\beta$ are present, as a hypothesis of the recursion, for $\beta<\alpha$, and construct them for $\alpha$.

This implies that for any $x$ in any $\tau_\beta$, elements $(y,A)$ of the designated support of $f_{\beta,\gamma}(x)$  have $\iota(y) < \iota(x)$.
\end{description}
There is lots to be proven, but that is the entire description.

% \begin{comment}

{\bf Note for the formal verification project:}  I believe that the description of the model is complete and ready to be formalized.   Supports are now introduced as well-orderings from the outset.

% \end{comment}

\newpage

\section{Showing that it is all true:  proving that the structure described in the previous section is a model of tangled type theory}

\subsection{Strong supports defined}

\begin{description}

\item[Definition:]  For an extended type index $A$, let $A_1$ denote $A \setminus \{{\tt min}(A)\}$

\item[Definition (raising and lowering index on a support):]  For any $\alpha$-support $S$ and finite subset $C$ of $\lambda$ with minimum element greater than $\alpha$, we define $S^C$ as
$\{((x,A\cup C,\gamma),(y,B\cup C,\delta)):((x,A,\gamma),(y,B,\delta)) \in S\}$.

If $S$ is an $\alpha$-support and $\beta<\alpha$, $S_\beta$ is defined as the largest support $U$ such that $U^{\{\alpha\}} \subseteq S$ and $U$ is a $\beta$-support.

\item[Definition (strong support):]  A $\delta$-strong support of an object $X$ is a $\delta$-support $S$ of $X$ with certain additional properties.

\begin{enumerate}

\item  If $((\beta,-1,x),A) \in S$ then $x$ is a singleton or a litter.

\item  If $((\beta,-1,\{x\}),A) \in S$, then $((\beta,-1,L),A) <_S ((\beta,-1,\{x\}),A)$, where $L$ is the litter containing $x$.

\item  If $((\beta,-1,L),A) \in S$ and $[L]=f_{\gamma,\beta}(y)$, then there is a [strong] $\gamma$-support $T$ of $y$ such that $T^{A \setminus \{\beta\}} \subseteq S$ and each element of the domain of $T^{A \setminus \{\beta\}}$ is $\leq_S ((\beta,-1,L),A)$.

\end{enumerate}

\item[Definition:]  We say that a support $S'$ extends a support $S$ if ${\tt dom}(S) \subseteq {\tt dom}(S')$:  we might change the order in the extension process.

\item[Observation:  a support can have all near-litters converted to litters:]  It should be straightforward to see that any $X$ with support $S$ has a support $S^\circ$ which satisfies the first condition.  Replace each
element $((\beta,-1,x),A)$ of the domain of $S$ for which $x$ is a near-litter and not a litter with $((\beta,-1,x^\circ),A)$ and $((\beta,-1,\{y\}),A)$ for each $y$ in the symmetric difference of $x$ and $x^\circ$.

We can formally define the order $S^\circ$:  the domain of $S^\circ$ consists of all elements $((\beta,-1,x),A)$ for which $x$ is a singleton or a litter [we call these preserved elements of the domain]  and elements $((\beta,-1,y),A)$ such that for some $x$, $((\beta,-1,x),A)$ is in the domain, $x$ is a near-litter and not a litter, 
and either $y=x^\circ$ or $y = \{z\} \subseteq x\Delta x^\circ$ (we call these new elements of the domain:  notice that nothing prevents a new element from also being a preserved element).  We refer to $((\beta,-1,x),A)$ as the archetype of $((\beta,-1,y),A)$.

For any code $X$ which is preserved and not new, we define $X'$ as $X$.  For any $X$ which is preserved and new, we define $X'$ as the earlier in the order
$S$ of $X$ and its archetype.  For any code $X$ which is new and not preserved, we define $X'$ as the archetype of $X$.  We define $X \, S^\circ \, Y$
as $X'\, S\, Y'$ when $X' \neq Y'$.  If $X'=Y'$ and $Y$ is a typed litter (there is only one possible value for $Y$ in this case), $X \, S \, Y$, and if $X$ is a typed litter, $Y \,S^\circ\, X$.  If $X'=Y'$ and $X'$ and $Y'$ are both typed singletons,
use lexicographic order on the codes for the type $-1$ elements of the third components of $X$ and $Y$ to determine their order in $S^\circ$.

\item[Observation (any support can be converted to a strong support):]  

Apply the previous result to put a $\beta$-support into a form containing only typed singletons and typed near-litters.

Augment the support by adding, wherever $((\delta,-1,L),A) \in S$ and $[L]=f_{\gamma,\delta}(y)$, the set $T^{A \setminus \{\beta\}}$, where $T$ is the designated $\gamma$-support
of $y$, to our support (and transform to a support consisting only of typed litters and typed singletons; note that a near-litter in a designated support is replaced by items preceding it in the order).

Then put the support in the order determined first by $\iota$ applied to first projections, then by any desired order on extended type indices.

The support which results will be strong by conditions we have placed on the $f$ maps and the orders on the types.  A litter precedes its elements, and
every element of $f_{\gamma,\delta}(y)$ follows all elements of the designated $\gamma$-support of $y$, however decorated with extended type indices.

\end{description}

% \begin{comment}
{\bf Note for the formal verification project:}  This should be ready to go.
% \end{comment}
\newpage
\subsection{Freedom of action of allowable permutations}

The practical application of strong supports is to the proof that allowable permutations act freely in a suitable sense, and in guiding applications of this theorem.

We claim that any locally small specification of values of derivatives of an allowable permutation at elements of type $-1$ can be realized.

We give an exact statement of what is meant, then we prove it.

\begin{description}

\item[Definition (local bijection):]  An $\alpha$-local bijection is a map $\pi^0$ whose domain is a set of pairs $(A,x)$ where $A$ is a nonempty finite subset of $\lambda$ with maximum $\alpha$ and $x$ is in type $-1$,  and whose range is a subset of $\tau_{-1}$.  To state further conditions, we introduce the notation $\pi^0_A(x) = \pi^0(A,x)$ and state the further condition that each map $\pi^0_A$ is injective and has domain the same as its range, and that the intersection of the domain of $\pi^0_A$ with any litter is small (empty being an important case of small).

\item[Definition (exception of a permutation):]  We say that $x$ is an exception of a $-1$-allowable permutation $\pi$ iff ($L$ being the litter containing $x$) either $\pi(x) \not\in (\pi``L)^\circ$ or $\pi^{-1}(x) \not\in (\pi^{-1}``L)^\circ$.  For a proper type index $\alpha$ and $\pi$ an $\alpha$-allowable permutation and $A$ an extended type index with maximum $\alpha$, we say that $(A,x)$ is an exception of $\pi$ iff
$x$ is an exception of $\pi_{A \cup \{-1\}}$.

\item[Definition:]  For each litter $L$ we define a well-ordering $\leq_L$ of order type $\kappa$ with coordinated strict well-ordering $<_L$, by providing that $$(-1,\nu,\alpha)\leq_{L_\nu} (-1,\nu,\beta)$$ if and only if $\alpha\leq \beta$.

\item[Definition:]  We define a $A$-chi map $\chi_A$ as a permutation of local cardinals $[L]$ which are not of the form $f_{\gamma,\beta}(y)$ for any $\gamma,\beta <{\tt min}(A_1)$ and $y \in \tau_\gamma$.

\item[Theorem (freedom of action):]  For any $\alpha$-local bijection $\pi^0$ 
and specification for each proper extended type index $A$ with maximum $\alpha$ of an $A$-chi map $\chi_A$,
there is an $\alpha$-allowable permutation $\pi$ such that
$\pi_{A\cup \{-1\}}$ extends $\pi^0_A$ for each $A$ and $\pi_3(\pi_A({\tt min}(A),-1,L))\in \chi_A([L])$ holds when $[L]$ is in the domain of $\chi_A$, and satisfying a further technical condition:    the permutation $\pi$ obtained from $\pi^0$ has no exceptions which are not elements of the domain of $\pi^0$.

\item[Proof of the Freedom of Action Theorem:]  We prove this by exhibiting a recursive procedure for computing $\pi$ and its derivatives along a strong support;  this succeeds because all objects have
strong supports, and because computing all values of derivatives of $\pi$ on type $-1$ allows computation of all derivatives of $\pi$ at all types.

We assume that the result holds for all $\beta<\alpha$.

We consider an item $((\beta,-1,\{x\}),A)$ and our aim is to compute $\pi_{A \cup \{-1\}}(x)$.  By hypothesis of the recursion, we have already
computed $\pi_A$ at $((\beta,-1,L),A)$, where $L$ is the litter which contains $x$.

There are two cases.  If $(A,x)$ is in the domain of $\pi^0$, we compute $\pi_{A \cup \{-1\}}(x) = \pi^0_A(x)$ and we are done.

Otherwise we use the hypothesis of the recursion:  we compute $\pi_{A \cup \{-1\}}(x)$ for any $x$ in $L$ with $(A,x)$ not in the domain of $\pi_0$ using the fact that we have already computed $\pi_A(\beta,-1,L) = (\beta,-1,N)$:  we define $\pi_{A \cup \{-1\}}$ to agree with the unique bijective map from the
elements of $L$ not in the domain of $\pi^0_A$ to the elements of $N^{\circ}$ not in the domain of $\pi^0_A$ which is strictly increasing in the sense that it sends larger objects in the sense of $<_L$ to larger objects in the sense of $<_{N^{\circ}}$.

Now we consider items of the form $((\beta,-1,L),A)$ in the strong support where $L$ is a litter.

If $[L]$ is not of the form $f_{\gamma,\beta}(y)$ for $\gamma<{\tt min}(A_1)$ and $y \in \tau_\gamma$,
we compute $\pi_A((\beta,-1,L))$ as $$(\beta,-1,\pi^0_A``L \cup (\chi_A([L])^\circ \setminus \pi^0_A``(\tau_{-1} \setminus L))):$$ we map
$L$ to the near-litter in $\chi_A([L])$ with the exact modifications required by the local bijection.

If $[L]$ is of the form $f_{\gamma,\beta}(y)$ for a $\gamma<{\tt min}(A_1)$ and $y \in \tau_\gamma$ then we proceed just as above but we take the action on $[L]$ from a different source:
the coherence condition tells us that $[L]$ should be mapped to $f_{\gamma,\beta}(\pi_{A \setminus \{\beta\} \cup \{\gamma\}}(y))$, so we compute
$\pi_A((\beta,-1,L))$ as $$(\beta,-1,\pi^0_A``L \cup (f_{\gamma,\beta}(\pi_{A \setminus \{\beta\} \cup \{\gamma\}}(y))^\circ \setminus \pi^0_A``(\tau_{-1}\setminus L))),$$  which is essentially the same idea but a bit more complex.

The nasty recursive idea here is that we already know how to compute $\pi_{A \setminus \{\beta\} \cup \{\gamma\}}(y)$ from the embedded strong $\gamma$ support of $y$ because we assume as a hypothesis of the recursion that we already know how to carry out this computation for $\gamma$-allowable permutations along $\gamma$-supports, $\gamma<\alpha$.  The  local information we need about the $\gamma$ allowable permutation $\pi_{A \setminus \{\beta\} \cup \{\gamma\}}$ (the local bijection to be used and the relevant $\chi$ maps) is included in the information we are given initially about $\pi$ (though this data will be restricted in scope and have extended type indices modified when used on the $\gamma$-support, of course:  any data involving an extended type index $A$ has $A$ replaced with $A \cap (\gamma+1)$ [and eliminated if this is empty] and applied to calculation of values of the $\gamma$-allowable permutation $\pi_{A \setminus \{\beta\} \cup \{\gamma\}}$).  Notice that we certainly do know how to do it for 0-supports, because the recursive clause will never be invoked if $\alpha=0$:  the rest of the procedure tells us what to do.

Once we know how to carry out this calculation along any $\alpha$-strong support, we can compute the derivatives of $\pi$ on elements of type $-1$  along all type paths, and so compute the value of $\pi$ and all of its derivatives on all types.  The method of calculation clearly gives an allowable permutation without exceptions other than those dictated by the local bijection.

\end{description}
% \begin{comment}
{\bf Note for the formal verification project:}  This section is vitally important and should be ready to work on (once the model and the definition of strong support are handled).  Setting up the recursive definition of the computation may be nasty.
% \end{comment}

\newpage
\subsection{Types are of size $\mu$ (so the construction actually succeeds)}

Now we argue that (given that everything worked out correctly already at lower types) each type $\alpha$ is of size $\mu$, which ensures
that the construction actually succeeds at every type.

\begin{description}

\item[Definition (coding functions):]  For any support $S$ and object $x$, we can define a function $\chi_{x,S}$ which sends $T=\pi(S)$ to $\pi(x)$ for every $T$ in the orbit of $S$ under
the action of allowable permutations.  We call such functions {\em coding functions\/}.  Note that if $\pi[S]=\pi'[S]$ then $(\pi^{-1}\circ \pi')[S]= S$, so 
$(\pi^{-1}\circ \pi')(x)= x$, so $\pi(x)=\pi'(x)$, ensuring that the map $\chi_{x,S}$ for which we gave an implicit definition is well defined.

\end{description}

The strategy of our argument for the size of the types is to show that that there are $<\mu$ coding functions for each type whose domain includes a strong support, which implies that there are no more than $\mu$ (and so exactly $\mu$) elements of each type, since every element of a type is obtainable by applying a coding function (of which there are $<\mu$) to a support (of which there are $\mu$), and every element of a type has a strong support.

\begin{description}

\item[Analysis of coding functions for type 0:]  We describe all coding functions for type 0 (without concerning ourselves about whether supports are strong).  The orbit of a 0-support in the allowable permutations is determined by the positions in the support order occupied by near-litters, and for each position in the support order occupied by a singleton, the position, if any, of the near-litter in the support order which includes it.  There are no more than $2^\kappa$ ways to specify an orbit.  Now for each such equivalence class, there is a natural partition of type $-1$ into near-litters, singletons, and a large complement set.  Notice that near-litters in the partition will be obtained by removing any singletons in the domain of the support which are included in them.  The partition has $\nu<\kappa$ elements, and there will be $2^\nu\leq 2^\kappa$ coding functions for that orbit in the supports, determined by specifying for each compartment in the partition whether it is to be included or excluded from the set computed from a support in that orbit.  So there are no more than $2^\kappa<\mu$ coding functions over type 0.

\item[Analysis of the general case:]  We specify an object $X\in \tau_\alpha$ and a strong $\alpha$-support $S$ for $X$, and develop a recipe for the coding function $\chi_{X,S}$ which can be used to see that there are $<\mu$ $\alpha$-coding functions (assuming of course that we know that things worked out correctly for $\beta<\alpha$).

$X = (\alpha,\beta,B)$, where $B$ is a subset of $\tau_\beta$.  By inductive hypothesis, each element $b$ of $B$ can be expressed as $\chi_{b,T_b}(T_b)$, where $T_b$ is a strong support for $b$ end extending $S_\beta$ (which is defined as the largest $\beta$-support $U$ such that $U^{\{\alpha\}} \subseteq S$).

We claim that $\chi_{X,S}$ can be defined in terms of the orbit of $S$ in the allowable permutations and the set of coding functions $\chi_{b,T_b}$.  There are $<\mu$ sets of type $\beta$ coding functions by inductive hypothesis, and we will argue that there are $<\mu$ orbits in the $\alpha$-strong supports under allowable permutations, so this will imply that there are $\leq \mu$ elements of type $\alpha$ (it is obvious that there are $\geq \mu$ elements of each type).
Of course we get $\leq \mu$ codes for each $\beta<\alpha$, but we know that $\lambda<\kappa<\mu$.

The definition that we claim works is that $\chi_{X,S}(U) = (\alpha,\beta,B')$, where $B'$ is the set of all $\chi_{b,T_b}(U')$ for $b \in B$ and $U'$ end extending $U_\beta$.  Clearly this definition depends only on the orbit of $S$ and the set of coding functions derived from $B$.  Before we know that this is actually the coding function desired, we will write it as $\chi_{X,S}^*$.

The function we have defined is certainly a coding function, in the sense that $\chi_{X,S}^*(\pi[S]) = \pi(\chi_{X,S}^*(S))$.  What requires work is to show that
$\chi_{X,S}^*(S)=X$, from which it follows that it is in fact the intended function.

Clearly each $b \in B$ belongs to $\chi_{X,S}(S)$ as defined, because $b = \chi_{b,T_b}(T_b)$, and $T_b$ end extends $S_\beta$.

An arbitrary $c \in \chi_{X,S}(S)$ is of the form $\chi_{b,T_b}(U)$, where $U$ end extends $S_\beta$ and of course must be in the orbit of $T_b$ under allowable permutations.

Our strategy is to show that there is an allowable permutation $\pi$ which fixes $X$ (so that $\pi_\beta``B = B$) such that $\pi_\beta[T_b]=U$, so that
$\pi_\beta(b) = c$, so $c \in B$, whence $\chi_{X,S}(S)$ as defined is equal to $X$ as required.

We build a support $S+T_b^{\{\alpha\}}$ and a support $S+U^{\{\alpha\}}$ with parallel structure by appending $T_b$ (respectively $U$) to $S$ then removing all but the first occurrence of each repeated item.  The parallelism of structure is enforced by the identity of items taken from $S \setminus S_{\beta}$
in both supports and the fact that $U$ is the image of $T_b$ under some allowable permutation.

We construct an $\alpha$-allowable permutation whose action takes one of these supports to the other, which will complete the plan given above.
For this we use the freedom of action theorem.  We define a local bijection which sends $(A,x)$ to $y$ just in case a $(\beta,A,\{x\})$ in the first support corresponds to a $(\beta,A,\{y\})$ in the other, and further enforces agreement of derivatives  of the permutation to be constructed with derivatives of the known permutation $\pi'$ sending $T_b$ to $U$ at exceptions of derivatives of $\pi'$ which lie in litters in $T_b$.  This causes singleton items in the first support to be mapped to the corresponding singleton items in the other support.  We have to argue that litters in the domain of $S+T_b^{\{\alpha\}}$ (which is a strong support) are mapped to the correct near-litters in the domain of $S+U^{\{\alpha\}}$.  If there is a failure, there is a first one.  The local cardinal of the 
first failure is treated correctly (because a support of it is treated correctly), so the failure must consist in the map constructed having an exception which is moved by the permutation into or out of the litter in question (if a litter $L$ in $T_b$ is mapped to a near-litter $N$ in $U$, all elements of $N \Delta N^\circ$ are treated correctly because they are values at exceptions of the known permutation), so a failure implies an exception of the constructed permutation lying in $L$ which is not an exception of the known map and whose singleton is not an item in $T_b$, and there are no such exceptions.

The constructed map fixes $X$ because of its identity action on $S$, and it sends $b$ to $c$ because its action sends $T_b$ to $U$, which is what we claimed.

The final move is to argue that there are $<\mu$ orbits in the $\alpha$-allowable permutations.  The idea is that the orbit in which a permutation lies
is completely determined by a certain amount of combinatorial information, similarly to what happened in type 0 but a bit more complex.  The orbit is specified if we know the second and third components of each item (taken from $\lambda$ items in each case, the first and second components of the first item, and whether the third component is a singleton or a near-litter.  If this is a singleton, we want to know the position in the support of a near-litter containing it (which will be present).  If this is a near-litter and its local cardinal is an image under an $f$ map, we can extract from information about the preceding part of the support order a subsupport which is an index-raised version of a strong support for the near-litter and so for its inverse image under the $f$ map:  as part of our specification, we take the coding function which generates that inverse image.

We give exact details.  If $S$ is a strong support (or an image of a strong support under an allowable permutation), we define
its specification $S^*$ as a well-ordering of the same length in which an item $((\beta,-1,x),A)$ will be replaced by an item 
$((\beta,-1,X),A)$ in a way that we describe.  If $x=\{y\}$, we replace $x$ with $\{\delta\}$, where $\delta$ is the position of a typed near-litter containing $y$ in the obvious sense.  If $x$ is a near litter which does not belong to any $f_{\gamma,\beta}(y)$ with $\gamma<{\tt min}(A)$, then 
$X= \emptyset$.  If $x \in f_{\gamma,\beta}(y)$ with $\gamma<{\tt min}(A)$, then we extract the maximal strong support $T$ of $y$ such that
$T^{\{\alpha\}} \subseteq S$, and set $X = \chi_{y,T}$, a coding function.

There is a straightforward argument by induction on the structure of strong supports that if we have two items with strong supports which have the same specification in the sense we have just described, there is an allowable permutation (by freedom of action) whose action sends the one support to the other, and so the one item to the other.

Suppose $S^* = T^*$:  we discuss the construction of an allowable permutation $\pi$ such that $\pi[S^*]=T^*$.  It should not be a surprise
that we construct the desired $\pi$ as an extension (as in the freedom of action theorem) of a local bijection defined by consulting the parallel structures of $S$ and $T$.  If $((\beta,-1,\{x\}),A)$ and $((\beta,-1,\{y\}),A)$ appear at corresponding positions in $S$ and $T$, we have $\pi^0$ send
$(A,x)$ to $y$.  If $((\beta,-1,M),A)$ and $((\beta,-1,N),A)$ appear at corresponding positions in $S$ and $T$ and $((\beta,-1,\emptyset),A)$ appears at the corresponding position in $S^*=T^*$, we can provide that the map $\chi_A$ used in the freedom of action construction
maps $[M]$ to $[N]$.  If $((\beta,-1,M),A)$ and $((\beta,-1,N),A)$ appear at corresponding positions in $S$ and $T$ and $((\beta,-1,\emptyset),\chi_{y,T})$ appears at the corresponding position in $S^*=T^*$,  then we know by the inductive hypothesis that everything works before this item in the support that the action of the permutation $\pi_A$ constructed so far will send $[M]$ to $[N]$.  In both near-litter cases, we need to do a little more work to ensure that $M$ is mapped exactly to $N$ without exceptions.  The idea is to extend $\pi^0_A$ so as to map each element of
$M$ which is not in $M^\circ$ to something in $N^\circ \cap N$, and each element of $M^\circ$ which is not in $M$ to something not in $N$, and do the analogous things for $(\pi^0_A)^{-1}$, and then fill in orbits, which only requires countably many atoms for each orbit [this is why we take $\kappa$ to be uncountable], with the rule that images and preimages chosen in the filling out process are chosen so as not to create exceptions (their images and preimages will agree with expected actions on near-litters in the supports, which is really action on their local cardinals, because all elements of the symmetric differences of near-litters with their corresponding litters are treated individually).  The extension of this local bijection will have exactly the desired effect.

There are clearly $<\mu$ specifications since these are small structures built with components taken from sets of size $<\mu$.  Notice the recursive dependency on the coding functions for items of lower types being taken from sets of size $<\mu$.

This completes the proof that each type is of size $\mu$, which ensures that the construction described in the first section actually succeeds.

\end{description}
% \begin{comment}
{\bf Note for the formal verification project:}  I think everything is here, but filling in details to the satisfaction of a theorem prover will be work.
% \end{comment}
\newpage
\subsection{The structure is a model of predicative TTT}

There is then a very direct proof that the structure presented is a model of predicative TTT (in which the definition of a set at a particular type may not mention any higher type).  Use $E$ for the membership relation $\in_{TTT}$ of the structure defined above.  It should be evident that $x E y \leftrightarrow \pi_\beta(x) E \pi(y)$,
where $x$ is of type $\beta$, $y$ is of type $\alpha$, and $\pi$ is an $\alpha$-allowable permutation.

Suppose that we are considering the existence of $\{x : \phi^s\}$, where $\phi$ is a formula of the language of TST with $\in$ translated as $E$, and $s$ is a strictly increasing sequence of types.  The truth value of each subformula of $\phi$ will be preserved if we replace each $x$ of type $s(i)$ with $\pi_{A_{s,i}}(x)$, where
$x=s(j)$ and $A_{s,i}$ is the set of all $s_k$ for $i \leq k \leq j+1$:  $\pi_{A_{s,i}}(x) E  \pi_{A_{s,i+1}}(y)$ is equivalent to $(\pi_{A_{s,i+1}})_{s(i)}(x) E \pi_{A_{s,i+1}}(y)$, which is equivalent to $xEy$ by the observation above. The formula $\phi$ will contain various parameters $a_i$ of types $s(n_i)$ and it is then evident that the set $\{x : \phi^s\}$ will be fixed by any $s(j+1)$-allowable permutation $\pi$ such that $\pi_{A_{s,n_i}}$ fixes $a_i$ for each $i$.  But this means that
$(s(j+1),s(j),\{x : \phi^s\})$ is symmetric and belongs to type $s(j+1)$.

This procedure will certainly work if the set definition is predicative (all bound variables are of type no higher than that of $x$, parameters at the type
of the set being defined are allowed).

There are easier proofs of the consistency of predicative tangled type theory;  there is a reason of course that we have pursued this one.

% \begin{comment}
{\bf Note for the formal verification project:}  We note that in order to avoid metamathematics, we actually suggest proving finitely many instances of comprehension with typed parameters from which the full comprehension scheme can be deduced.  That there are such finite schemes (mod the infinite sequence of types) is well-known.  For the project, a list should be provided here.
% \end{comment}

\newpage
\subsection{Impredicativity:  verifying the axiom of union}

What remains to complete the proof is that typed versions of the axiom of set union hold.  That this is sufficient is a fact about predicative type theory.
If we have predicative comprehension and union, we note that for any formula $\phi$, $\{\iota^k(x):\phi(x)\}$ will be predicative if $k$ is taken to be large enough, then application of union $k$ times to this set will give $\{x:\phi(x)\}$.  $\iota(x)$ here denotes $\{x\}$.  It is evidently sufficient to prove that unions of sets of singletons exist.

So what we need to show is that if $(\alpha,\beta,\{(\beta,\gamma,\{g\}):g \in G\})$ is symmetric, then $(\beta,\gamma,G)$ is symmetric.

Suppose that $(\alpha,\beta,\{(\beta,\gamma,\{g\}):g \in G\})$ is symmetric.  It then has a strong support $S$.  We claim that $S_\beta$ (same notion defined above) is a $\beta$-support for $(\beta,\gamma,G)$.

Suppose that $\pi[S_\beta]=S_\beta$.  

Any $g \in G$ has a strong $\gamma$-support $T_0$ which extends $(S_\beta)_\gamma$.  Extend $T_0^{\beta}$ to a strong $\beta$-support $T$.

Construct using freedom of action technology a permutation $\pi^*$ which acts as the identity on $S \setminus S_\beta$, such that $\pi^*_\beta$ agrees with $\pi$ on $S_\beta$ [so in fact $\pi^*$ will fix $(\alpha,\beta,\{(\beta,\gamma,\{g\}):g \in G\})$) and $(\pi^*_\beta)$ agrees with $\pi$ on $T$ (which implies that $(\pi^*_\beta)_\gamma$ agrees with $\pi_\gamma$ on $T_0)$, both on the orbits under $\pi$ of items in $T$ and on the orbits under $\pi$ of exceptions of derivatives of $\pi$ which are in litters in $T$.  It will follow that $\pi^*$ fixes $(\alpha,\beta,\{(\beta,\gamma,\{g\}):g \in G\})$ and that $(\pi^*_\beta)_\gamma$ has the same value as $\pi_\gamma$ at $g$, which means that $\pi_\gamma(g) \in G$ (and the same things follow for the inverse of $\pi$) which verifies that that $S_\beta$ is a $\beta$-support for $(\beta,\gamma,G)$, so the axiom of union holds in the interpreted TTT.

The application of the freedom of action theorem works because no movement of typed atoms of type $\gamma$ stipulated by the behaviour of $\pi_\gamma$ can force
movement of elements of $S \setminus S_\beta$, because this would have to be mediated by the action of $\pi$ on $S_\beta$, which fixes all elements of $S_\beta$.

Of course $T$ has to be jacked up to $T^{\{\alpha,\beta\}}$ with correlate effects on the local bijection.  Atoms in all the supports are mapped to the right places by explicit direction from the local bijection.  Exceptions in litters in the supports are mapped to the right places by fiat of the local bijection, and this induces near-litters to be mapped to the same places that
$\pi$ maps them, where we are dealing with litters of appropriate type.  All near-litters in $T$ are mapped to the correct
values and all near-litters in $S$ are mapped to the correct values, for somewhat different reasons in each case.  We need to extend $T_0^{\{\beta\}}$ to a strong support and require agreement with $\pi$ on that support, in order to get
type $\gamma$ typed near-litters in $T$ to behave correctly, but this does not create any conflicts.

% \begin{comment}
{\bf Note for formal verification project:}  This is a high level description which will probably acquire more detailed text if we get to it.  The whole idea is here, I'm not saying there is a gap.  But I have a strong suspicion that unwinding the details will induce more text.

% \end{comment}
\newpage

\section{Conclusions, extended results, and questions}
% \begin{comment}
[I have copied in the conclusions section of an older version, but what it says should be about right, 
and may require some revisions to fit in this paper.  I also added the bibliography, which again is probably approximately the right one.]
% \end{comment}

This is a rather boring resolution of the NF consistency problem.

NF has no locally interesting combinatorial consequences.   Any stratified fact about sets of a bounded standard size which holds in ZFC will continue to hold in models constructed using this strategy with the parameter $\kappa$ chosen large enough.
That the continuum can be well-ordered or that the axiom of dependent choices can hold, for example, can readily be arranged.  Any theorem about familiar objects such as real numbers which holds in ZFC can be relied upon to hold in our models
(even if it requires Choice to prove), and any situation which is possible for familiar objects is possible in models of {\em NF\/}:  for example, the Continuum Hypothesis can be true or false.  It cannot be expected that {\em NF\/} proves any strictly local stratified result about familiar mathematical objects which is not also a theorem of ZFC.

Questions of consistency with NF of global choice-like statements such as ``the universe is linearly ordered"  cannot be resolved by the method used here (at least, not without major changes).

NF with strong axioms such as the Axiom of Counting (introduced by Rosser in \cite{rosser}, an admirable textbook based on {\em NF\/}), the Axiom of Cantorian Sets (introduced in \cite{henson})  or my axioms of Small Ordinals and Large Ordinals (introduced in  my \cite{mybook} which pretends to be a set theory textbook based on {\em NFU\/}) can be obtained by choosing $\lambda$ large enough to have strong partition properties, more or less exactly as I report in my paper \cite{strongaxioms} on strong axioms of infinity in NFU:  the results in that paper are not all mine, and I owe a good deal to Solovay (unpublished conversations and \cite{nfub}).

That NF has $\alpha$-models for each standard ordinal $\alpha$ should follow by the same methods Jensen used for NFU in his original paper \cite{nfu}.   No model of NF can contain all countable subsets of its domain;  all well-typed combinatorial consequences
of closure of a model of TST under taking subsets of size $<\kappa$ will hold in our models, but the application of compactness which gets us from TST + Ambiguity to NF forces the existence of externally countable proper classes, a result which has long been known and which also holds in NFU.

We mention some esoteric problems which our approach solves.  The Theory of Negative Types of Hao Wang (TST with all integers as types, proposed in \cite{tnt})  has $\omega$-models;  an $\omega$-model of NF gives an $\omega$-model of TST immediately.  This question was open.

In ordinary set theory, the Specker tree of a cardinal is the tree in which the top is the given cardinal, the children of the top node  are the preimages of the top under the map $(\kappa \mapsto 2^{\kappa})$, and the part of the tree
below each child is the Specker tree of the child.  Forster proved using a result of Sierpinski that the Specker tree of a cardinal must be well-founded (a result which applies in ordinary set theory or in NF(U), with some finesse in the definition of the exponential map in NF(U)).  Given Choice, there is a finite bound on the lengths of the branches in any given Specker tree.  Of course by the Sierpinski result a Specker tree can be assigned an ordinal rank.  The question which was open
was whether existence of a Specker tree of infinite rank is consistent.  It is known that in NF with the Axiom of Counting the Specker tree of the cardinality of the universe is of infinite rank.  Our results in this paper can be used to show that Specker trees of infinite rank are consistent in bounded Zermelo set theory with atoms or without foundation (this takes a little work, using the way that internal type representations unfold in TTT and a natural interpretation of bounded Zermelo set theory in TST).  A bit more work definitely gets this result in ZFA, and we are confident that our permutation methods can be adapted to ZFC using forcing in standard ways to show that Specker trees of infinite rank can exist in ZF.

We believe that NF is no stronger than TST + Infinity, which is of the same strength as Zermelo set theory with separation restricted to bounded formulas.  Our work here does not show this, as we need enough Replacement for
existence of $\beth_{\omega_1}$ at least.  We leave it as an interesting further task, possibly for others, to tighten things up and show the minimal strength that we expect holds.

Another question of a very general and amorphous nature which remains is:  what do models of NF look like in general?  Are all models of NF in some way like the ones we describe, or are there models of quite a different character?  There are very special assumptions which we made by fiat in building our model of TTT which do  not seem at all inevitable in general models of this theory.

\newpage

I am not sure that all references given here will be used in this version.

\begin{thebibliography}{99}





\bibitem{forster}  Forster, T.E. [1995] 
Set Theory with a Universal Set, exploring an untyped Universe 
Second edition. Oxford Logic Guides, Oxford University Press, Clarendon Press, Oxford.

\bibitem{hailperin} Hailperin, finite axiomatization

\bibitem{henson}   Henson, C.W. [1973a] 
Type-raising operations in NF. 
Journal of Symbolic Logic 38 , pp. 59-68.

\bibitem{tangled}  Holmes, M.R.
``The equivalence of NF-style set theories with "tangled" type theories; the construction of omega-models of predicative NF (and more)". 
{\em Journal of Symbolic Logic\/} 60 (1995), pp. 178-189.

\bibitem{mybook}  Holmes, M. R. [1998] 
Elementary set theory with a universal set. 
volume 10 of the Cahiers du Centre de logique, Academia, Louvain-la-Neuve (Belgium), 241 pages, ISBN 2-87209-488-1. See here for an on-line errata slip. By permission of the publishers, a corrected text is published online; an official second edition will appear online eventually.

\bibitem{strongaxioms}   Holmes, M. R. [2001]
Strong Axioms of infinity in NFU.
Journal of Symbolic Logic, 66, no. 1, pp. 87-116.  \newline(``Errata in `Strong
Axioms of Infinity in NFU' ", JSL, vol. 66, no. 4 (December
2001), p. 1974, reports some errata and provides corrections).

\bibitem{kemeny}  Kemeny thesis on strength of TST

\bibitem{jech}  Jech, Thomas, {\em Set theory}, Academic Press 1978, pp. 199-201.

\bibitem{nfu}  Jensen, R.B.
``On the consistency of a slight(?) modification of Quine's NF". 
{\em Synthese\/} 19 (1969), pp. 250-263.

\bibitem{quinepair}  Quine on ordered pairs

\bibitem{nf}  Quine, W.V.,
``New Foundations for Mathematical Logic". 
{\em American Mathematical Monthly\/} 44 (1937), pp. 70-80. 

\bibitem{rosser}  Rosser, J. B. [1978] 
Logic for mathematicians, second edition. 
Chelsea Publishing.

\bibitem{pm1}  Russell, Principles of Mathematics

\bibitem{pm}  Russell and Whitehead, Principia Mathematica

\bibitem{scottstrick}  Scott, Dana, ``Definitions by abstraction in axiomatic set theory",  {\em Bull. Amer. Math.
Soc.}, vol. 61, p. 442, 1955.

\bibitem{nfub}  Solovay, R, ``The consistency strength of NFUB",  preprint on {\tt arXiv.org}, {\tt arXiv:math/9707207 [math.LO]}

\bibitem{notac}  Specker, E.P.
``The axiom of choice in Quine's new foundations for mathematical logic". 
{\em Proceedings of the National Academy of Sciences of the USA\/} 39 (1953), pp. 972-975.

\bibitem{ambiguity}  Specker, E.P. [1962] 
``Typical ambiguity". 
{\em Logic, methodology and philosophy of science\/}, ed. E. Nagel, Stanford University Press, pp. 116-123.

\bibitem{tarskiontst}  Tarski, first description of TST

\bibitem{tnt}  Wang, H. [1952] 
Negative types.

\bibitem{wiener}  Wiener, Norbert, paper on Wiener pair


\end{thebibliography}












\end{document}