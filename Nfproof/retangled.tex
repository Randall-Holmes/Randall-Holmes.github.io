\documentclass[112pt]{article}

\usepackage{amssymb}

\usepackage{comment}

\title{New Foundations is consistent}

\author{M. Randall Holmes}

\begin{document}

\maketitle

\tableofcontents

\newpage

% \begin{comment}

\newpage

\section{Remarks on this version}

This document is probably my best overall version so far.  The immediate occasion for its preparation is to serve students attempting to verify the proof in Lean.  As we have discussed, the formal verification should at least initially avoid metamathematics, so it is the fact that the structure defined in section 3 is a model of TTT which should be verified, and further, a finite axiomatization (mod type indexing) of TST and thus TTT should be verified in the model in lieu of the usual statement of the axiom of comprehension of TTT.

\subsection{Version updates}

\begin{description}

\item[8/8/2022, pre-release:]  Translating into a different framework and correcting an omission in the definition of dependencies of conditions.  At this point a large block of material in section 4 remains to be translated into the new framework and checked for problems with the $\gamma = -1$ fix.

\end{description}

% \end{comment}

\section{Development of relevant theories}

\subsection{The simple theory of types TST and TSTU}

We introduce a theory which we call the simple typed theory of sets or TST, a name favored by the school of Belgian logicians who studied NF ({\em th\'eorie simple des types}).  This is not the same as the simple type theory of Ramsey and it is most certainly not Russell's type theory  (see historical remarks below).

TST is a first order multi-sorted theory with sorts (types) indexed by the nonnegative integers.  The primitive predicates of TST are equality and membership.

The type of a variable $x$ is written ${\tt type}($`$x$'$)$:  this will be a nonnegative integer.   A countably infinite supply of variables of each type is supposed.  An atomic equality sentence `$x=y$' is well-formed iff ${\tt type}($`$x$'$)={\tt type}($`$y$'$)$.
An atomic membership sentence `$x \in y$' is well-formed iff ${\tt type}$`$(x$'$)+1 = {\tt type}($`$y$'$)$.

The axioms of TST are extensionality axioms and comprehension axioms.

The extensionality axioms are all the well-formed assertions of the shape $(\forall xy:x=y \leftrightarrow (\forall z:z \in x \leftrightarrow z\in y))$.  For this to be well typed, the variables
$x$ and $y$ must be of the same type, one type higher than the type of $z$.

The comprehension axioms are all the well-formed assertions of the shape $(\exists A:(\forall x:x \in A \leftrightarrow \phi))$, where $\phi$ is any formula in which $A$ does not occur free.

The witness to $(\exists A:(\forall x:x \in A \leftrightarrow \phi))$ is unique by extensionality, and we introduce the notation $\{x:\phi\}$ for this object.  Of course, $\{x:\phi\}$  is to be assigned type one higher than that of $x$;  in general, term constructions will have types as variables do.

The modification which gives TSTU (the simple type theory of sets with urelements) replaces the extensionality axioms with the formulas of the shape $$(\forall xyw:w \in x \rightarrow (x=y \leftrightarrow (\forall z:z \in x \leftrightarrow z\in y))),$$  allowing many objects with no elements (called atoms or urelements)  in each positive type.  A technically useful refinement adds a constant $\emptyset^i$ of each positive type $i$ with no elements:  we can then address the problem that $\{x^i:\phi\}$ is not uniquely defined when $\phi$ is uniformly false by defining $\{x^i:\phi\}$ as $\emptyset^{i+1}$ in this case.

\subsubsection{Typical ambiguity}

TST(U) exhibits a symmetry which is important in the sequel.

Provide a bijection $(x \mapsto x^+)$ from variables to variables of positive type satisfying   ${\tt type}(x^+)$ = ${\tt type}(x)+1$.

If $\phi$ is a formula, define $\phi^+$ as the result of replacing every variable $x$ (free and bound) in $\phi$ with $x^+$ (and occurrences of $\emptyset^i$ with $\emptyset^{i+1}$ if this is in use).   It should be evident that if $\phi$ is well-formed, so is $\phi^+$,
and that if $\phi$ is a theorem, so is $\phi^+$ (the converse is not the case).  Further, if we define a mathematical object as a set abstract $\{x:\phi\}$ we have an analogous
object $\{x^+:\phi^+\}$ of the next higher type (this process can be iterated).

The axiom scheme asserting $\phi \leftrightarrow \phi^+$ for each closed formula $\phi$ is called the Ambiguity Scheme.   Notice that this is a stronger assertion than is warranted by the symmetry of proofs described above.

\subsubsection{Historical remarks}

TST is not the type theory of the {\em Principia Mathematica\/} of Russell and Whitehead (\cite{pm}), though a description of TST is a common careless description of Russell's theory of types.

Russell described something like TST informally in his 1904 {\em Principles of Mathematics\/} (\cite{pm1}).  The obstruction to giving such an account in {\em Principia Mathematica\/} was that
Russell and Whitehead did not know how to describe ordered pairs as sets.  As a result, the system of {\em Principia Mathematica\/} has an elaborate system of  complex
types inhabited by $n$-ary relations with arguments of specified previously defined types, further complicated by predicativity restrictions (which are cancelled by an axiom of reducibility).
The simple theory of types of Ramsey eliminates the predicativity restrictions and the axiom of reducibility, but is still a theory with complex types inhabited by $n$-ary relations.

Russell noticed a phenomenon like the typical ambiguity of TST in the more complex system of {\em Principia Mathematica\/}, which he refers to as ``systematic ambiguity".

In 1914 (\cite{wiener}), Norbert Wiener gave a definition of the ordered pair as a set (not the one now in use) and seems to have recognized that the type theory of {\em Principia Mathematica\/} could be simplified to something like TST, but he did not give a formal description.  The theory we call TST was apparently first described by Tarski in 1930 (\cite{tarskiontst}).

It is worth observing that the axioms of TST look exactly like those of ``naive set theory", the restriction preventing paradox being embodied in the restriction of the language by the type system.
For example, the Russell paradox is averted because one cannot have $\{x:x \not\in x\}$ because $x \in x$ (and so its negation $\neg x \in x$) cannot be a well-formed formula.

It was shown around 1950 (in \cite{kemeny}) that Zermelo set theory proves the consistency of TST with the axiom of infinity;  TST + Infinity has the same consistency strength as
Zermelo set theory with separation restricted to bounded formulas.


\newpage

\subsection{Some mathematics in TST;  the theories TST$_n$ and their natural models}

We briefly discuss some mathematics in TST.

We indicate how to define the natural numbers.  We use the definition of Frege ($n$ is the set of all sets with $n$ elements).  0 is $\{\emptyset\}$ (notice that we get a natural number 0 in each type $i+2$;  we will be deliberately ambiguous in this discussion, but we are aware that anything we define is actually not unique, but reduplicated in each type above the lowest one in which it can be defined).  For any set $A$ at all we define $\sigma(A)$ as $\{a \cup \{x\}:a \in A \wedge x \not\in a\}$.  This is definable for any $A$ of type $i+2$ ($a$ being of type $i+1$ and $x$ of type $i$).  Define 1 as $\sigma(0)$, 2 as $\sigma(1)$,  3 as $\sigma(2)$, and so forth.  Clearly we have successfully defined 3 as the set of all sets with three elements, without circularity.
But further, we can define $\mathbb N$ as $\{n:(\forall I:0 \in I \wedge (\forall x \in I:\sigma(x) \in I) \rightarrow n \in I\}$, that is, as the intersection of all inductive sets.
$\mathbb N$ is again a typically ambiguous notation:  there is an object defined in this way in each type $i+3$.

The collection of all finite sets can be defined as $\bigcup \mathbb N$.  The axiom of infinity can be stated as $V \not\in \bigcup \mathbb N$ (where $V= \{x:x=x\}$ is the typically ambiguous symbol for the type $i+1$ set of all type $i$ objects).  It is straightforward to show that the natural numbers in each type of a model of TST with Infinity are isomorphic in a way representable in the theory.

Ordered pairs can be defined following Kuratowski and a quite standard theory of functions and relations can be developed.  Cardinal and ordinal numbers can be defined as Frege or Russell would have defined them, as isomorphism classes of sets under equinumerousness and isomorphism classes of well-orderings under similarity.  

The Kuratowski pair $(x,y) = \{\{x\},\{x,y\}\}$ is of course two types higher than its projections, which must be of the same type.  There is an alternative definition (due to Quine in \cite{quinepair}) of an ordered pair
$\left< x,y\right>$ in TST + Infinity which is of the same type as its projections $x,y$.  This is a considerable technical convenience but we will not need to define it here.  Note for example that if we use the Kuratowski pair the cartesian product $A \times B$ is two types higher than $A,B$, so we cannot define $|A| \cdot |B|$ as $|A \times B|$ if we want multiplication of cardinals to be a sensible operation.  Let $\iota$ be the singleton operation and define $T(|A|)$ as $|\iota``A|$ (this is a very useful operation sending cardinals of a given type to cardinals in the next higher type which seem intuitively to be the same).  The definition of cardinal multiplication if we use the Kuratowski pair is then $|A| \cdot |B| =T^{-2}(|A\times B|)$.  If we use the Quine pair this becomes the usual definition $|A| \cdot |B| =|A\times B|$.  Use of the Quine pair simplifies matters in this case, but it should be noted that the T operation remains quite important (for example it provides the internally representable isomorphism between the systems of natural numbers in each sufficiently high type).

Note that the form of Cantor's Theorem in TST is not $|A| < |{\cal P}(A)|$, which would be ill-typed, but $|\iota``A|<|{\cal P}(A)|$:  a set has fewer unit subsets than subsets.  The exponential map $\exp(|A|) = 2^{|A|}$ is not defined as $|{\cal P}(A)|$, which would be one type too high, but as $T^{-1}(|{\cal P}(A))$, the cardinality of a set $X$ such that $|\iota``X| = |{\cal P}(A)|$;   notice that this is partial.  For example
$2^{|V|}$ is not defined (where $V=\{x:x=x\}$, an entire type), because there is no $X$ with $|\iota``X|=|{\cal P}(V)|$, because $|\iota``V|<|{\cal P}(V)| \leq |V|$, and of course there is no set larger than $V$ in its type.

For each natural number $n$, the theory TST$_n$ is defined as the subtheory of TST with vocabulary restricted to use variables only of types less than $n$ (TST with $n$ types).
In ordinary set theory TST and each theory TST$_n$ have natural models, in which type 0 is implemented as a set $X$ and each type $i$ in use is implemented as ${\cal P}^i(X)$.  It should be clear that each TST$_n$ has natural models in bounded Zermelo set theory, and TST has natural models in a modestly stronger fragment of ZFC.

Further, each TST$_n$ has natural models in TST itself, though some care must be exercised in defining them.  Let $X$ be a set.  Implement type $i$ for each $i<n$ as
$\iota^{(n-1)-i}``{\cal P}^i(X)$.  If $X$ is in type $j$, each of the types of this interpretation of TST$_n$ is a set in the same type $j+n-1$.  For any relation $R$, define
$R^{\iota}$ as $\{(\{x\},\{y\}):x R y\}$.  The membership relation of type $i-1$ in type $i$ in the interpretation described is the restriction of $\subseteq^{\iota^{(n-1)-i}}$ to
the product of the sets implementing type $i-1$ and type $i$.

Notice then that we can define truth for formulas in these natural models of TST$_n$ for each $n$ in TST, though not in a uniform way which would allow us to define truth for formulas
in TST in TST.

Further, both in ordinary set theory and in TST, observe that truth of sentences in natural models of TST$_n$ is completely determined by the cardinality of the set used as type 0.
since two natural models of TST or TST$_n$ with base types implemented by sets of the same cardinality are clearly isomorphic. 

\newpage

\subsection{New Foundations and NFU}

In \cite{nf}, 1937, Willard van Orman Quine proposed a set theory motivated by the typical ambiguity of TST described above.  The paper in which he did this was titled ``New foundations for mathematical logic", and the set theory it introduces is called ``New Foundations" or NF, after the title of the paper.

Quine's observation is that since any theorem $\phi$ of TST is accompanied by theorems $\phi^+, \phi^{++}, \phi^{+++}, \ldots$ and every defined object $\{x:\phi\}$ is accompanied by
$\{x^+:\phi^+\},\{x^{++}:\phi^{++}\},\{x^{+++}:\phi^{+++}\}$, so the picture of what we can prove and construct in TST looks rather like a hall of mirrors, we might reasonably suppose that the types are all the same.

The concrete implementation follows.  NF is the first order unsorted theory with equality and membership as primitive with an axiom of extensionality $(\forall xy:x=y \leftrightarrow (\forall z:z \in x \leftrightarrow z\in y))$ and an axiom of comprehension $(\exists A:(\forall x:x \in A \leftrightarrow \phi))$ for each formula $\phi$ in which $A$ is not free which can be obtained from a formula of TST by dropping all distinctions of type.  We give a precise formalization of this idea:  provide a bijective map $(x \mapsto x^*)$ from the countable supply of variables (of all types) of TST onto the countable supply of variables of the language of NF.  Where $\phi$ is a formula of the language of TST, let $\phi^*$ be the formula obtained by replacing every veriable $x$, free and bound,
in $\phi$ with $x^*$. For each formula $\phi$ of the language of TST in which $A$ is not free in $\phi^*$ and each variable $x^*$, an axiom of comprehension of NF asserts $(\exists A:(\forall x^*:x^* \in A \leftrightarrow \phi^*))$.

In the original paper, this is expressed in a way which avoids explicit dependence on the language of another theory.  Let $\phi$ be a formula of the language of
NF.  A function $\sigma$ is a stratification of $\phi$ if it is a (possibly partial) map from variables to non-negative integers such that for each atomic subformula
`$x=y$'  of $\phi$ we have $\sigma($`$x$'$)=\sigma($`$y$'$)$ and for each atomic subformula `$x \in y$' of $\phi$ we have $\sigma($`$x$'$)+1 = \sigma($`$y$'$)$.
A formula $\phi$ is said to be stratified iff there is a stratification of $\phi$.  Then for each stratified formula $\phi$ of the language of NF and variable $x$ we have an axiom $(\exists A:(\forall x:x \in A \leftrightarrow \phi))$.  The stratified formulas are exactly the formulas $\phi^*$ up to renaming of variables.

NF has been dismissed as a ``syntactical trick" because of the way it is defined.  It might go some way toward dispelling this impression to note that the stratified comprehension scheme is equivalent to a finite collection of its instances, so the theory can be presented in a way which makes no reference to types at all.  This is a result of Hailperin (\cite{hailperin}), refined by others.  One obtains a finite axiomatization of NF by analogy with the method of finitely axiomatizing von Neumann-G\"odel-Bernays predicate class theory.  It should further be noted that the first thing one does with the finite axiomatization is prove stratified comprehension as a meta-theorem, in practice, but it remains significant that the theory can be axiomatized with no reference to types at all.

For each stratified formula $\phi$, there is a unique witness to $$(\exists A:(\forall x:x \in A \leftrightarrow \phi))$$ (uniqueness follows by extensionality) whch we denote by $\{x:\phi\}$.

Jensen in \cite{nfu}, 1969 proposed the theory NFU which replaces the extensionality axiom of NF with $$(\forall xyw:w \in x \rightarrow (x=y \leftrightarrow (\forall z:z \in x \leftrightarrow z\in y))),$$  allowing many atoms or urelements.  One can reasonably add an elementless constant $\emptyset$, and define $\{x:\phi\}$ as $\emptyset$ when $\phi$ is false for all $x$.

Jensen showed that NFU is consistent and moreoever NFU + Infinity + Choice is consistent.  We will give an argument similar in spirit though not the same in detail for the consistency of NFU in the next section.

An important theorem of Specker (\cite{ambiguity}, 1962) is that NF is consistent if and only if TST + the Ambiguity Scheme is consistent.  His method of proof adapts to show that  NFU is consistent if and only if TSTU + the Ambiguity Scheme is consistent.  Jensen used this fact in his proof of the consistency of NFU.  We indicate a proof of Specker's result using concepts from this paper below.

In \cite{notac}, 1954, Specker had shown that NF disproves Choice, and so proves Infinity.  At this point if not before it was clear that there is a serious issue of showing that NF is consistent relative to some set theory in which we have confidence.  There is no evidence that NF is any stronger than TST + Infinity, the lower bound established by Specker's result.

Note that NF or NFU supports the implementation of mathematics in the same style as TST, but with the representations of mathematical concepts losing their ambiguous character.  The number 3 really is realized as the unique set of all sets with three elements, for example.  The universe is a set and sets make up a Boolean algebra.   Cardinal and ordinal numbers can be defined
in the manner of Russell and Whitehead.

The apparent vulnerability to the paradox of Cantor is an illusion.  Applying Cantor's theorem to the cardinality of the universe in NFU gives $|\iota``V| < |{\cal }(V)| \leq |V|$ (the last inequality would be an equation in NF), from which we conclude that there are fewer singletons of objects than objects in the universe.  The operation $(x \mapsto \{x\})$ is not a set function, and there is every reason to expect it not to be, as its definition is unstratified.  The resolution of the Burali-Forti paradox is also weird and wonderful in NF(U), but would take us too far afield.

\newpage

\subsection{Tangled type theory TTT and TTTU}

In \cite{tangled}, 1995, this author described a reduction of the NF consistency problem to consistency of a typed theory,  motivated by reverse engineering from Jensen's method of proving the consistency of NFU.

Let $\lambda$ be a limit ordinal.  It can be $\omega$ but it does not have to be.  

In the theory TTT (tangled type theory) which we develop, each variable $x$ is supplied with a type ${\tt type}($`$x$'$) <\lambda$;  we are provided with countably many distinct variables of each type.

For any formula $\phi$ of the language of TST and any strictly increasing sequence $s$ in $\lambda$, let $\phi^s$ be the formula obtained by replacing each variable
of type $i$ with a variable of type $s(i)$.  To make this work rigorously, we suppose that we have a bijection from type $i$ variables of the language of TST to type $\alpha$ variables
of the language of TTT for each natural number $i$ and ordinal $\alpha<\lambda$.

TTT is then the first order theory with types indexed by the ordinals below $\lambda$ whose well formed atomic sentences `$x=y$' have ${\tt type}($`$x$'$) = {\tt type}($`$y$'$)$ and whose atomic sentences `$x \in y$' satisfy ${\tt type}($`$x$'$) < {\tt type}($`$y$'$)$, and whose axioms are the sentences $\phi^s$ for each axiom $\phi$ of TST and each strictly increasing sequence $s$ in $\lambda$.  TTTU has the same relation to TSTU (with the addition of constants $\emptyset^{\alpha,\beta}$ for each $\alpha<\beta<\lambda$  such that $(\forall {\bf x}_0^{\alpha} :{\bf x}_0^{\alpha}\not\in \emptyset^{\alpha,\beta})$ is an axiom).

It is important to notice how weird a theory TTT is.  This is not cumulative type theory.  Each type $\beta$ is being interpreted as a power set of {\em each\/} lower type $\alpha$.  Cantor's theorem in the metatheory makes it clear that most of these power set interpretations cannot be honest.

There is now a striking

\begin{description}

\item[Theorem (Holmes):]  TTT(U) is consistent iff NF(U) is consistent.

\item[Proof:]  Suppose NF(U) is consistent.  Let $(M,E)$ be a model of NF(U) (a set $M$ with a membership relation $E$).  Implement type $\alpha$ as $M \times \{\alpha\}$ for
each $\alpha<\lambda$.  Define $E_{\alpha,\beta}$ for $\alpha<\beta$ as $\{((x,\alpha),(y,\beta)):xEy\}$.  This gives a model of TTT(U).   Empty sets in TTTU present no essential additional difficulties.

Suppose TTT(U) is consistent, and so we can assume we are working with a fixed model of TTT(U).  Let $\Sigma$ be a finite set of sentences in the language of TST(U).  Let $n$ be the smallest type such that no type $n$ variable occurs in any sentence in $\Sigma$.  We define a partition of the $n$-element subsets of $\lambda$.  Each $A \in [\lambda]^n$ is put in a compartment
determined by the truth values of the sentences $\phi^s$ in our model of TTT(U), where $\phi \in \Sigma$ and ${\tt rng}(s \lceil \{0,\ldots,n-1\}) = A$.  By Ramsey's theorem, there is a homogeneous set $H \subseteq \lambda$ for this partition, which includes the range of a strictly increasing sequence $h$.  There is a complete extension of TST(U) which includes
$\phi$ iff the theory of our model of TTT(U) includes $\phi^h$.  This extension satisfies $\phi \leftrightarrow \phi^+$ for each $\phi \in \Sigma$.  But this implies by compactness that the full Ambiguity Scheme $\phi \leftrightarrow \phi^+$ is consistent with TST(U), and so that NF(U) is consistent by the 1962 result of Specker.

We note that we can give a treatment of the result of Specker (rather different from Specker's own) using TTT(U).  Note that it is easy to see that if we have a model of TST(U) augmented with a Hilbert symbol (a primitive term construction $(\epsilon x:\phi)$ (same type as $x$) with axiom scheme $\phi[(\epsilon x:\phi)/x] \leftrightarrow (\exists x:\phi)$) which cannot appear in instances of comprehension (the quantifiers are not defined in terms of the Hilbert symbol, because they do need to appear in instances of comprehension) and Ambiguity (for all formulas, including those which mention the Hilbert symbol) then we can readily get a model of NF, by constructing a term model using the Hilbert symbol in the natural way, then identifying all terms with their type-raised versions.  All statements in the resulting type-free theory can be decided by raising types far enough (the truth value of an atomic sentence $(\epsilon x:\phi) \,R\, (\epsilon y:\psi)$ in the model of NF is determined by raising the type of both sides (possibly by different amounts) until the formula is well-typed in TST and reading the truth value of the type raised version;  $R$ is either = or $\in$).  Now observe that a model of TTT(U) can readily be equipped with a Hilbert symbol if this creates no obligation to add instances of comprehension
containing the Hilbert symbol (use a well-ordering of the set implementing each type to interpret a Hilbert symbol  $(\epsilon x:\phi)$ in that type as the first $x$ such that $\phi$), and the argument above for consistency of TST(U) plus Ambiguity with the Hilbert symbol goes through.

\item[Theorem (essentially due to Jensen):]  NFU is consistent.

\item[Proof:]  It is enough to exhibit a model of TTTU.  Suppose $\lambda>\omega$.  Represent type $\alpha$ as $V_{\omega+\alpha} \times \{\alpha\}$ for each $\alpha<\lambda$ ($V_{\omega+\alpha}$ being a rank of the usual cumulative hierarchy).  Define $\in_{\alpha,\beta}$ for
$\alpha<\beta<\lambda$ as $$\{((x,\alpha),(y,\beta)):x \in V_{\omega+\alpha} \wedge y \in V_{\omega+\alpha+1} \wedge x \in y\}.$$  This gives a model of TTTU in which the membership of
type $\alpha$ in type $\beta$ interprets each $(y,\beta)$ with $y \in V_{\omega+\beta} \setminus V_{\omega+\alpha+1}$ as an urelement.

Our use of $V_{\omega+\alpha}$ enforces Infinity in the resulting models of NFU (note that we did not have to do this:  if we set $\lambda=\omega$ and interpret type $\alpha$ using $V_\alpha$ we prove the consistency of NFU with the negation of Infinity).  It should be clear that Choice holds in the models of NFU eventually obtained if it holds in the ambient set theory.

This shows in fact that mathematics in NFU is quite ordinary (with respect to stratified sentences), because mathematics in the models of TSTU embedded in the indicated model of TTTU is quite ordinary.  The notorious ways in which NF evades the paradoxes of Russell, Cantor and Burali-Forti can be examined in actual models and we can see that they work and how they work (since they work in NFU in the same way they work in NF).

\end{description}

Of course Jensen did not phrase his argument in terms of tangled type theory.  Our contribution here was to reverse engineer from Jensen's original argument for the consistency of NFU an argument for the consistency of NF itself, which requires additional input which we did not know how to supply (a proof of the consistency of TTT itself).  An intuitive way to say what is happening here is that Jensen noticed that it is possible to skip types in a certain sense in TSTU in a way which is not obviously possible in TST itself;  to suppose that TTT might be consistent is to suppose that such type skipping is also possible in TST.

\newpage



\subsubsection{How internal type representations unfold in TTT}

We have seen above that TST can internally represent TST$_n$.   An attempt to represent types of TTT internally to TTT has stranger results.  The development of the model does not depend on reading this section.

In TST the strategy for representing type $i$ in type $n\geq i$  is to use the $n-i$-iterated singleton of any type $i$ object $x$ to represent $x$;  then membership of representations of type $i-1$ objects in type
$i$ objects is represented by the relation on $n-i$-iterated singletons induced by the subset relation and with domain restricted to $n-(i+1)$-fold singletons.  This is described more formally above.

In TTT the complication is that there are numerous ways to embed type $\alpha$ into type $\beta$ for $\alpha<\beta$ along the lines just suggested.    We define a generalized
iterated singleton operation:  where $A$ is a finite subset of $\lambda$, $\iota_A$ is an operation defined on objects of type ${\tt min}(A)$.  $\iota_{\{\alpha\}}(x)=x$.
If $A$ has $\alpha<\beta$ as its two smallest elements, $\iota_A(x)$ is  $\iota_{A_1}(\iota_{\alpha,\beta}(x))$, where $A_1$ is defined as $A \setminus \{{\tt min}(A)\}$ (a notation we will continue to use) and $\iota_{\alpha,\beta}(x)$ is the unique type $\beta$ object whose only type $\alpha$ element is $x$.

Now for any nonempty finite $A \subseteq \lambda$ with minimum $\alpha$ and maximum $\beta$. the range of $\iota_A$ is a set, and a representation of type $\alpha$ in
type $\beta$.  For simplicity we carry out further analysis in types $\beta, \beta+1,\beta+2\ldots$ though it could be done in more general increasing sequences.  Use the notation
$\tau_A$ for the range of $\iota_A$, for each set $A$ with $\beta$ as its maximum.  Each such set has a cardinal $|\tau_A|$ in type $\beta+2$.  It is a straightforward
argument in the version of TST with types taken from $A$ and a small finite number of types $\beta+i$ that $2^{|\tau_A|} = |\tau_{A_1}|$ for each $A$ with at least two elements.
The relevant theorem in TST is that $2^{|\iota^{n+1}``X|} = \iota^n``X$, relabelled with suitable types from $\lambda$.   We use the notation $\exp(\kappa)$ for $2^\kappa$ to support iteration.  Notice that for any $\tau_A$ we have $\exp^{|A|-1}(|\tau_A|) = |\tau_{\{\beta\}}|$, the cardinality of type $\beta$.  Now if $A$ and $A'$ have the same minimum $\alpha$ and maximum $\beta$ 
but are of different sizes, we see that $|\tau_A| \neq |\tau_{A'}|$, since one has its $|A|-1$-iterated exponential equal to $|\tau_{\{\beta\}}|$ and the other has its $|A'|-1$-iterated exponential equal to $|\tau_{\{\beta\}}|$.  This is odd because there is an obvious external bijection between the sets $\tau_A$ and $\tau_{A'}$:  we see that this external bijection cannot be realized as a set.  $\tau_A$ and $\tau_{A'}$ are representations of the same type, but this is not obvious from inside TTT.  We recall that we denote $A \setminus \{{\tt min}(A)\}$ by $A_1$;  we further denote $(A_i)_1$ as $A_{i+1}$.  Now suppose that $A$ and $B$ both have maximum $\beta$ and $A \setminus A_i = B \setminus B_i$, where $i<|A| \leq |B|$.
We observe that for any concrete sentence $\phi$  in the language of TST$_i$, the truth value of $\phi$ in natural models with base type of sizes $|\tau_A|$ and $|\tau_B|$ will be the same, because the truth values we read off are the truth values in the model of TTT of versions of $\phi$ in exactly the same types of the model (truth values of $\phi^s$ for
any $s$ having $A \setminus A_i = B\setminus B_i$ as the range of an initial segment).  This much information telling us that $\tau_{A_j}$ and $\tau_{B_j}$ for $j<i$ are representations of the same type  is visible to us internally, though the external isomorphism is not.  We can conclude that the full first-order theories of natural models of TST$_i$ with base types $|\tau_A|$ and $|\tau_B|$ are
the same as seen inside the model of TTT, if we assume that the natural numbers of our model of TTT are standard.

\newpage

\subsubsection{Tangled webs of cardinals:  a suggestion of another approach not followed here}

Nothing in the construction of a model of tangled type theory and verification that it is a model which appears below depends on anything in this section.

It is straightforward to transform a model of TST into a model of bounded Zermelo set theory (Mac Lane set theory) with atoms or without foundation
(this depends on how type 0 is handled).  Specify an interpretation of type 0 either as a set of atoms or a set of self-singletons.  Then interpret
type $i+1$ as inhabited by sets of type $i$ objects in the obvious way, identifying type $i+1$ objects with objects of lower type which happen to have been assigned the same extension.

In a model of TTT, do this along some increasing sequence of types of order type $\omega$ whose range includes an infinite ordinal $\alpha$.  In the resulting model of bounded Zermelo set theory,
let $\tau_A$ represent the cardinality of the range of $\iota_A$ as in the previous discussion (for nonempty subsets of type $A$ all with maximum the same infinite $\alpha$).  Suppose further for the sake of argument that our model of TTT is $\lambda$-complete, in the sense that any subset of a type of cardinality that of $\lambda$ or less is implemented as a set in each higher type.
It will follow that $A \mapsto \tau_A$ is actually a function. [It is an incidentally interesting fact that the models we construct (with no dependence on this section) actually have this completeness property].

We describe the situation which holds for these cardinals.  

We work in Mac Lane set theory.  Choice is not assumed, and we use the Scott definition of cardinals.

\begin{description}

\item[Definition:]  If $A$ is a nonempty finite set of ordinals which is sufficiently large, we define $A_1$ as $A \setminus {\tt min}(A)$ and $A_0$ as $A$, $A_{i+1}$ as $(A_i)_1$.

\item[Definition:]  A tangled web of cardinals of order $\alpha$ (an infinite ordinal) is a function $\tau$ from the set of nonempty sets of ordinals with $\alpha$ as maximum
to cardinals such that

\begin{enumerate}

\item  If $|A|>1$, $\tau(A_1) = 2^{\tau(A)}$.

\item  If $|A|\geq n$, the first order theory of a natural model of TST$_n$ with base type $\tau(A)$ is completely determined by $A \setminus A_n$, the
$n$ smallest elements of $A$.

\end{enumerate}

The bookkeeping in different versions of this definition in different attempts at a tangled web version of the proof of the consistency of NF have been different (an obvious point about the version given here is that the top ordinal $\alpha$ could be omitted).  Another remark is that it is clear that asserting the existence of a tangled web is stronger than simple TTT:  it requires $\lambda>\omega$, and the $\lambda$-completeness of course is a strong assumption in the background.  All variants that I have used support versions of the following

\item[Theorem:]  If there is a model of Mac Lane set theory in which there is a tangled web of cardinals $\tau$, then NF is consistent.

\item[Proof:]  Let $\Sigma$ be a finite set of sentences of the language of TST.  Let $n$ be larger than any type mentioned in any formula in $\Sigma$.
Partition $[\alpha]^n$ into compartments in such a way that the compartment that a set $A$ is put into depends on the truth values of the sentences in $\Sigma$ in natural models of TST$_n$  with base type of size $\tau(B)$ where $B \setminus B_n=A$.  This partition of $[\alpha]^n$ into no more than
$2^{|\Sigma|}$ compartments has a homogeneous set $H$ of size $n+1$.  The natural models of TST$_n$ with base types of size $\tau(H)$ and base
types of size $\tau(H_1)$ have the same truth values for sentences in $\Sigma$, so the model of TST with base type $\tau(H)$ satisfies the restriction of the Ambiguity Scheme to $\Sigma$, so the full Ambiguity Scheme is consistent by compactness, so TST + Ambiguity is consistent so NF is consistent.


\end{description}

Our initial approach to proving our theorem was to attempt a Frankel-Mostowski construction of a model of Mac Lane set theory with a tangled web of cardinals.  We do know how to do this, but we believe from experience that constructing a model of tangled type theory directly is easier, though tangled type theory is a nastier theory to describe.

We think there is merit in giving a brief description of a situation in a more familiar set theory equivalent to (a strengthening of) the very strange situation in a model of tangled type theory.  This section is also useful here because it supports the discussion in the conclusion of one of the unsolved problems which is settled by this paper.

\newpage




\section{The model description}


In this section we give a complete description of what we claim is a model of tangled type theory.  Our metatheory is some fragment of ZFC.


\begin{description}
\item[Abstract considerations about types; the system of supertypes defined:]  Types are indexed by a well-ordering $\leq_\tau$ (from which we define a strict well-ordering $<_\tau$ in the obvious way).
We refer to elements of the domain of $\leq_\tau$ as ``type indices".

We first define a system of ``supertypes" (using the same type labels).

For each element $t$ of ${\tt dom}(\leq_\tau)$ we will define a set $\tau^*_t$, called supertype $t$.

If $m$ is the minimal element of the domain of $\leq$, we choose a set $\tau^*_m$ as supertype $m$.

$\leq_\tau$ and $\tau^*_m$ are the only parameters of the system of supertypes (which is not a model of TTT, but a sort of maximal structure for the language of TTT).

We describe the construction of $\tau^*_t$, assuming that $t \in {\tt dom}(\leq_\tau)$ and $t \neq m$ and for all $u <_\tau t$, we have
defined $\tau^*_u$.

We define $\tau^*_t$ as $$\{X \cup \{\{\tau^*_u:u <_\tau t\}\}:X \subseteq \bigcup_{u <_\tau t}\tau^*_u\}.$$

An element of supertype $t$ is a subset of the union of all lower types, with $t^+ = \{\tau^*_u:u <_\tau t\}$ added as an element.

Notice that the axiom of foundation in the metatheory ensures that an element of supertype $t$ cannot be an element of any lower type,
so the types are disjoint (elements of each type being labelled by having the set of all lower types as an element).

The membership relations of this structure are transparent:  $x \in_{t,u} y$ ($t <_\tau u$) is defined as
$x \in \tau^*_t \wedge y \in \tau^*_u \wedge x \in y$.

The system of supertypes is certainly not a model of TTT, because it does not satisfy extensionality.  It is easy to construct
many sets in a higher type with the same extension over a given lower type, by modifying the other extensions of the object of higher type.

The system of supertypes does satisfy the comprehension scheme of TTT.  One can use Jensen's method to construct a model of stratified comprehension with no extensionality axiom using the system of supertypes, which interprets NFU in a manner described by Marcel Crabb\'e.

\item[the generality of the system of supertypes:]  We show that any model of TTT (assuming there are any) will be isomorphic to a substructure of a system of supertypes.

Let $M$ be a model of TTT (more generally, any structure for the language of TTT in which each object is determined given all of its extensions).  Let $\leq_M$ be the well-ordering on the types of $M$ and let $m$ be the minimal type of $M$.  We will assume as above that $\leq_\tau$ is a well-ordering of type labels $t$ with corresponding actual types $\tau_t$ of $M$:  of course, we could use the actual types of $M$ as type indices, but we preserve generality this way.  

We consider the supertype structure generated by $\leq_\tau:=\leq_M$ and $\tau^*_m := \tau_m$.  We indicate how to define an embedding from $M$ into this supertype structure.

Define $I(x) = x$ for $x \in \tau_m = \tau^*_m$.

If we have defined $I$ on each type $u <_\tau t$, we define $I(x)$, for $x \in \tau_t$, as
$\bigcup_{u <_\tau t} \{I(y):y \in^M_{u,t} x\} \cup \{\{\tau^*_u:u <_\tau t\}\}$.

It should be clear that as long as $M$ satisfies the condition that an element of any type is uniquely determined given all of its extensions in lower types, $I$ is an isomorphism from $M$ to a substructure of the stated system of supertypes.  A model of TTT, in which any one extension of an element of any higher type in a lower type exactly determines the object of higher type, certainly satisfies this condition.  So we can suppose without loss of generality that any model of TTT is a substructure of a supertype system.

The advantages of this framework are that the membership relations in TTT are interpreted as subrelations of the membership relation of the metatheory, while the types are sensibly disjoint.

\item[preliminaries of our construction;  cardinal parameters and type $-1$:]Now we introduce the notions of our particular construction in this framework.

Let $\lambda$ be a limit ordinal.  Let $\leq_\tau$ be the order on $\lambda \cup \{-1\}$ which has $-1$ as minimal and agrees otherwise with the usual order on $\lambda$.

Let $\kappa>\lambda$ be a regular uncountable ordinal.  Sets of cardinality $<\kappa$ we call ``small".  Sets which are not small we may call ``large".

Let $\mu$ be a strong limit cardinal greater than $\kappa$ with cofinality at least $\kappa$.

Let $\tau^*_{-1}=\tau_{-1}$ be $$\{(\nu,\beta,\gamma,\alpha):\nu<\mu \wedge  \beta \in \lambda\cup \{-1\} \wedge \gamma \in \lambda \setminus \{\beta\}\wedge \alpha<\kappa\}.$$  Note that this completes the definition of the supertype structure we are working in:  we now have a definite reference
for $\tau^*_\alpha$ for $\alpha\in \lambda$.

\item[atoms, litters and near-litters:]  

We may refer to elements of $\tau_{-1}$ (or closely related objects) as ``atoms" from time to time, though they are certainly not atomic in terms of the metatheory.

A {\em litter\/} is a subset of $\tau_{-1}$ of the form $L_{\nu,\beta,\gamma} = \{(\nu,\beta,\gamma,\alpha):\alpha<\kappa\}$.  The litters make up a partition of type $-1$
(which is of size $\mu$) into size $\kappa$ sets.

A {\em near-litter\/} is a subset of $\tau_{-1}$ with small symmetric difference from a litter.  Note that the relation of having small symmetric difference, which we call nearness, is an equivalence relation on near-litters.   We define $M \sim N$ as $|M \Delta N|<\kappa$, for $M,N$ near-litters.

We define $N^\circ$, for $N$ a near-litter, as the litter $L$ such that $L \sim N$.  NOTE:  A notion which we do not make use of in the new approach is the notion of {\em local cardinal\/}:  $[N] = \{N:N \sim L\}$ for any near-litter $N$, $[N]$ being called the local cardinal of $N$.  In general, references to local cardinals are replaced with references to their unique litter elements in this treatment.  We preserve a reference to it here in case some reference to it survives when text is transferred from one format to the other,

Define ${\bf X}_{\beta,\gamma}$ as $\{L_{\nu,\beta,\gamma}:\nu < \mu\}$.  This gives us a set of litters of size $\mu$ for each pair of
types $\beta\in \lambda \cup \{-1\}$ and $\gamma \in \lambda \setminus \{\beta\}$:  the collection of sets ${\bf X}_{\beta,\gamma}$ is pairwise disjoint.  

\item[enforcing extensionality in the type system:]  We describe the mechanism which enforces extensionality in the substructure of this supertype structure that we will build.

The levels of the structure we will define are denoted by $\tau_\alpha$ for $\alpha \in \lambda \cup \{-1\}$.  As we have already noted, $\tau_{-1}=\tau^*_{-1}$ as defined above.

In defining $\tau_\alpha \subseteq \tau^*_\alpha$ for each $\alpha$, we assume that we have already defined $\tau_\beta$ for each $\beta<\alpha$, and that it satisfies various hypotheses which we will discuss as we go.
Elements $x$ of $\tau^*_\alpha$ which we consider for membership in $\tau_\alpha$ will have $x \cap \tau^*_\beta \subseteq \tau_\beta$ for $\beta<\alpha$.  For $\gamma<\beta<\alpha$, if $x \in \tau_\beta$, $x \cap \tau^*_\gamma \subseteq \tau_\gamma$.

We suppose that each $\tau_\beta$ already constructed is of cardinality $\mu$.  Note that we already know that
$\tau_{-1}$ is of cardinality $\mu$.

We postulate a well-ordering $\leq_\beta$ of $\tau_\beta$, of order type $\mu$, with associated strict well-ordering $<_\beta$ for each $\beta<\alpha$.   Note that these well-orderings do not depend on $\alpha$:  once constructed, they remain the same at later stages.  Some conditions on these well-orderings will be stated later.  We define $\iota_*(x)$ for $x \in \bigcup_{\beta \in \lambda \cup \{-1\}}\tau_\beta$, where $x \in \tau_\gamma$, as the order type of the restriction of $\leq_\gamma$ to
$\{y:y <_\gamma x\}$.

We provide that for every near litter $N$ and every $\beta<\lambda$, there is a unique element $N_\beta$ of $\tau_\beta$ such that $N_\beta \cap \tau_{-1}=N$.

\begin{description}

\item[Definition:]  If $X$ is a subset of type $\gamma$ and $\gamma<\beta$, we define $X_\beta$ as the unique element $Y$ of $\tau_\beta$
such that $Y \cap \tau_\gamma = X$.  Of course, this notation is only usable to the extent that we suppose that extensionality holds.  Notice
that the notation $N_\beta$ is a case of this.

\end{description}

We further stipulate that extensionality holds for each $\beta\in \alpha$ (any $x \in \tau_\beta$ is uniquely determined by $x \cap \tau_\gamma$ for every $\gamma \in \alpha$), and that for any $\beta \in \alpha$ and $x \in \tau_{-1}$, $\iota_*(\{x\}_\beta) = \iota_*(\{x\}_0)$ {\bf ($\gamma = -1$ fix)}

We define for each $\beta,\gamma <\alpha$ a function $f_{\beta,\gamma}$ (whose definition does not actually depend on $\alpha$:  it will be the same at every stage).  $f_{\beta,\gamma}$ is an injection from $\tau_\beta$ into $X_{\beta,\gamma}$.
When we define $f_{\beta,\gamma}(x)$, we presume that we have already defined it for $y <_\beta x$.
We define $f_{\beta,\gamma}(x)$ as $L\cap \tau_{-1}$, where $L$ is $<_\gamma$-first such that for every $N \sim L \cap \tau_{-1}$, $\iota_*(N_\gamma)>\iota_*(x)$ [and if $\beta=0$, $\iota_*(N_\gamma)>\iota_*(\{x\}_0)$], and for any $y<_\beta x$, $f_{\beta,\gamma}(y) \neq L\cap \tau_{-1}$.

{\bf Note for Lean project readers:  I never (or seldom) mention local cardinals in this version.  Values of $f$ maps are litters;  local cardinals are of course equivalence classes of litters under nearness, and this is how they come in.  They could of course be reinstated.}

We define the notion of pre-extensional element of $\tau^*_\beta$ ($\beta \leq \alpha$).  We presume that all elements of $\tau_\beta$, $\beta<\alpha$, are pre-extensional.  An element $x$ of $\tau^*_\beta$ is pre-extensional iff there is a $\gamma<\beta$, for which we call $x \cap \tau_\gamma$ a distinguished extension of $x$, where $\gamma=-1$ if
$x \cap \tau_{-1}$ is nonempty or if any $x \cap \tau_\delta$ ($\delta <_\tau \beta$) is empty, and for each $\delta \in \beta \setminus \{\gamma\}$, $$x \cap \tau_\delta= \{N_\delta:(\exists a \in x \cap \tau_\gamma:N \sim f_{\gamma,\delta}(a))\}.$$

Note that we now know how to compute all other extensions of typed near-litters $N_\beta$, because the $-1$-extension of $N_\beta$ is distinguished and this indicates how to compute all the other extensions.

{\bf note for readers of earlier versions:  The code $(\alpha,\beta,B)$ in the previous version correlates with the pre-extensional element $x$ of
$\tau_\alpha$ with $B=x\cap \tau_\beta$ its $\beta$-extension and moreover a distinguished extension (so that we know how to compute all other extensions).  The notation $B_\alpha$ has been suggested above for this object;  the ordinal $\beta$ is implicit because $B$ is a nonempty subset of type $\beta$.}

We note that the order conditions in the definition of $f_{\beta,\gamma}$ ensure that for any $x \in \tau_\beta$ there is only one $\gamma <_\tau \beta$ such that $x \cap \tau_\gamma$ is a distinguished extension of $x$.  If any $x \cap \tau_\gamma$ is empty or if $x \cap \tau_{-1}$ is not empty, $\gamma= -1$ is the unique possibility.  So, what remains is the case of $x$ with $x \cap \tau_{-1}$ empty and each $x \cap \tau_\gamma$ nonempty for $\gamma<\beta$.
Now the order conditions on $f_{\beta,\gamma}$ ensure that if $x \cap \tau_\gamma$ is a distinguished extension,
we can choose $a \in x \cap \tau_\gamma$ with $\iota_*(a)$ minimal.  Any $c \in x \cap \tau_\delta$ ($\delta \neq \gamma$) then is an $N_\delta$ and
has $N_\delta \sim f_{\gamma,\delta}(b)$ for some $b \in \tau_\gamma$, and we have $\iota_*(a) \leq \iota_*(b) < \iota_*(N_\delta) = \iota_*(c)$, so the distinguished extension can be identified by finding the smallest value of
$\iota_*$ on an extension.

For any $\delta \in \alpha$ and nonempty subset $a$ of type $\gamma \neq \delta$, we define $A_\delta(a)$ as $$\{N_\delta:(\exists x \in a:N \sim f_{\gamma,\delta}(x))\}.$$  For any nonempty subset of type $\delta$ there is at most one subset $y$ of any type such that $A_\delta(y)=x$.  There cannot be more than one such $y$ in any given type because the $f$ maps are injective.  There cannot be more than one such $y$ in different types because the ranges of $f$ maps with distinct index pairs are disjoint.   We use the notation $A^{-1}(y)$ for this set if it exists, defining a very partial function $A^{-1}$ on subsets of types.

Note that the distinguished extension of any type element $x$ is the image under $A^{-1}$ of the other extensions.
The exact argument above shows that for any subset $a$ of a type, the minimal value of $\iota_*$ on $a$ is larger
than the minimal value of $\iota_*$ on $A^{-1}(a)$ if $A^{-1}(a)$ exists.  It follows that no subset of a type has
infinitely many iterated images under $A^{-1}$.

{\bf Lean project readers note that the $A_\delta$ and $A^{-1}$ functions are acting on subsets of types (extensions).  They are doing the same things!}

We then restrict the pre-extensional elements to extensional elements.  An element of a type is extensional if
it is pre-extensional and its distinguished extension has an even number of iterated images under $A^{-1}$.
This implies that each of its other extensions has an odd number of iterated images under $A^{-1}$.  This is enough to ensure that two extensional model elements with any common extension will be equal:  if two extensional model elements have an empty extension in common, they both have all extensions empty and are equal.  If two extensional model elements have a nonempty extension in common, it will be the distinguished extension of both, or a non-distinguished extension of both, since distinguished and non-distinguished extensions are taken from disjoint classes of sets of types.
In either case we deduce that both have the same distinguished extension and thus have all extensions the same and are equal.  Note that this gives weak extensionality over $\tau_{-1}$ (many objects have empty extension over type $-1$) but it gives full extensionality over any other type.

We assume that all elements of $\tau_\beta$'s already constructed are extensional.

\item[brief note on our further needs:]  The crucial aspect of this is that we will need to define $\tau_\alpha$ so that it has cardinality $\mu$ for the process to continue.  It is certainly not a sufficient restriction to require elements of $\tau_\alpha$ to be extensional:  we will require a further symmetry condition.

\item[structural permutations defined:]  We define classes of permutations of our structures.

A $-1$-structural permutation is a permutation of $\tau_{-1}$.

An $\alpha$-structural permutation is a permutation $\pi$ of $\tau_\alpha$ such that for each element $\beta<\alpha$ there is a $\beta$-structural permutation
$\pi_\beta$ such that $\pi(x) \cap \tau_\beta = \pi_\beta``(x \cap \tau_\beta)$.

\item[derivatives of structural permutations:]  The maps $\pi_\beta$ are referred to as derivatives of $\pi$.  More generally, for any finite subset $A$ of $\lambda \cup \{-1\}$ with maximum $A$,
define $\pi_A$ as $(\pi_{A \setminus \{{\tt min}(A)\}})_{{\tt min}(A)}$.  It should be clear that a structural permutation is exactly determined by its iterated derivatives which are $-1$-structural.

\item[allowable permutations defined:]  Structural permutations are defined on the supertype structure generally.  We need a subclass of structural permutations which respects our extensionality requirements.

A $-1$-allowable permutation is a permutation $\pi$ of $\tau_{-1}$ such that for any near-litter $N$, $\pi``N$ is a near-litter.

An $\alpha$-allowable permutation is an $\alpha$-structural permutation, each of whose derivatives $\pi_\beta$ is a $\beta$-allowable permutation (and satisfies the condition that $\pi_\beta``\tau_\beta = \tau_\beta$) and which satisfies a coherence condition relating the $f$ maps and derivatives of the permutation:  for suitable $\beta,\gamma<\alpha$, $$f_{\beta,\gamma}(\pi_\beta(x)) \sim (\pi_\gamma)_{-1}``f_{\beta,\gamma}(x).$$

Note that an $\alpha$-allowable permutation is actually defined on the entire supertype structure, though what interests us about it is its actions on objects in our purported TTT model.

\item[motivation of the coherence condition:]  The motivation for this is that we need $\alpha$-allowable permutations to send extensional elements of supertypes to extensional elements.  Suppose
$x \cap \tau_\beta = \{b\}$.  If $x$ is extensional, this has to be the distinguished extension of $x$.  For any $\gamma \in \alpha \setminus \{\beta\}$,
it follows that $x \cap \tau_\gamma$ is the set of all $N_\gamma$ such that $N \sim f_{\beta,\gamma}(b)$.  This tells us that an $\alpha$-allowable permutation $\pi$, for which we must have that $\pi(x)$ has $\beta$-extension $\{\pi_\beta(b)\}$, must have the  $\gamma$-extension of $\pi(x)$ equal to $\pi_\gamma``\{N_\delta:N \sim f_{\beta,\gamma}(b)\}$
but must also have its $\gamma$-extension equal to $\{N_\delta:N \sim f_{\beta,\gamma}(\pi_\beta(b))\}$.  This tells us that $\pi_\gamma(f_{\beta,\gamma}(b)_\delta) \in \{N_\delta:N \sim f_{\beta,\gamma}(\pi_\beta(b))\}$.  Thus $\pi_\gamma(f_{\beta,\gamma}(b)_\delta)\cap \tau_{-1} \sim f_{\beta,\gamma}(\pi_\beta(b))\}$, and $\pi_\gamma(f_{\beta,\gamma}(b)_\gamma)\cap \tau_{-1} = (\pi_\gamma)_{-1}``f_{\beta,\gamma}(b)$, which establishes that the coherence condition follows from the condition that allowable permutations preserve extensionality.

We defined $A_\delta(a)$ as $$\{N_\delta:(\exists x \in a:N \sim f_{\gamma,\delta}(a))\}.$$

If $\pi$ is allowable of suitable index, $\pi_\delta``A_\delta(a)= A_\delta(\pi_\gamma``a)$ follows from the coherence condition.  Verify this:

Suppose we have $N_\delta$ with $x \in a$ such that $N \sim f_{\gamma,\delta}(x)$.  Then $$\pi_\delta(N_\delta)  \cap \tau_{-1} = (\pi_\delta)_{-1}``N \sim (\pi_\delta)_{-1}``f_{\gamma,\delta}(x) \sim f_{\gamma,\delta}(\pi_\gamma(x)).$$  So any element of $\pi_\delta``A_\delta(a)$ is in $A_\delta(\pi_\gamma``a)$.

Suppose we have $N_\delta$ with $x \in a$ such that $N \sim f_{\gamma,\delta}(\pi_\gamma(x))$.  We then have $N \sim (\pi_\delta)_{-1}``f_{\gamma,\delta}(x)$.  We want to show that $\pi_\delta^{-1}(N_\delta) \in A_\delta(a)$.  $\pi_\delta^{-1}(N_\delta) \cap \tau_{-1} = (\pi_\delta)_{-1}^{-1}``N \sim 
(\pi_\delta)_{-1}^{-1}``((\pi_\delta)_{-1}``f_{\gamma,\delta}(x)) = f_{\gamma,\delta}(x)$, establishing what we need.

Notice that this shows that the coherence condition implies that the image under an allowable permutation of a pre-extensional element of our structure is pre-extensional.

Now this implies that if $a \subseteq \tau_\gamma$, then $A^{-1}(a)$ exists and is in $\tau_\delta$ exactly if $A^{-1}(\pi_\gamma``a)$ exists and is in $\tau_\delta$, and moreover $A^{-1}(\pi_\gamma``a)$ is equal to $\pi_\delta``A^{-1}(a)$ if it exists under these conditions.  This verifies that the coherence condition implies full extensionality, not just pre-extensionality:  the number of iterated images under $A^{-1}$ of an extension that exist is not affected by application of an allowable permutation in a suitable sense.

\item[supports defined:]  Where $\beta \leq \alpha$, a $\beta$-support is a small set of pairs $(x,A)$, where $A$ is a finite subset of $\lambda$ with minimum $\gamma$ and maximum $\beta$ and $x \in \tau_\gamma$ has $x \in \tau_{-1}$ either a singleton or a near-litter.

We define the action of a $\beta$-allowable permutation $\pi$ on a $\beta$-support $S$:  $\pi[S]= \{(\pi_A(x),A):(x,A) \in S\}$.

An element of $\tau^*_\beta$ has $\beta$-support $S$ iff for every $\beta$-allowable permutation, if $\pi_A(u) = u$ for each $(u,A) \in S$ then $\pi(x)=x$.

\item[the definition of $\tau_\alpha$:]  We stipulate that all elements of $\tau_\beta$ have supports, and define $\tau_\alpha$ as the set of elements $x$ of $\tau^*(\alpha)$ such that
$x \cap \tau^*_{\beta} \subseteq \tau_\beta$ for each $\beta<\alpha$, $x$ is extensional, and $x$ has a support.

\item[designated supports:]  We designate a support for each element $x$ of $\tau_\alpha$ which is not a typed atom or near-litter (which does not have $x \cap \tau_{-1}$ a singleton or near-litter).  We note that we have a notion of designated support for each lower type constructed in the same way at earlier stages.

\item[images under allowable permutations preserve symmetry:]  Note the important result that if $x$ has support $S$ and $\pi$ is allowable with appropriate index, $\pi(x)$ has support $\pi[S]$.  This verifies that for any $\alpha$-allowable permutation $\pi$, $\pi``\tau_\alpha = \tau_\alpha$.

\item[conditions on choice of the distinguished well-orderings of types:]  We choose the well-ordering $<_\alpha$ of $\tau_\alpha$, which must be of order type $\mu$, with some constraints (noting that the same conditions were imposed at each earlier type when it was constructed).

\begin{enumerate}

\item Each typed atom $x \in \tau_\alpha$ ($x \cap \tau_{-1} = \{y\}$) is preceded in the order $<_\alpha$ by $L_\alpha$, where $L$ is the litter containing $x$.

\item Each typed near-litter $N_\alpha$, where $N$ is a near-litter which is not a litter, is preceded in $<_\alpha$ by $L_\alpha$, where $L$ is the litter near $N$,
and by $\{y\}_\alpha$, the unique element of $\tau_\alpha$ such that $\{y\}_\alpha \cap \tau_{-1} = \{y\}$, for each $y \in L \Delta N$.

\item Each $x$ which is not an atom or near-litter satisfies $\iota_*(x) > \iota_*(y)$ for $(y,A)$ in the designated support of $x$.

\item ({\bf for the $\gamma = -1$ fix})  The position of each typed atom and near-litter in each order with index other than $-1$ will be the same as the position of the corresponding atom or near-litter in the order on type 0, and each other object with a nonempty extension over type $-1$ occupies the same position or a later position in each positive type than the position occupied by an object with the same extension over type $-1$ in type 0.

\end{enumerate}

The condition added for the $\gamma=-1$ fix appears enforceable, since it leaves $\mu$ positions free, and nothing is bounded above by the position of a litter,
and nothing is bounded above by the position of a typed atom except the position of the corresponding litter.   It should be noted that type 0 has a very simple description:  the $-1$-extensions of type 0 objects are exactly the sets with small symmetric difference from small or co-small unions of litters, and that these are the same extensions over type $-1$ which appear in any positive type.

A back and forth argument will establish the existence of an order satisfying the conditions.  Construction of the order at type 0 is straightforward.
The idea is to alternate between placing an item from type $\alpha$ and making sure that the first unfilled position is filled.  In the construction of the order on type 0, the stage where one fills the first unfilled position is readily handled with a litter.  The stage where one places an item from type $\alpha$ always succeeds because one has only a small collection of items one must place the item above, so the cofinality of $\mu$ ensures that there will be a place to put the item.  Note that there are $\mu$ places which are not occupied by typed atoms or near-litters in type 0.  Now, the filling of the first unoccupied place is an issue:
we can fill it with the analogue (with the same extension over type $-1$) of whatever occupied that place in the order on type 0, which by assumption we have not placed yet.  

At this point we should have a complete description of the structure (which should be translatable into terms of the web paper or the Lean project, mod the changes in the conditions on the order.


\end{description}

\section{Verification that the structure defined is a model}

\subsection{Freedom of action alternative proof incorporated from untangled}

Some of the initial discussion of supports is repeated.

\begin{description}

\item[Definition (condition):]  We define a {\em $\beta$-condition\/} for $\beta\leq \alpha$ as a pair $(x,A)$, where $A$ is a finite subset of $\lambda$ with ${\tt max}(A)=\beta$ and ${\tt min}(B) = \gamma \geq 0$, $x \in \tau_\gamma$, and $x \cap \tau_{-1}$ is either a singleton or a near-litter.

\item[Definition (support):]  We define a {\em $\beta$-support\/} for $\beta\in \alpha$ as a small set of $\beta$-conditions.  It is convenient to stipulate
as a further condition on supports that if $(x,A)$ and $(y,A)$ belong to a support and both $x$ and $y$ are typed near-litters, that $x \cap \tau_{-1}$ and $y \cap \tau_{-1}$ are disjoint.

\item[Definition (action of an allowable permutation on a support):]  If $\pi$ is a $\beta$-allowable permutation and $S$ is a $\beta$-support,
we define $\pi[S]$ as $$\{(\pi_A(x),A):(x,A) \in S\}.$$

\item[Definition (support of):]  We say that $S$ is a support of $X$ 
iff for any allowable permutation $\pi$, $\pi$ will fix $X$ if it is the case that for every $(x,A)\in S$, $\pi_A(x)=x$.

\item[Definition (dependency):]  We define a relation of dependency $D$ on conditions:  $(x,A)D(y,B)$  if either 

\begin{enumerate}
\item $A=B$ and $|x \cap \tau_{-1}|=1$ and $y \cap \tau_{-1}$ is a litter and $x \cap \tau_{-1} \subseteq y \cap \tau_{-1}$ [``elements of a litter depend on the litter"], or 

\item $A=B$, $y \cap \tau_{-1}$ is a litter, and $x \cap \tau_{-1} \neq y \cap \tau_{-1}$ is a near-litter and $x \cap \tau_{-1} \sim y \cap \tau_{-1}$ [``near-litters which are not litters depend on the litter they are near"], or 

\item $A=B$, $x \cap \tau_{-1}$ is a near-litter and not a litter, and $y \cap \tau_{-1} = \{u\} \subseteq (x \cap \tau_{-1}) \Delta (x \cap \tau_{-1})^\circ$ [``near-litters which are not litters depend on the elements of their symmetric difference from the nearby litter"], or

\item for some $\gamma$ with $-1 < \gamma<{\tt min}(A_1)$, $(y,(B\cap {\tt min}(A)) \cup \{\gamma\})$ is an element of the designated $\gamma$-support of $f_{\gamma,{\tt min}(A)}^{-1}(x \cap \tau_{-1})$ [``non-flexible near-litters depend on the elements of the designated support of the unique preimage under an $f$ map of their local cardinals"].

\item $x \cap \tau_{-1}= f_{-1,{\tt min}(A)}(u)$, $B= A_1$, and $y \cap \tau_{-1}= \{u\}$.  [``A typed litter $f_{-1,{\tt min}(A)}(u)$ depends on an appropriately typed atom with $-1$-extension $\{u\}$".]

{\bf NOTE:  this is $\gamma = -1$ fix.}  This case is strange because the dependency is on something of higher type.

\end{enumerate}

The bracketed statements are merely suggestive, as the scare quotes should suggest, as they are statements about atoms and near-litters rather than typed atoms and typed near-litters decorated with extended type indices.  A near-litter being flexible or not is of course context dependent;  but the scare quoted statements are intended to be suggestive of what is going on rather than precise.

Note that if $(x,A) D (y,B)$ we always have $\iota_*(x)>\iota_*(y)$.

\item[Definition (order on a support):]  If $S$ is a $\beta$-support, we define the order $<_S$ on $S$ by $(x,A) <_S (y,B)$ iff the two conditions belong to $S$ and
$\iota_*(x)<\iota_*(y)$.  In the odd situation where $x=y$ and $A \neq B$, use a previously fixed well-ordering of extended type indices:  $(x,A) <_S (x,B)$ iff $A < B$.

\item[Definition (strong support):]  We say that a $\beta$-support $S$ is strong if whenever $(x,A) \in S$ and $(x,A) D (y,B)$, we have $(y,B)\in S$.  Note that $(y,B) <_S (x,A)$ will hold in this situation.  

\item[Observations:]  Note that the definition of strong support, combined with the disjointness condition in the definition of supports, ensures that
if $(x,A)$ is in a strong support and $x \cap \tau_{-1}$ is a near-litter, $x \cap \tau_{-1}$ is a litter.  Note further that any support can be extended to a strong support:  this can be enforced in $\omega$ stages of adding missing items, adding a small collection of new items at each stage.

\item[Reprise of strong supports:]  We give another equivalent definition:

On any support $S$ we can impose an order $<_S$ as follows:  choose any desired order on nonempty finite subsets of $\lambda$ and order conditions $(x,A)\in S$ first by $\iota_*(x)$, then by the order on extended type indices (a term we use for nonempty finite subsets of $\lambda \cup \{-1\}$, $-1$ not in play here).

Where $S$ is a $\beta$-support and $C$ is a set of types with ${\tt min}(C) \geq \beta$, define
$S^C$ as the ${\tt max}(C)$-support $\{(x,A \cup C):(x,A) \in S\}$.

A strong support $S$ is a $\beta$-support with the following properties:

\begin{enumerate}

\item  For any $(\{u\}_\gamma,A) \in S$, $(L,A) \in S$, where $L$ is the litter containing $S$.  Notice
that $(L,A) <_S (\{u\}_\gamma,A)$.

\item   For any $(N,A) \in S$, $N$ a near-litter, $N$ is a litter.

\item  For any $(f_{\gamma,\delta}(x),A) \in S$, where $\gamma \neq -1$ and $\gamma < \beta$ ($\delta<\beta$ is obvious),
if $T$ is the designated $\gamma$-support of $x$, all elements of $T^{A \setminus (\delta+1)}$ belong to $S$.

Notice that every element of $T^{A \setminus (\delta+1)}$ stands in the relation $<_S$ to $(f_{\gamma,\delta}(x),A)$.

\item For any $(f_{-1,\delta}(x),A) \in S$, $(\{x\}_{{\tt min}(A_1)},A_1)$ belongs to $S$
if $A_1$ is nonempty,  $A_1$ being shorthand for $A \setminus \{{\tt min}(A)\}$.

Note again that $(\{x\}_{{\tt min}(A_1)},A_1) <_S (f_{-1,\delta}(x),A)$ {\bf NOTE:  This is $\gamma = -1$ fix}

\end{enumerate}




\item[General Remark:]  Note that here supports are simply sets of conditions rather than well-orderings of conditions.  The older approach under which they are well-orderings had some advantages, notably in the definition of ``support of", which required slightly less care with quantifier order.

\item[Definition (approximation):]   A $\beta$-approximation is a map $\pi^0$ from finite subsets of $\lambda$ with maximum element $\beta$ such
that each $\pi^0(A)$ (which we write $\pi^0_A$) is a function with the following properties:

\begin{enumerate}

\item  The domain and image of $\pi^0_A$ are the same and $\pi^0_A$ is injective.

\item Each domain element $x$ is in $\tau_{{\tt min}(A)}$ and $x \cap \tau_{-1}$ is is included in a litter (note that this excludes some near-litters).

\item $x \cap \tau_{-1}$ and $\pi^0_A(x) \cap \tau_{-1}$ have the same cardinality.  

\item  For each $A$, the collection $\{x \cap \tau_{-1}: x \in {\tt dom}(\pi^0_A)\}$ is pairwise disjoint  and covers any litter with which its union has large (i.e, cardinality $\geq \kappa$)  intersection.

\end{enumerate}

We say that $\pi^0$ approximates a $\beta$-allowable permutation $\pi$ just in case $\pi_A(x) = \pi^0_A(x)$ whenever the latter is defined.

\item[Definition (flexibility):]  A typed near-litter $x$ is $A$-flexible if it is of type ${\tt min}(A)$ and $x \cap \tau_{-1}$ is not in the range of any $f_{\gamma,{\tt min}(A)}$
for $\gamma<{\tt min}(A_1)$.

\item[litter near a near-litter:]  For any near-litter $N$, define $N^\circ$ as the unique litter $L$ such that $L \sim N$.

\item[Definition (exception, exact approximation):]  A $-1$-allowable permutation $\pi$ has {\em exception\/} $x$ if, $L$ being the litter containing $x$,
we have either $\pi(x) \not\in (\pi``L)^\circ$ or $\pi^{-1}(x) \not\in (\pi^{-1}``L)^\circ$.

A $\beta$-approximation $\pi^0$ {\em exactly approximates\/} a $\beta$-allowable permutation $\pi$ iff $\pi^0$ approximates $\pi$ and
for every exception $x$ of a $\pi_{A \cup \{-1\}}$ ($A$ not containing $-1$) we have $\{x'\}_{{\tt min}(A)}$ in the domain of $\pi^0_A$.

\item[Theorem (freedom of action):]  A $\beta$-approximation $\pi^0$ will exactly approximate some $\beta$-allowable permutation $\pi$ if it satisfies the additional conditions that for any litter $L$, the set of domain elements of $\pi^0_A$ whose $-1$-extensions intersect $L$ is small,
and that any domain element $x$ of $\pi^0_A$ which is a typed near-litter is $A$-flexible.

\item[Proof:]  For purposes of this proof we choose for every pair $(L,M)$ of subsets of litters a bijection $\pi_{L,M}$ from $L$ to $M$.  This is not an application of AC:  it can be done concretely using the indexing of elements of litters, but the details are not important.

We also choose a well-ordering of the conditions:  choose a well-ordering of finite subsets of $\lambda$ (we don't care which one) and
set $(x,A) \leq (y,B)$ iff either $\iota_*(x) < \iota_*(y)$ or $\iota_*(x) = \iota_*(y)$ and $A \leq B$. 

We also choose an extension of $\pi^0_A$ to suitable near-litter subsets of all $A$-flexible typed litters (the conditions dictate what near-litters should be added to the domain, uniquely, since the litters need to be exactly covered by domain elements in a suitable sense);  we do this without notational comment, simply assuming that $\pi^0_A$ is defined for each $A$ at a near-litter included in each $A$-flexible litter, which can be arranged harmlessly
(for example, one could have $\pi^0_A$ act as the identity on the new $A$-flexible typed near-litters, but we do not require this).

We choose an approximation $\pi^0$ satisfying the conditions of the theorem.  We carry out a recursive calculation on the order on conditions:
we compute each $\pi_A(x)$ for the $\pi$ exactly approximated by $\pi^0$ on the assumption that this has already been carried out for all $(y,B)< (x,A)$.  We assume in computing the $\beta$-allowable permutation $\pi$ that the theorem is already established for all $\gamma<\beta$.

We indicate how to carry out the calculation at $(x,A)$.  Let $\gamma = {\tt min}(A)$,  If $x$ is a typed atom, $(x,A)$ is preceded by $(L,A)$, where $L \cap \tau_{-1}$
is the litter including $x \cap \tau_{-1}$, and we have already computed $\pi_A(L)$ by hypothesis of the recursion.  Let $L^-$ be the set of all $y\in L \cap \tau_{-1}$ such that for no $z \in {\tt dom}(\pi^0_A)$ is $\{y\}= z \cap \tau_{-1}$.  We define $\pi_{A}$ on each $\{z\}_\gamma$ for $z \in L \cap \tau_{-1}$:
if $\{z\}_\gamma$ is in the domain of $\pi^0_A$, we define $\pi_A(\{z\}_\gamma)$ as $\pi^0_A(\{z\}_\gamma)$.  Otherwise, we define
$\pi_A(\{z\}_\gamma)$ as $\{\pi_{L^-,M^-}(z)\}_\gamma$, where $M^-$ is the set of all $y\in \pi_A(L) \cap \tau_{-1}$ such that for no $z \in {\tt dom}(\pi^0_A)$ is $\{y\}=z \cap \tau_{-1}$.   We have indicated how to compute $\pi_A$ at every typed atom whose $-1$-extension is included in the $-1$-extension of $L$, and so certainly at $x$.

We exclude $(x,A)$ from consideration when $x$ is a typed near-litter, except when its $-1$-extension is a subset of a litter.  This will not cause
any difficulties:  computing every derivative of $\pi$ at every typed atom and litter subset is sufficient to compute $\pi$ for every object in the type structure.

Let $(x,A)$ be a typed near-litter and suppose that we have already determined what $(\pi_A(x) \cap \tau_{-1})^\circ$ must be.   We indicate how
to compute $\pi_A(x)$ from this information.  We will then discuss how $(\pi_A(x) \cap \tau_{-1})^\circ$  is to be computed in each case.

For convenience, we define $\pi^0_{A \cup \{-1\}}(u)$ as the sole element of  $\pi^0_A(\{u\}_{{\tt min}(A)}) \cap \tau_{-1}$.

Let $L$ be the largest near-litter which is a litter subset near $x \cap \tau_{-1}$ containing no $z$ such that $\{z\}_{{\tt min}(A)}$ is in the domain of $\pi^0_A$.
Let $M$ be the largest  near-litter which is a litter subset near $\pi_A(x) \cap \tau_{-1}$ containing no $z$ such that $\{z\}_{{\tt min}(A)}$ is in the domain of $\pi^0_A$.
We stipulate that $\pi_A(L_{{\tt min}(A)}) = M_{{\tt min}(A)}$.  This is enough to compute precisely what $\pi_A(x)$ is, because
the value of $\pi_{A \cup \{-1\}}(z)$ can be determined for each $z$ in $(x \cap \tau_{-1}) \Delta L$ and the action of allowable permutations is elementwise in a suitable sense:  $$\pi_A(x) = ((M \cup \pi^0_{A \cup \{-1\}}``(x \setminus L)) \setminus \pi_{L,M}``(L\setminus x))_{{\tt min}(A)}$$

Now we discuss how to compute $(\pi_A(x)\cap \tau_{-1})^{\circ}$.

If $x$ is $A$-flexible, then there is a subset $L$ of $(x \cap \tau_{-1})^\circ$ such that $\pi^0_A(L_{{\tt min}(A)})$ is defined.  Then $(\pi_A(x) \cap \tau_{-1})^\circ = (\pi^0_A(L_{{\tt min}(A)})\cap \tau_{-1})^\circ$.

If $x$ is not $A$-flexible, there is unique $\gamma$ and $y \in \tau_\gamma$ such that $\gamma < {\tt min}(A_1)$ and $(x \cap \tau_{-1})^\circ = f_{\gamma,{\tt min}(A)}(y)$.

We will be able to compute $(\pi_A(x) \cap \tau_{-1})^\circ$ if we can compute $\pi_{A_1 \cup \{\gamma\}}(y)$, using the coherence condition:
$\pi_{A\cup \{-1\}}``(f_{\gamma,{\tt min}(A)}(y)) \sim f_{\gamma,{\tt min}(A)}(\pi_{A_1 \cup \{\gamma\}}(y))$ by coherence so $(\pi_A(x)\cap \tau_{-1})^{\circ} = f_{\gamma,{\tt min}(A)}(\pi_{A_1 \cup \{\gamma\}}(y))$.

There are two cases, depending on whether $\gamma=-1$ or not.

Suppose that $\gamma=-1$.  {\bf NOTE:  $\gamma = -1$ fix}.  $(x \cap \tau_{-1})^\circ = f_{-1,{\tt min}(A)}(y)$.  We already know how to compute
$\pi_{A_1}(\{y\}_{{\tt min}(A_1)})$ by hypotheses of the recursion, since the position of $\{y\}_{{\tt min}(A_1)}$ in its type precedes the position of $x$ in its type by the way the $f$ map is constructed, and from this we know how to compute $\pi_{A_1 \cup \{-1\}}(y)$, which is what we need.

Suppose that $\gamma\neq -1$.



By inductive hypothesis, the action of $\pi$ on $T^{A_1}$ is known, where $T$ is a strong $\gamma$-support of $y$.

We use the fact that the freedom of action theorem is assumed to hold for $\gamma<\beta$.  We are given $\pi_\gamma[T]$ since we know the action
of $\pi$ on $T^{A_1}$.  If we find a $\gamma$-allowable permutation $\pi'$ with this action on $T$, then $\pi'(y)$ is the only possible value for
$\pi_\gamma(y)$, and we can then compute $(\pi_A(x)\cap \tau_{-1})^\circ=f_{\gamma,{\tt min}(A)}^{-1}(\pi'(y))$ and complete the calculation of $\pi_A(x)$ as above.

The approximation $(\pi')^0$ is now described.  If $(u,A) \in T$ and $u$ is a typed atom or $A$-flexible, we set $(\pi')^0_A(u) = \pi_A(u)$.
This will not necessarily be an approximation, because its domain is not necessarily the same as its image;  there is also a correction needed for near-litter elements of the domain, to be discussed below.  We fill in orbits under $(\pi')^0_A$ for each
typed atom $u$ in the domain, with the proviso that the extended action of $(\pi')^0_A$ sends any new typed atom domain element $u$ which is an ``element" (resp. ``non-element") of a typed litter $L$ to an ``element" (resp. ``non-element") of $\pi_A(L)\cap \tau_{-1}$ for each $L$ with $(L,A) \in T$.  [scare quotes indicate the appropriate analogue of membership of typed atoms in typed litters]
We then modify elements of the domain of the approximation which are typed litters to the appropriate typed near-litters to meet the conditions
that the $-1$-extensions of domain elements of $(\pi')^0_A$ are disjoint and cover litters with which they have large intersection.  The allowable permutation $\pi'$ obtained from the resulting
approximation by application of freedom of action has correct action at typed atomic and flexible litter elements of $T$.  We show that it acts correctly on non-flexible litter elements of $T$.  Consider the exception $(x,A)$ with minimal $\iota_*(x)$.  $\pi'$ acts correctly on each element of the designated support of the $f_{\gamma,{\tt min}(A)}^{-1}(x)$ of interest, so we know that $(\pi'(x))\cap \tau_{-1})^\circ=(\pi_A(x)\cap \tau_{-1})^\circ$.  If $\pi'(x) \neq \pi_A(x)$, this must be because there is an exceptional action of $\pi_{A \cup \{-1\}}$  in $x \cap \tau_{-1}$ or in $\pi_A(L)\cap \tau_{-1}$ other than the known actions on $-1$-extensions of atoms in the support $T$.  But by construction there are no exceptional actions of $\pi'$ in litters in $T$ or their images under $\pi_A$ other than at atoms in the support $T$.  NOTE: in the whole discussion in this paragraph, there is implicit type-casting between typed atoms and the corresponding elements of type $-1$ and typed litters and their $-1$-extensions which happen to be actual atoms and litters:  some language should be fixed up.  This was also a feature of the original language in the previous version.

The process given will compute $\pi_A(x)$ for every atom $x$, and so will compute a full allowable permutation with the desired properties.  The fact
that the induction is on the given order on entire types rather than on an order in a specific strong support should be a simplifying factor.

\end{description}

\newpage
\subsection{Types are of size $\mu$ (so the construction actually succeeds)}

Now we argue that (given that everything worked out correctly already at lower types) each type $\alpha$ is of size $\mu$, which ensures
that the construction actually succeeds at every type.

\begin{description}

\item[We work with ordered supports:]  In this section, a support is a well-ordering whose domain is a support in the sense of previous sections.  We will write a support $S$ as $\leq_S$ when using it as an order (and write $<_S$ for the corresponding strict well-ordering) and by convention often write
$S$ instead of ${\tt dom}(\leq_S)$ when confusion is unlikely.  A strong support is a strong support $S$ in the sense of previous sections equipped with the order $<_S$ defined in earlier sections, the restriction of our global order on conditions to $S$.  We define the action of permutations
on ordered supports in the obvious way:  $(x,A) \leq_S (y,B)$ iff $(\pi_A(x),A)\, \pi[\leq_S]\, (\pi(y),B)$.  We may abuse notation by writing $\pi[\leq_S]$ as $\pi[S]$.

For $\leq_S$ a $\beta$-support and $C$ a finite subset of $\lambda$ with ${\tt min}(C) \geq \beta$, we define $\leq_{S^C}$ so that $(x,A) \leq_S (y,B)$ iff $(x,A \cup C) \leq_{S^C} (y,B \cup C)$,

For $\leq_S$ a $\beta$-support and $\gamma<\beta$, we define $\leq_{S_{(\gamma)}}$ as the largest $\gamma$-support $T$ such that $\leq_{T^{\{\gamma\}}} \subseteq \leq_S$.

\item[Definition (coding functions):]  For any support $S$ and object $x$, we can define a function $\chi_{x,S}$ which sends $T=\pi[S]$ to $\pi(x)$ for every $T$ in the orbit of $S$ under
the action of allowable permutations.  We call such functions {\em coding functions\/}.  Note that if $\pi[S]=\pi'[S]$ then $(\pi^{-1}\circ \pi')[S]= S$, so 
$(\pi^{-1}\circ \pi')(x)= x$, so $\pi(x)=\pi'(x)$, ensuring that the map $\chi_{x,S}$ for which we gave an implicit definition is well defined.

\item[Definition (the specification of a support):]  A support which is an image of a strong support under an allowable permutation we may call a nice support.  For each nice support $S$ we define a combinatorial object $S^*$ which we call its {\em specification\/}.  We will show below that what it specifies is the orbit in the action of allowable permutations on supports to which it belongs.

For $S$ a support, we define $S_\epsilon$ as the element $x$ of its domain such that the restriction of $S$ to $\{y:y <_S x\}$ is of order type $\epsilon$.  We define
$S_{<\epsilon}$ as $\{y:y <_S S_\epsilon\}$.

The specification $S^*$ is a well-ordering of the same length as $S$.  We describe the elements of its domain.

\begin{enumerate}

\item  If $S_{\epsilon}$ is $(\{x\}_\beta,A)$, then $S^*_\epsilon$ is $(0,\beta,\delta,A)$ such that $S_\delta$ is $(N_\beta,A)$, for $N$ a near-litter with $x$ belonging to $N$.  There is exactly one such $\delta$ by the definitions of support and strong support.

One can state an internal condition on specifications that if $S^*_\epsilon$ is $(0,\beta,\delta,A)$, then $S^*_\delta$ must have first component 2 or 3.

\item  If $S_\epsilon$ is $(N_\beta,A)$ and $N$ is a near-litter, and either $|A|=1$ or $N^\circ$ is not in the range of any $f_{\gamma,\beta}$ for $\gamma<{\tt min}(A_1)$, then $S^*_\epsilon$ is $(1,\beta,\emptyset,A)$.

\item  If $S_\epsilon$ is $(N_\beta,A)$ and $N$ is a near-litter, and $N^\circ=f_{\gamma,\beta}(x)$ for $-1<\gamma<{\tt min}(A_1)$, for $x\in \tau_\gamma$ then 
$S^*_\epsilon$ is $(2,\beta,\chi_{x,(S_{<\epsilon})_{(\gamma)}},A)$:  the third component is the coding function with largest possible domain taken from $S$ which yields $x$.

One can state an internal condition on specifications that if $S^*_\epsilon$ is $(2,\beta,\chi,A)$, where $\chi$ is a coding function with outputs of type
$\gamma$, then domain elements of $\chi$ have specification $(S^*_{<\epsilon})_{(\gamma)}$ (restrict to earlier elements of the specification, then remove the top element from each extended type index and retain only those which then have top element $\gamma$).

\item  If $S_\epsilon$ is $(N_\beta,A)$ and $N$ is a near-litter, and $N^\circ=f_{-1,\beta}(x)$ ({\bf $\gamma = -1$ fix}) then $S^*_\epsilon$ is $(3,\beta,\delta,A)$, where  $S_\delta$ is $(\{x\}_{\tt min}(A_1),{\tt min}(A_1))$.

\end{enumerate}

\begin{comment}

Peter wants a definition of the type specification independent of the type support.  Use tags.   It's a good idea.

\end{comment}

\item[Observation:]  On the inductive hypothesis that there are $<\mu$ $\gamma$-coding functions with domain containing a strong support for each $\gamma<\alpha$, we observe that there are $<\mu$ specifications of $\beta$-supports for $\beta\leq \alpha$.

\item[Lemma:]  The specification of a nice $\beta$-support exactly determines the orbit in the action of $\beta$-allowable permutations on supports to which it belongs.

\item[Proof of Lemma:]

It is straightforward to see that if $S$ is a nice $\beta$-support and if $\pi$ is a $\beta$-allowable permutation, that $(\pi[S])^* = S^*$.  The relationships between items in the support recorded in the specification are invariant under application of allowable permutations.

It remains to show that if $S$ and $T$ are nice supports, and $S^*=T^*$, there is an allowable permutation $\phi$ such that $\pi[S]=T$.

We construct $\pi$ using the Freedom of Action Theorem.

If we have $S_\epsilon = (\{x\}_\beta,A)$, we will have $T_\epsilon = (\{y\}_\beta,A)$ for some $y$, and we will set $\pi^0_A(\{x\}_\beta) = \{y\}_\beta$ as part of the construction of the local bijection to be used.

If we have $S_\epsilon = ((M_\beta,A)$ for $M$ a near litter and either $|A|=1$ or $M^\circ$ is not in the range of any $f_{\gamma,\beta}$ for $\gamma<{\tt min}(A_1)$, then $T_\epsilon = (N_\beta,A)$ for $N$ a near litter, with analogous properties, and we set $\pi^0_A(M^\circ_\beta) = N^\circ_\beta$  as part of the data for application of the Freedom of Action Theorem [actually, we set $\pi^0_A((M^-_\beta) = N^-_\beta$  for suitable subsets of $M^-$ and $N^-$, excluding any atoms in $M$ or $N$ that are assigned values;  this adjustment can be made at the end of the process].


If we have $S_\epsilon= ((M_\beta,A)$ for $M$ a near litter with $M^\circ = f_{\gamma,\beta}(x)$, where $-1<\gamma<{\tt min}(A_1)$,
then $S^*_\epsilon$ is $(2,\beta,\chi_{x,(S_{<\epsilon})_{(\gamma)}},A)$ and $T^*_\epsilon$ is $(2,\beta,\chi_{y,(T_{<\epsilon})_{(\gamma)}},A),$ and they are the same.

If all earlier items in $S$ are mapped by appropriate derivatives of a fixed allowable permutation $\pi_0$ to the corresponding items in $T$, then
$$\pi_0(x) = \pi_0(\chi_{x,(S_{<\epsilon})_{(\gamma)}}((S_{<\epsilon})_{(\gamma)}) $$ $$ = \chi_{x,(S_{<\epsilon})_{(\gamma)}}(\pi_0[(S_{<\epsilon})_{(\gamma)}])$$ $$ = \chi_{x,(S_{<\epsilon})_{(\gamma)}}((T_{<\epsilon})_{(\gamma)}) $$ $$= \chi_{y,(T_{<\epsilon})_{(\gamma)}}((T_{<\epsilon})_{(\gamma)})=y$$

and this implies that $\pi(M_\beta)\cap \tau_{-1} \Delta N_\beta\cap \tau_{-1}$ is small:  we need to augment the local bijection to prevent anomalies, and there is a way to do this.

We want to ensure that elements of $M \setminus M^{\circ}$ and elements of $M^{\circ} \setminus M$ correlate with typed atoms in the domain of $\pi^0_A$ and sent to elements of $N_\beta$, and similarly elements of $M$ are chosen to have their associated typed atoms mapped by $\pi^0_A$ to type correlates of elements of $N\setminus N^\circ$ and $N^\circ \setminus N$.
 Some additional work must be done.  For each new element introduced to the domain of $\pi^0_A$, we have the obligation to fill in its complete orbit in $\pi^0_A$.   The restriction we must obey as we do this is that any element of a near-litter in $S$ must be mapped by $\pi^0_A$ to an element of the corresponding near-litter in $T$ and any element of a near-litter in $T$  must be mapped by $(\pi^0_A)^{-1}$ to an element of the corresponding near-litter in $S$.  Since only countably many new values are needed to fill in each orbit and $\kappa$ is uncountable, there is no obstruction to doing this.  Note that atoms already in the domain of $\pi^0_A$ are already constrained to behave in this way.  The map eventually constructed by Freedom of Action will send
$M_\beta$ to $N_\beta$ because it maps typed atoms correlated with elements of $M \Delta M^\circ$ to and elements of $N \Delta N^{\circ}$ to appropriate values individually, and all other typed atoms in $M_\beta$ must be mapped to values in $N_\beta$ (and elements of $N_\beta$ mapped from elements of $M_\beta$) because the map constructed by Freedom of Action has no exceptions not in the domain of the local bijection.

If we have $S_\epsilon= ((M_\beta,A)$ for $M$ a near litter with $M^\circ = f_{-1,\beta}(x)$ ({\bf $\gamma= -1$ fix}),  then we have $S^*_\epsilon = (3,\beta,\delta,A)$ then we have already set $\pi^0_A(\{x\}_{{\tt min}(A_1)}) = \{y\}_{{\tt min}(A_1)}$ as part of the data for the Freedom of Action theorem, where
$T_\delta = (\{y\}_{{\tt min}(A_1)},A_1)$.  This means that if earlier items in $S$ are mapped by appropriate derivatives of a fixed allowable permutation $\pi_0$ to the corresponding items in $T$, then $(\pi_0)_A(\{x\}_{{\tt min}(A_1)}) = \{y\}_{{\tt min}(A_1)}$ whence by coherence, if $T_\epsilon = (N_\beta,A)$, we have
$\pi_0(M_\beta) \cap \tau_{-1} \sim N_\beta \cap \tau_{-1}$ by coherence.  We want to ensure that typed atoms correlated with elements of $M \setminus M^{\circ}$ and elements of $M^{\circ} \setminus M$ are in the domain of $\pi^0_A$ and sent to elements of $N_\beta$, and similarly typed atoms correlated with elements of $M$ are chosen to be mapped by $\pi^0_A$ to typed atoms correlated with elements of $N\setminus N^\circ$ and $N^\circ \setminus N$,
so that in fact $\pi_0(M_\beta) = N_\beta$, and the fix to be applied is the same as in the previous case.

So we have completed the description of what we need to do to construct the needed permutation.

\end{description}

Since the specifications precisely determine the orbits in nice supports under allowable permutations, and there are $<\mu$ specifications
(on stated hypotheses) there are $<\mu$ such orbits.

The strategy of our argument for the size of the types is to show that that there are $<\mu$ coding functions for each type whose domain includes a strong support, which implies that there are no more than $\mu$ (and so exactly $\mu$) elements of each type, since every element of a type is obtainable by applying a coding function (of which there are $<\mu$) to a support (of which there are $\mu$), and every element of a type has a strong support.

\begin{description}

\item[Analysis of coding functions for type 0:]  We describe all coding functions for type 0 (without concerning ourselves about whether supports are strong).  The orbit of a 0-support in the allowable permutations is determined by the positions in the support order occupied by near-litters, and for each position in the support order occupied by a singleton, the position, if any, of the near-litter in the support order which includes it.  There are no more than $2^\kappa$ ways to specify an orbit.  Now for each such equivalence class, there is a natural partition of type $-1$ into near-litters, singletons, and a large complement set.  Notice that near-litters in the partition will be obtained by removing any singletons in the domain of the support which are included in them.  The partition has $\nu<\kappa$ elements, and there will be $2^\nu\leq 2^\kappa$ coding functions for that orbit in the supports, determined by specifying for each compartment in the partition whether it is to be included or excluded from the set computed from a support in that orbit.  So there are no more than $2^\kappa<\mu$ coding functions over type 0.

\item[Analysis of the general case:]  

\item
Our inductive hypothesis is that for each $\beta<\alpha$ there are $<\mu$ $\beta$-coding functions.

For each $g \in \tau_\gamma$, $\gamma<\alpha$, let $S_g$ be the strong support obtained by closing up the designated support for $g$ following the observation above on why supports can be extended to strong supports.

We specify an object $X\in \tau_\alpha$ and a strong $\alpha$-support $S$ for $X$, and develop a recipe for the coding function $\chi_{X,S}$ which can be used to see that there are $<\mu$ $\alpha$-coding functions (assuming of course that we know that things worked out correctly for $\beta<\alpha$).

$X = B_\alpha$, where $B$ is a subset of $\tau_\beta$.  

We describe the computation of a strong $\alpha$-support $T_b$
for $\{b\}_\alpha$ from the strong $\beta$ support $S_b$.   We compute this by a process of closing up $S_b^{\{\alpha\}}$:  the only situation we are concerned
about is items $(N,\{\gamma,\alpha\})$ in the support where $N=f_{\delta,\gamma}(d)$, $\delta<\alpha$.  In this case we insert a suitably
tagged version of $S_d$, or, in the case $\delta= -1$, the atom $\{d\}_\alpha$ and the type $\alpha$ litter containing $d$ in its $-1$-extension (which will cause no further extensions).   The resulting support will be a strong $\alpha$-support for $\{b\}_\alpha$.  This process terminates because in adding a support $S_d$ we are always adding things whose position in the designated order on their type is before the position of $d$ in its type.

So for each $b \in B$, we have $\{b\}_\alpha = \chi_{\{b\}_\alpha,T_b}(T_b)$ for $T_b$ taken from a family of $<\mu$ coding functions.
We further provide that each $T_b$ end extends $S$ (we can do this by starting with the support $S+S_b^{\{\alpha\}}$ obtained by appending $S_b$ to $S$ then removing duplications).

I need to verify the claim that there are $<\mu$ coding functions $\chi_{\{b\}_\alpha,T_b}(T_b)$ in play.  It is given that $T_b$ is computed from
$S_b$, but what we actually need is something like the specification of $T_b$ being computable from the specification of $S_b$.  There are $\mu_0<\mu$ specifications for supports $S_b$ available at the current stage by the inductive hypothesis.   Any specification built the way we describe uses
an $S_b$ to start, which has one of $\mu_0$ possible specifications.  Each further refinement involves choosing an $S_d$ (with one of $\mu_0$ possible specifications) to insert 
at stated positions (or the specification of an atom and a litter in the $\delta=-1$ case).  The exact information needed is for each element of $S_d$ where it is to be inserted in the preceding specification (or where it is already present):  there are no more than $2^\kappa\leq \mu_0<\mu$ ways to make such an insertion, so $\mu_0$ ways to make an insertion of an $S_d$ in a stated way. There will be $<\kappa$ such insertions.
There are $<\mu$ possible descriptions of such processes of insertion (this involves appealing both to the fact that $\mu$ is strong limit and the fact that its cofinality is at least $\kappa$), including descriptions of actually ill-founded processes (of course, an actual construction of a $T_b$ will be well-founded).  So there are $<\mu$ possible specifications for supports $T_b$ constructed as above.   Objects with the same specification are in the range of the same coding function, so we have a family of $<\mu$ coding functions of the kind indicated which cover the type.

We claim that $\chi_{X,S}$ can be defined in terms of the orbit of $S$ in the allowable permutations and the set of coding functions $\chi_{\{b\}_\alpha,T_b}$.  There are $<\mu$ coding functions of this kind, and we have shown above that there are $<\mu$ orbits in the $\alpha$-strong supports under allowable permutations, so this will imply that there are $\leq \mu$ elements of type $\alpha$ (it is obvious that there are $\geq \mu$ elements of each type).
Of course we get $\leq \mu$ codes for each $\beta<\alpha$, but we know that $\lambda<\kappa<\mu$.

The definition that we claim works is that $\chi_{X,S}(U) = B'_\alpha$, where $B'$ is the set of all $\bigcup (\chi_{\{b\}_\alpha,T_b}(U')\cap \pi_\beta$) for $b \in B$ and $U'$ end extending $U$.  Clearly this definition depends only on the orbit of $S$ and the set of coding functions $T_b$ derived from $B$ as described above.  Before we know that this is actually the coding function desired, we will write it as $\chi_{X,S}^*$.

The function we have defined is certainly a coding function, in the sense that $\chi_{X,S}^*(\pi[S]) = \pi(\chi_{X,S}^*(S))$.  What requires work is to show that
$\chi_{X,S}^*(S)=X$, from which it follows that it is in fact the intended function.

Clearly each $b \in B$ belongs to $\chi^*_{X,S}(S)$ as defined, because $b = \bigcup (\chi_{\{b\}_\alpha,T_b}(T_b)\cap \tau_{\beta})$, and $T_b$ end extends $S$.

An arbitrary $c \in \chi_{X,S}^*(S)$ is of the form $\bigcup (\chi_{\{b\}_\alpha,T_b}(U)\cap \tau_{\beta})$, where $U$ end extends $S$ and of course must be in the orbit of $T_b$ under allowable permutations, so some $\pi_0[T_b] = U$. Now observe that $\pi_0[S]=S$, so $\pi_0(X)=X$, so
$(\pi_0)_\beta``B=B$.  Further $(\pi_0)_\beta(b) = c$, so in fact $c \in B$ which completes the argument.  The assertion $(\pi_0)_\beta(b) = c$ might be thought to require verification:   the thing to observe is that $c=\bigcup (\chi_{\{b\}_\alpha,T_b}(U) \cap \tau_\beta)=\bigcup(\pi_0(\chi_{\{b\}_\alpha,T_b}(S)\cap \tau_\beta)=
\bigcup (\pi_0(\{b\}_\alpha)\cap \tau_\beta) = \bigcup(\pi_0(\alpha,\beta,\{b\})\cap \tau_\beta) =\bigcup(\{(\pi_0)_\beta(b)\}_\beta \cap \tau_\beta) = (\pi_0)_\beta(b)$


\end{description}

This completes the proof:  any element of a type is determined by a support (of which there are $\mu$) and a coding function whose domain includes a strong support (there are $<\mu$ of these, so a type has no more than $\mu$ elements (and obviously has at least $\mu$ elements).


% \begin{comment}
{\bf Note for the formal verification project:}  I think the latest revisions are closer to the standard needed for the Lean verification project.
% \end{comment}
\newpage
\subsection{The structure is a model of predicative TTT}

There is then a very direct proof that the structure presented is a model of predicative TTT (in which the definition of a set at a particular type may not mention any higher type).  Use $E$ for the membership relation $\in_{TTT}$ of the structure defined above.  It should be evident that $x E y \leftrightarrow \pi_\beta(x) E \pi(y)$,
where $x$ is of type $\beta$, $y$ is of type $\alpha$, and $\pi$ is an $\alpha$-allowable permutation.

Suppose that we are considering the existence of $\{x : \phi^s\}$, where $\phi$ is a formula of the language of TST with $\in$ translated as $E$, and $s$ is a strictly increasing sequence of types.  The truth value of each subformula of $\phi$ will be preserved if we replace each $u$ of type $s(i)$ with $\pi_{A_{s,i}}(u)$, where  $A_{s,i}$ is the set of all $s_k$ for $i \leq k \leq j+1$ [$x$ being of type $s(j)$, and there being no variables of type higher than $s(j+1)$]:  $\pi_{A_{s,i}}(x) E  \pi_{A_{s,i+1}}(y)$ is equivalent to $(\pi_{A_{s,i+1}})_{s(i)}(x) E \pi_{A_{s,i+1}}(y)$, which is equivalent to $xEy$ by the observation above. The formula $\phi$ will contain various parameters $a_i$ of types $s(n_i)$ and it is then evident that the set $\{x : \phi^s\}$ will be fixed by any $s(j+1)$-allowable permutation $\pi$ such that $\pi_{A_{s,n_i}}$ fixes $a_i$ for each $i$.  But this means that
$(s(j+1),s(j),\{x : \phi^s\})$ is symmetric and belongs to type $s(j+1)$:  we can merge the supports of the $a_i$'s (with suitable raising of indices) into a single $s(j+1)$-support.  Notice that we assumed the predicativity condition that no variable more than one type higher than $x$ appears (in the sense of TST).

This procedure will certainly work if the set definition is predicative (all bound variables are of type no higher than that of $x$, parameters at the type
of the set being defined are allowed).

There are easier proofs of the consistency of predicative tangled type theory;  there is a reason of course that we have pursued this one.

It should be noted that the construction given here is in a sense a Frankel-Mostowski construction, though we have no real need to reference the usual
FM constructions in ZFA here.  Constructions analogous to Frankel-Mostowski constructions can be carried out in TST using permutations of type 0;  here we are doing something much more complicated involving many permutations of type $-1$ which intermesh in precisely the right way.  Our explanation of our technique is self-contained, but we do acknowledge this intellectual debt.

% \begin{comment}
{\bf Note for the formal verification project:}  We note that in order to avoid metamathematics, we actually suggest proving finitely many instances of comprehension with typed parameters from which the full comprehension scheme can be deduced.  That there are such finite schemes (mod the infinite sequence of types) is well-known.  For the project, a list should be provided here.
% \end{comment}

\newpage
\subsection{Impredicativity:  verifying the axiom of union}

What remains to complete the proof is that typed versions of the axiom of set union hold.  That this is sufficient is a fact about predicative type theory.
If we have predicative comprehension and union, we note that for any formula $\phi$, $\{\iota^k(x):\phi(x)\}$ will be predicative if $k$ is taken to be large enough, then application of union $k$ times to this set will give $\{x:\phi(x)\}$.  $\iota(x)$ here denotes $\{x\}$.  It is evidently sufficient to prove that unions of sets of singletons exist.

So what we need to show is that if  $\alpha>\beta>\gamma$ and $G \subseteq \tau_\gamma$, and $\{\{g\}_\beta:g \in G\}_\alpha$ is symmetric (has an $\alpha$-support, so belongs to $\tau_\alpha$), then $G_\beta$ is symmetric (has a $\beta$-support, so belongs to $\tau_\beta$).

Suppose that $\{\{g\}_\beta:g \in G\}_\alpha$ is symmetric.  It then has a strong support $S$.  We claim that $S_{(\beta)}$ (definition of this given in previous subsection) is a $\beta$-support for $G_\beta$.

Suppose that $\pi[S_{(\beta)}]=S_{(\beta)}$.  

Any $g \in G$ has a strong $\gamma$-support $T$ which extends $(S_{(\beta)})_{(\gamma)}$.   Extend $T^{\{\beta\}}$ to a strong $\beta$-support $T^*$.



Our plan is to use freedom of action technology to construct a permutation $\pi^*$ whose action on $S$ is the identity
and whose action on $T^{\{\alpha,\beta\}}$ precisely parallels the action of $\pi$ on $T^{\{\beta\}}$.

If this is accomplished, then the action of $\pi^*$ fixes $S$ and so fixes $\{\{g\}_\beta:g \in G\}_\alpha$, while at the same
time $(\pi^*_\beta)_\gamma$ agrees with $\pi_\gamma$ on $G$.  This implies that $\pi_\gamma(g) \in G$ (and the same argument applies to $\pi^{-1}$)
so $\pi$ fixes $\{\{g\}_\beta:g \in G\}$.

The support $S+(T^*)^{\{\alpha\}}$ obtained by juxtaposition and deletion of all but the first occurrence of repeated items is a strong support.  Build a permutation $\pi^*$ using the freedom of action theorem whose derivatives
send each element of $S$ to itself and whose derivative $\pi^*_\beta$ sends each atomic item in $T^*$, or exception of a derivative of $\pi$ belonging to a litter in $T^*$, or element of the orbit under $\pi$ of any items of the last two kinds, to their image under the appropriate derivative of $\pi$, and any flexible litter item in $T^*$ to its image under an appropriate derivative of $\pi$.  Non-flexible litter items in $T^*$ are then sent to their images under the appropriate derivative of $\pi$ because their local cardinals are handled correctly because the action on a support is handled correctly, and the other conditions ensure that there can be no exceptions of the new permutation which do not correspond to exceptions of $\pi$.  This permutation has the effects described above, so $\pi$ fixes $\{g\}_\beta$ as desired.

[NOTE:  there needs to be some consideration of action of the $\gamma = -1$ case here:  extending $T^*$ to a strong $\alpha$ support can add some type $\alpha$ elements, but I believe harmlessly to the program indicated .  This does need checking].



% \begin{comment}
{\bf Note for formal verification project:}  This is converging to a full description at the level needed for formalization...

% \end{comment}
\newpage

\section{Conclusions, extended results, and questions}
% \begin{comment}
[I have copied in the conclusions section of an older version, but what it says should be about right, 
and may require some revisions to fit in this paper.  I also added the bibliography, which again is probably approximately the right one.]
% \end{comment}

This is a rather boring resolution of the NF consistency problem.

NF has no locally interesting combinatorial consequences.   Any stratified fact about sets of a bounded standard size which holds in ZFC will continue to hold in models constructed using this strategy with the parameter $\kappa$ chosen large enough.
That the continuum can be well-ordered or that the axiom of dependent choices can hold, for example, can readily be arranged.  Any theorem about familiar objects such as real numbers which holds in ZFC can be relied upon to hold in our models
(even if it requires Choice to prove), and any situation which is possible for familiar objects is possible in models of {\em NF\/}:  for example, the Continuum Hypothesis can be true or false.  It cannot be expected that {\em NF\/} proves any strictly local stratified result about familiar mathematical objects which is not also a theorem of ZFC.

Questions of consistency with NF of global choice-like statements such as ``the universe is linearly ordered"  cannot be resolved by the method used here (at least, not without major changes).  One statement which seems to be about big sets can be seen to hold in our models:  the power set of any well-orderable set is well-orderable, and more generally, beth numbers are alephs.  We indicate the proofs:  a relation which one of our models of TTT thinks is a well-ordering actually is a well-ordering, because the models are countably complete;  so a well-ordering with a certain support has all elements of its domain sets with the same support (a permutation whose action fixes a well-ordering has action fixing all elements of its domain), and all subsets of and relations on the domain are sets with the same support (adjusted for type differential), and this applies further to the well-ordering of the subsets of the domain which we find in the metatheory.  Applying the same result to sets with well-founded extensional relations on them proves the more general result about beth numbers.  This form of choice seems to allow us to use choice freely on any structure one is likely to talk about in the usual set theory.  It also proves, for example, that the power set of the set of ordinals (a big set!) is well-ordered.

NF with strong axioms such as the Axiom of Counting (introduced by Rosser in \cite{rosser}, an admirable textbook based on {\em NF\/}), the Axiom of Cantorian Sets (introduced in \cite{henson})  or my axioms of Small Ordinals and Large Ordinals (introduced in  my \cite{mybook} which pretends to be a set theory textbook based on {\em NFU\/}) can be obtained by choosing $\lambda$ large enough to have strong partition properties, more or less exactly as I report in my paper \cite{strongaxioms} on strong axioms of infinity in NFU:  the results in that paper are not all mine, and I owe a good deal to Solovay in that connection (unpublished conversations and \cite{nfub}).

That NF has $\alpha$-models for each standard ordinal $\alpha$ should follow by the same methods Jensen used for NFU in his original paper \cite{nfu}.   No model of NF can contain all countable subsets of its domain;  all well-typed combinatorial consequences
of closure of a model of TST under taking subsets of size $<\kappa$ will hold in our models, but the application of compactness which gets us from TST + Ambiguity to NF forces the existence of externally countable proper classes, a result which has long been known and which also holds in NFU.

We mention some esoteric problems which our approach solves.  The Theory of Negative Types of Hao Wang (TST with all integers as types, proposed in \cite{tnt})  has $\omega$-models;  an $\omega$-model of NF gives an $\omega$-model of TST immediately.  This question was open.

In ordinary set theory, the Specker tree of a cardinal is the tree in which the top is the given cardinal, the children of the top node  are the preimages of the top under the map $(\kappa \mapsto 2^{\kappa})$, and the part of the tree
below each child is the Specker tree of the child.  Forster proved using a result of Sierpinski that the Specker tree of a cardinal must be well-founded (a result which applies in ordinary set theory or in NF(U), with some finesse in the definition of the exponential map in NF(U)).  Given Choice, there is a finite bound on the lengths of the branches in any given Specker tree.  Of course by the Sierpinski result a Specker tree can be assigned an ordinal rank.  The question which was open
was whether existence of a Specker tree of infinite rank is consistent.  It is known that in NF with the Axiom of Counting the Specker tree of the cardinality of the universe is of infinite rank.  Our results in this paper can be used to show that Specker trees of infinite rank are consistent in bounded Zermelo set theory with atoms or without foundation (this takes a little work, using the way that internal type representations unfold in TTT and a natural interpretation of bounded Zermelo set theory in TST;  a tangled web as described above would have range part of a Specker tree of infinite rank).  A bit more work definitely gets this result in ZFA, and we are confident that our permutation methods can be adapted to ZFC using forcing in standard ways to show that Specker trees of infinite rank can exist in ZF.

We believe that NF is no stronger than TST + Infinity, which is of the same strength as Zermelo set theory with separation restricted to bounded formulas.  Our work here does not show this, as we need enough Replacement for
existence of $\beth_{\omega_1}$ at least.  We leave it as an interesting further task, possibly for others, to tighten things up and show the minimal strength that we expect holds.

Another question of a very general and amorphous nature which remains is:  what do models of NF look like in general?  Are all models of NF in some way like the ones we describe, or are there models of quite a different character?  There are very special assumptions which we made by fiat in building our model of TTT which do  not seem at all inevitable in general models of this theory.

\newpage

I am not sure that all references given here will be used in this version.

\begin{thebibliography}{99}





\bibitem{forster}  Forster, T.E. [1995] 
Set Theory with a Universal Set, exploring an untyped Universe 
Second edition. Oxford Logic Guides, Oxford University Press, Clarendon Press, Oxford.

\bibitem{hailperin} Hailperin, finite axiomatization

\bibitem{henson}   Henson, C.W. [1973a] 
Type-raising operations in NF. 
Journal of Symbolic Logic 38 , pp. 59-68.

\bibitem{tangled}  Holmes, M.R.
``The equivalence of NF-style set theories with "tangled" type theories; the construction of omega-models of predicative NF (and more)". 
{\em Journal of Symbolic Logic\/} 60 (1995), pp. 178-189.

\bibitem{mybook}  Holmes, M. R. [1998] 
Elementary set theory with a universal set. 
volume 10 of the Cahiers du Centre de logique, Academia, Louvain-la-Neuve (Belgium), 241 pages, ISBN 2-87209-488-1. See here for an on-line errata slip. By permission of the publishers, a corrected text is published online; an official second edition will appear online eventually.

\bibitem{strongaxioms}   Holmes, M. R. [2001]
Strong Axioms of infinity in NFU.
Journal of Symbolic Logic, 66, no. 1, pp. 87-116.  \newline(``Errata in `Strong
Axioms of Infinity in NFU' ", JSL, vol. 66, no. 4 (December
2001), p. 1974, reports some errata and provides corrections).

\bibitem{kemeny}  Kemeny thesis on strength of TST

\bibitem{jech}  Jech, Thomas, {\em Set theory}, Academic Press 1978, pp. 199-201.

\bibitem{nfu}  Jensen, R.B.
``On the consistency of a slight(?) modification of Quine's NF". 
{\em Synthese\/} 19 (1969), pp. 250-263.

\bibitem{quinepair}  Quine on ordered pairs

\bibitem{nf}  Quine, W.V.,
``New Foundations for Mathematical Logic". 
{\em American Mathematical Monthly\/} 44 (1937), pp. 70-80. 

\bibitem{rosser}  Rosser, J. B. [1978] 
Logic for mathematicians, second edition. 
Chelsea Publishing.

\bibitem{pm1}  Russell, Principles of Mathematics

\bibitem{pm}  Russell and Whitehead, Principia Mathematica

\bibitem{scottstrick}  Scott, Dana, ``Definitions by abstraction in axiomatic set theory",  {\em Bull. Amer. Math.
Soc.}, vol. 61, p. 442, 1955.

\bibitem{nfub}  Solovay, R, ``The consistency strength of NFUB",  preprint on {\tt arXiv.org}, {\tt arXiv:math/9707207 [math.LO]}

\bibitem{notac}  Specker, E.P.
``The axiom of choice in Quine's new foundations for mathematical logic". 
{\em Proceedings of the National Academy of Sciences of the USA\/} 39 (1953), pp. 972-975.

\bibitem{ambiguity}  Specker, E.P. [1962] 
``Typical ambiguity". 
{\em Logic, methodology and philosophy of science\/}, ed. E. Nagel, Stanford University Press, pp. 116-123.

\bibitem{tarskiontst}  Tarski, first description of TST

\bibitem{tnt}  Wang, H. [1952] 
Negative types.

\bibitem{wiener}  Wiener, Norbert, paper on Wiener pair


\end{thebibliography}












\end{document}